---
title: "BWAS-RESI: All Figures and Tables"
author: "Kaidi Kang"
date: "7/29/2023"
output: 
  html_document:
    toc: true
    number_sections: true
    use_bookdown: yes
    code_folding: hide
    toc_float: 
      collapsed: false
editor_options: 
  chunk_output_type: inline
---


# Summary

```{r, message = FALSE, warning = FALSE}
library(ggseg)
library(dplyr)
library(tidyr)
library(cowplot) # for plot arrangement `plot_grid
library(magrittr)
library(ggplot2)
library(ggpubr) # for ggarrange & annotate_figure()
library(gridExtra) # for grid.arrange
library("ggsci") # for color in ggplot2
library(kableExtra)
library(readr)
library(effectsize)
library(table1)
library(grid)
```


# Functions
## Forest plot
```{r, fig.height=8, fig.width=12}
library(splines)

# study_info_CT = study_info_CT = read_csv("data/analysis_data/whole_brain_measure/new/CT/study_info_clean_global_CT.csv")
# study_info_CT %<>% arrange(Design, m2_age)
# study_info_CT$index_sd_age = 1:nrow(study_info_CT)
# 
# analysis_data_CT <- read_csv("data/analysis_data/whole_brain_measure/new/CT/analysis_data_global_CT_combat.csv")
# analysis_data_CT %<>% as.data.frame 
# analysis_data_CT$study %<>% factor(levels = study_info_CT$study)
# 
# study_info = study_info_CT
# analysis_data = analysis_data_CT
# outcome = "CT"
# x_ul = 2

forest_plot = function(study_info, analysis_data = analysis_data, outcome, x_ul = 3){

  # prepare plotting data
  ES = study_info
  ES$CS_RESI_age = NA
  ES$ll_CS_RESI_age = NA
  ES$ul_CS_RESI_age = NA
  ES$L_RESI_age = NA
  ES$ll_L_RESI_age = NA
  ES$ul_L_RESI_age = NA
  
  ES$CS_RESI_sex = NA
  ES$ll_CS_RESI_sex = NA
  ES$ul_CS_RESI_sex = NA
  ES$L_RESI_sex = NA
  ES$ll_L_RESI_sex = NA
  ES$ul_L_RESI_sex = NA
  
  ES$CS_RESI_se_age = NA
  ES$CS_RESI_se_sex = NA
  
  ES$L_RESI_se_age = NA
  ES$L_RESI_se_sex = NA
  
  ES$d_sex = NA
  ES$ll_d_sex = NA
  ES$ul_d_sex = NA

  for (i in 1:nrow(ES)){
    study_i = ES$study[i] %>% as.character()
    study_name = gsub("-", "_", study_i)
    fit_i = readRDS(paste0("Results/RESI_objects_whole_brain/", outcome, "/", outcome, "_RESI_", study_name, ".rds"))
    if (ES$Design[i] == "Longitudinal") { 
      # AGE effect
      # CS RESI
      ES$CS_RESI_age[i] = fit_i$resi_obj_age["ns(age_years, df = 2)", "CS-RESI"]
      ES$ll_CS_RESI_age[i] = fit_i$resi_obj_age["ns(age_years, df = 2)", "CS 2.5%"]
      ES$ul_CS_RESI_age[i] = fit_i$resi_obj_age["ns(age_years, df = 2)", "CS 97.5%"]
      ES$CS_RESI_se_age[i] = fit_i$resi_obj_age["ns(age_years, df = 2)", "CS-RESI_se"]
      
      # Long RESI
      ES$L_RESI_age[i] = fit_i$resi_obj_age["ns(age_years, df = 2)", "L-RESI"]
      ES$ll_L_RESI_age[i] = fit_i$resi_obj_age["ns(age_years, df = 2)", "L 2.5%"]
      ES$ul_L_RESI_age[i] = fit_i$resi_obj_age["ns(age_years, df = 2)", "L 97.5%"]  
      ES$L_RESI_se_age[i] = fit_i$resi_obj_age["ns(age_years, df = 2)", "L-RESI_se"]

      # sex
      # CS RESI
      ES$CS_RESI_sex[i] = fit_i$resi_obj_sex["sex_01", "CS-RESI"]
      ES$ll_CS_RESI_sex[i] = fit_i$resi_obj_sex["sex_01", "CS 2.5%"]
      ES$ul_CS_RESI_sex[i] = fit_i$resi_obj_sex["sex_01", "CS 97.5%"]
      ES$CS_RESI_se_sex[i] = fit_i$resi_obj_sex["sex_01", "CS-RESI_se"]
      # Long RESI
      ES$L_RESI_sex[i] = fit_i$resi_obj_sex["sex_01", "L-RESI"]
      ES$ll_L_RESI_sex[i] = fit_i$resi_obj_sex["sex_01", "L 2.5%"]
      ES$ul_L_RESI_sex[i] = fit_i$resi_obj_sex["sex_01", "L 97.5%"]
      ES$L_RESI_se_sex[i] = fit_i$resi_obj_sex["sex_01", "L-RESI_se"]
      
      # Cohen's d for sex effect
      d = z_to_d(sqrt(fit_i$resi_obj_sex["sex_01", "X2"]), n = ES$N[i])
      ES$d_sex[i] = d[1, "d"]
      ES$ll_d_sex[i] = d[1, "CI_low"]
      ES$ul_d_sex[i] = d[1, "CI_high"]
      
    } else {
      # Cross-sectional studies
      # Here, longitudinal RESI = CS RESI
      # age
      ES$CS_RESI_age[i] = ES$L_RESI_age[i] = fit_i$anova["ns(age_years, df = 2)", "RESI"]
      ES$ll_CS_RESI_age[i] = ES$ll_L_RESI_age[i] = fit_i$anova["ns(age_years, df = 2)", "2.5%"]
      ES$ul_CS_RESI_age[i] = ES$ul_L_RESI_age[i] = fit_i$anova["ns(age_years, df = 2)", "97.5%"]
      # sex
      ES$CS_RESI_sex[i] = ES$L_RESI_sex[i] = fit_i$anova["sex_01", "RESI"]
      ES$ll_CS_RESI_sex[i] = ES$ll_L_RESI_sex[i] = fit_i$anova["sex_01", "2.5%"]
      ES$ul_CS_RESI_sex[i] = ES$ul_L_RESI_sex[i] = fit_i$anova["sex_01", "97.5%"]
      # se of RESI
      ES$CS_RESI_se_age[i] = ES$L_RESI_se_age[i] = fit_i$anova["ns(age_years, df = 2)", "RESI_se"]
      ES$CS_RESI_se_sex[i] = ES$L_RESI_se_sex[i] = fit_i$anova["sex_01", "RESI_se"]
      
      # Cohen's d for sex effect
      d = F_to_d(fit_i$anova["sex_01", "F"], df = fit_i$anova["sex_01", "Df"], df_error = fit_i$overall$Res.Df[2])
      ES$d_sex[i] = d[1, "d"]
      ES$ll_d_sex[i] = d[1, "CI_low"]
      ES$ul_d_sex[i] = d[1, "CI_high"]
      
      }
  }
  
  # PLOT
  
  # age distribution
  plot_data = subset(analysis_data, study %in% ES$study)
  plot_data = merge(plot_data, ES[, c("study", "Design")])

  age_dist = ggplot(plot_data, aes(x = age_years, y = study, col = Design)) +
                    geom_boxplot(aes(col = Design)) +
                    scale_colour_manual(values = c("#00AFBB", "#E7B800")) +
                    # guides(x =  guide_axis(angle = 90)) +
                    labs(title = "Age distributions", x = "Age (in years)", y = "Study") + theme_classic() +
                    geom_vline(xintercept=c(25, 50, 75, 100), color='grey', linetype='dashed', alpha=.7)
  
  # forest plots
  # 1. for age
  title_text = outcome
  ## 1.1 plotting for Long RESI (in yellow)
  # Check whether the actual limits go beyond the specified range
  # if so, change them to the specified limit
  ES <- ES %>% mutate(corrected_ul = ifelse(ul_L_RESI_age > x_ul, x_ul, NA))
  temp_data = ES
  temp_data$L_RESI_age[temp_data$Design == "Cross-sectional"] = NA 
  temp_data$ll_L_RESI_age[temp_data$Design == "Cross-sectional"] = NA
  temp_data$ul_L_RESI_age[temp_data$Design == "Cross-sectional"] = NA
  ES_plot_age = ggplot(data = temp_data, aes(y = index_sd_age - 0.6, x = L_RESI_age, xmin = ll_L_RESI_age, xmax = ul_L_RESI_age)) +
                geom_point(colour =  "#E7B800") + geom_errorbarh(aes(y =index_sd_age - 0.6), height=.1, colour =  "#E7B800") + xlim(0, x_ul)
  # adding arrows if needed
  if (sum(!is.na(ES$corrected_ul)) > 0){
    ES_plot_age = ES_plot_age + 
                  geom_errorbarh(aes(y = index_sd_age - 0.6, xmin = ll_L_RESI_age, xmax = corrected_ul), height=.1, colour = "#E7B800") + 
                  # arrows
                  geom_segment(data = temp_data, 
                               aes(x = corrected_ul, xend = L_RESI_age, 
                                   y = index_sd_age - 0.6, yend = index_sd_age - 0.6), 
                               color =  "#E7B800",
                               arrow = arrow(length=unit(0.30,"cm"), ends="first"))
                }
  ## 1.2 plotting for CS RESI (in blue)
  ES <- ES %>% mutate(corrected_ul = ifelse(ul_CS_RESI_age > x_ul, x_ul, NA))

  ES_plot_age = ES_plot_age +
                geom_point(data = ES, aes(y = index_sd_age - 0.4, x = CS_RESI_age), colour = "#00AFBB") +
                geom_errorbarh(height=.1, aes(y = index_sd_age - 0.4, xmin = ll_CS_RESI_age, xmax = ul_CS_RESI_age), colour = "#00AFBB")
  
  # adding arrows if needed
  if (sum(!is.na(ES$corrected_ul)) > 0){
    ES_plot_age = ES_plot_age + 
                  # geom_errorbarh(aes(xmin = ll_age_adj, xmax = corrected_ul), height=.1) +
                  # arrows
                  geom_segment(data = ES, 
                               aes(x = corrected_ul, xend = ll_CS_RESI_age, 
                                   y = index_sd_age - 0.4, yend = index_sd_age - 0.4), 
                               colour = "#00AFBB",
                               arrow = arrow(length=unit(0.30,"cm"), ends="first"))
                }
  
  # adding other elements
  ES_plot_age = ES_plot_age +
                scale_y_continuous(breaks = (1:nrow(ES))-0.5, expand = c(0, 0), 
                                   labels = ES$study,
                                   limits = c(0, nrow(ES))) +
                labs(title = title_text, x = 'RESI', y = 'Study') +
                geom_vline(xintercept=0, color='black', linetype='dashed', alpha=.5) +
                theme_classic()

  # 2. for Gender
  ## 2.1 plotting for Long RESI (in yellow)
  # Check whether the actual limits go beyond the specified range
  # if so, change them to the specified limit
  ES <- ES %>% mutate(corrected_ul = ifelse(ul_L_RESI_sex > x_ul, x_ul, NA))
  temp_data = ES
  temp_data$L_RESI_sex[temp_data$Design == "Cross-sectional"] = NA 
  temp_data$ll_L_RESI_sex[temp_data$Design == "Cross-sectional"] = NA
  temp_data$ul_L_RESI_sex[temp_data$Design == "Cross-sectional"] = NA
  ES_plot_sex = ggplot(data = temp_data, aes(y = index_sd_age - 0.6, x = L_RESI_sex, xmin = ll_L_RESI_sex, xmax = ul_L_RESI_sex)) +
                geom_point(colour = "#E7B800") + geom_errorbarh(height=.1, colour = "#E7B800") + xlim(0, x_ul)
  # adding arrows if needed
  if (sum(!is.na(ES$corrected_ul)) > 0){
    ES_plot_sex = ES_plot_sex + 
                  geom_errorbarh(aes(xmin = ll_L_RESI_sex, xmax = corrected_ul), height=.1, colour = "#E7B800") + 
                  # arrows
                  geom_segment(data = temp_data, 
                               aes(x = corrected_ul, xend = L_RESI_sex, 
                                   y = index_sd_age - 0.6, yend = index_sd_age - 0.6), 
                               color = "#E7B800",
                               arrow = arrow(length=unit(0.30,"cm"), ends="first"))
                }
  ## 2.2 plotting for CS RESI (in black)
  ES <- ES %>% mutate(corrected_ul = ifelse(ul_CS_RESI_sex > x_ul, x_ul, NA))

  ES_plot_sex = ES_plot_sex +
                geom_point(data = ES, aes(y = index_sd_age - 0.4, x = CS_RESI_sex), colour = "#00AFBB") +
                geom_errorbarh(height=.1, aes(y = index_sd_age - 0.4, xmin = ll_CS_RESI_sex, xmax = ul_CS_RESI_sex), colour = "#00AFBB")
  
  # adding arrows if needed
  if (sum(!is.na(ES$corrected_ul)) > 0){
    ES_plot_sex = ES_plot_sex + 
                  # arrows
                  geom_segment(data = ES, 
                               aes(x = corrected_ul, xend = ll_CS_RESI_sex, 
                                   y = index_sd_age - 0.4, yend = index_sd_age - 0.4), 
                               arrow = arrow(length=unit(0.30,"cm"), ends="first"), 
                               colour = "#00AFBB")
  }
  
  # adding other elements 
  ES_plot_sex = ES_plot_sex +
                scale_y_continuous(breaks = (1:nrow(ES))-0.5, expand = c(0, 0), 
                                   labels = ES$study,
                                   limits = c(0, nrow(ES))) +
                labs(title = title_text, x = 'RESI', y = 'Study') +
                geom_vline(xintercept=0, color='black', linetype='dashed', alpha=.5) +
                theme_classic()
  
  ## 2.3 Plotting Cohen's d
  # Cohen's d for sex
  # Check whether the actual limits go beyond the specified range
  # if so, change them to the specified limit
  ES <- ES %>% mutate(corrected_ul = ifelse(ul_d_sex > x_ul, x_ul, NA))
  plot_d_sex = ggplot(data = ES, aes(y = index_sd_age - 0.5, x = d_sex, xmin = ll_d_sex, xmax = ul_d_sex)) +
                geom_point() + geom_errorbarh(height=.1) + xlim(-0.5, x_ul)
  # adding arrows if needed
  if (sum(!is.na(ES$corrected_ul)) > 0){
    plot_d_sex = plot_d_sex + 
                  geom_errorbarh(aes(xmin = ll_d_sex, xmax = corrected_ul), height=.1) + 
                  # arrows
                  geom_segment(data = ES, 
                               aes(x = corrected_ul, xend = ll_d_sex, 
                                   y = index_sd_age - 0.5, yend = index_sd_age - 0.5), 
                               arrow = arrow(length=unit(0.30,"cm"), ends="first"))
  }
  
  plot_d_sex  = plot_d_sex + 
                scale_y_continuous(breaks = (1:nrow(ES))-0.5, expand = c(0, 0), 
                                   labels = ES$study,
                                   limits = c(0, nrow(ES))) +
                labs(title = title_text, x = "Cohen's d", y = 'Study') +
                geom_vline(xintercept=0, color='black', linetype='dashed', alpha=.5) +
                theme_classic()


  return(list(ES = ES,
              age_dist = age_dist,
              plot_age = ES_plot_age,
              plot_sex = ES_plot_sex,
              plot_d_sex = plot_d_sex)
        )
}
```


## Meta-analysis
```{r}
# ES = ES_GMV$ES
# variable = "age"
# wls = TRUE

meta_resi = function(ES, variable = "age", wls = TRUE){
  
  # CS RESI for longitudinal studies or RESI for CS studies
  # weights
  if (wls) {
    if (variable == "age") {
      ES$w = 1/ES$CS_RESI_se_age
    } else {
      ES$w = 1/ES$CS_RESI_se_sex
      }
  } else { ES$w = 1}
  
  if (variable == "age") {
    ES_fit_csRESI = lm(CS_RESI_age ~ Design + splines::ns(mean_age, 3) + splines::ns(m2_age, 3) + splines::ns(m3_age, 3), data = ES, weights = w)
    df.res = ES_fit_csRESI$df.residual
  } 
  if (variable == "sex") {
    ES_fit_csRESI = lm(CS_RESI_sex ~ Design + splines::ns(mean_age, 3) + splines::ns(m2_age, 3) + splines::ns(mean_sex, 3), data = ES, weights = w)
    df.res = ES_fit_csRESI$df.residual
  }
  
  # using robust (sandiwich) vcov estimator
  # ES_tab_pmRESI = lmtest::coeftest(ES_fit_pmRESI, vcov. = sandwich::vcovHC)[,] %>% as.data.frame
  ES_tab_csRESI = RESI::resi(ES_fit_csRESI, data = ES, overall = FALSE)

  # (Longitudinal/Regular) RESI for all studies
  # weights
  if (wls) {
    if (variable == "age") {
      ES$w = 1/ES$L_RESI_se_age
    } else {
      ES$w = 1/ES$L_RESI_se_sex
      }
  } else { ES$w = 1}

  if (variable == "age") {
    ES_fit_lRESI = lm(L_RESI_age ~ Design + splines::ns(mean_age, 3) + splines::ns(m2_age, 3) + splines::ns(m3_age, 3), data = ES, weights = w)
  } 
  if (variable == "sex") {
    ES_fit_lRESI = lm(L_RESI_sex ~ Design + splines::ns(mean_age, 3) + splines::ns(m2_age, 3) + splines::ns(mean_sex, 3) , data = ES, weights = w)
  }
  # using robust (sandiwich) vcov estimator
  ES_tab_lRESI = RESI::resi(ES_fit_lRESI, data = ES, overall = FALSE)
  
  cat("Variable:", ifelse(variable == "age", "age", "sex"), "\n")
  cat("\nFor regular RESI: \n")
  cat("Model: ", deparse(formula(ES_fit_lRESI$terms)), "\n")
  
  # adding the estimate for design to the anova table
  tab_L_RESI = ES_tab_lRESI$anova %>% round(2)
  tab_L_RESI$Estimate = NULL
  tab_L_RESI$Estimate[rownames(tab_L_RESI) == "Design"] = ES_tab_lRESI$coefficients["DesignLongitudinal", "Estimate"] %>% round(2)
  tab_L_RESI$S.E. = NULL
  tab_L_RESI$S.E.[rownames(tab_L_RESI) == "Design"] = ES_tab_lRESI$coefficients["DesignLongitudinal", "Std. Error"] %>% round(2)
  # format the 95% CI for meta-RESI
  tab_L_RESI$`95% CI` = with(tab_L_RESI, paste0("(", `2.5%`, ", ", `97.5%`, ")"))
  tab_L_RESI %<>% select("Estimate", "S.E.", "F", "Df", "Pr(>F)", "RESI", "95% CI")
  tab_L_RESI %>% kbl(caption = "Meta-analysis result for RESI or L-RESI") %>% kable_classic(full_width = FALSE, html_font = "Cambria") %>% add_footnote(paste0("Residual D.F = ", df.res)) %>% print

  cat("For CS-RESI: \n")
  cat("Model: ", format(formula(ES_fit_csRESI$terms)), "\n")
  
  # adding the estimate for design to the anova table
  tab_CS_RESI = ES_tab_csRESI$anova %>% round(2)
  tab_CS_RESI$Estimate = NULL
  tab_CS_RESI$Estimate[rownames(tab_CS_RESI) == "Design"] = ES_tab_csRESI$coefficients["DesignLongitudinal", "Estimate"] %>% round(2)
  tab_CS_RESI$S.E. = NULL
  tab_CS_RESI$S.E.[rownames(tab_CS_RESI) == "Design"] = ES_tab_csRESI$coefficients["DesignLongitudinal", "Std. Error"] %>% round(2)
  # format the 95% CI for meta-RESI
  tab_CS_RESI$`95% CI` = with(tab_CS_RESI, paste0("(", `2.5%`, ", ", `97.5%`, ")"))
  tab_CS_RESI %<>% select("Estimate", "S.E.", "F", "Df", "Pr(>F)", "RESI", "95% CI")
  tab_CS_RESI %>% kbl(caption = "Meta-analysis result for RESI or CS-RESI") %>% kable_classic(full_width = FALSE, html_font = "Cambria") %>% add_footnote(paste0("Residual D.F = ", df.res)) %>% print
}

```


# Fig. 1. Meta-analyses results for whole and regional brain measures. 
Partial regression plots & visualization of ESs of age on ROI measures using brain images

```{r}
# ----- GMV, sGMV, WMV ----------
study_info = readr::read_csv("data/analysis_data/whole_brain_measure/new/study_info_whole_brain.csv")
# Order the study by study design & SD of age
study_info %<>% arrange(Design, m2_age)
study_info$index_sd_age = 1:nrow(study_info)

analysis_data <- read_csv("data/analysis_data/whole_brain_measure/new/analysis_data_whole_brain_combat.csv") 
analysis_data %<>% as.data.frame 
analysis_data$study %<>% factor(levels = study_info$study)

# GMV
ES_GMV = forest_plot(study_info = study_info, analysis_data = analysis_data, outcome = "GMV", x_ul = 2)
# sGMV
ES_sGMV = forest_plot(study_info = study_info, analysis_data = analysis_data, outcome = "sGMV", x_ul = 2)
# WMV
ES_WMV = forest_plot(study_info = study_info, analysis_data = analysis_data, outcome = "WMV", x_ul = 2)

# ------- CT -------------
# study info: 43 datasets for global CT
study_info_CT = study_info_CT = read_csv("data/analysis_data/whole_brain_measure/new/CT/study_info_clean_global_CT.csv")
study_info_CT %<>% arrange(Design, m2_age)
study_info_CT$index_sd_age = 1:nrow(study_info_CT)

analysis_data_CT <- read_csv("data/analysis_data/whole_brain_measure/new/CT/analysis_data_global_CT_combat.csv")
analysis_data_CT %<>% as.data.frame 
analysis_data_CT$study %<>% factor(levels = study_info_CT$study)

ES_CT = forest_plot(study_info = study_info_CT, analysis_data = analysis_data_CT, outcome = "CT", x_ul = 2)

# ---- GMV ------
# added variable plots
# with Longitudinal RESI
plot_data = ES_GMV$ES
plot_data$w = 1/plot_data$L_RESI_se_age
fit = lm(L_RESI_age ~ Design + ns(mean_age, 3) + ns(m2_age, 3) + ns(m3_age, 3),
         data = plot_data, weights = w)
# residuals
plot_data$res = residuals(fit)


# OVER mean age
## the expected value of RESI over mean age when sd and skewness are at sample mean
## for the points
new_data = plot_data
new_data$Design = "Cross-sectional"
new_data$m2_age = 7
new_data$m3_age = 0
plot_data$pred_L_RESI_age = predict(fit, newdata = new_data)
## for the lines
data_line = data.frame(mean_age = seq(0, 80, by = 0.1), m2_age = 7, m3_age = 0, Design = "Cross-sectional")
pred = predict(fit, newdata = data_line, interval = "confidence")
data_line = cbind(data_line, pred)
p1 = ggplot() + 
  geom_point(data = plot_data, aes(y = pred_L_RESI_age + res, x =  mean_age)) + 
  geom_ribbon(data = data_line, aes(ymin = lwr, ymax = upr, x = mean_age), fill = "grey", alpha = 0.6) +
  geom_line(data = data_line, aes(y = fit, x = mean_age), col = "dodgerblue2", size = 1) + 
  ylim(-0.5, 1.9) +
  theme_classic() + 
  theme(axis.text.x = element_text(color="black"), axis.ticks = element_line(color = "black")) + 
  labs(title = " ", y = 'RESI | other', x = 'Mean age | Other')

# vs sd(age)
new_data = plot_data
new_data$Design = "Cross-sectional"
new_data$mean_age = 45
new_data$m3_age = 0
plot_data$pred_L_RESI_age = predict(fit, newdata = new_data)
## for the lines
data_line = data.frame(mean_age = 45, m2_age = seq(0, 20, by = 0.1), m3_age = 0, Design = "Cross-sectional")
pred = predict(fit, newdata = data_line, interval = "confidence")
data_line = cbind(data_line, pred)
p2 = ggplot() + geom_point(data = plot_data, aes(y = pred_L_RESI_age + res, x =  m2_age)) + 
    geom_ribbon(data = data_line, aes(ymin = lwr, ymax = upr, x = m2_age), fill = "grey", alpha = 0.6) +
    geom_line(data = data_line, aes(y = fit, x = m2_age), col = "dodgerblue2", size = 1) + 
    ylim(-1.2, 1.5) +
    theme_classic() + 
    theme(axis.text.x = element_text(color="black"), axis.ticks = element_line(color = "black")) + 
    labs(title = "", y = 'RESI | Other', x = 'SD of age | Other')


# P3: estimated RESI vs scaled 3rd moment of age
new_data = plot_data
new_data$Design = "Cross-sectional"
new_data$mean_age = 45
new_data$m2_age = 7
plot_data$pred_L_RESI_age = predict(fit, newdata = new_data)
## for the lines
data_line = data.frame(mean_age = 45, m2_age = 7, m3_age = seq(-15, 15, by = 0.1), Design = "Cross-sectional")
pred = predict(fit, newdata = data_line, interval = "confidence")
data_line = cbind(data_line, pred)
p3 = ggplot() + geom_point(data = plot_data, aes(y = pred_L_RESI_age + res, x =  m3_age)) +
      geom_ribbon(data = data_line, aes(ymin = lwr, ymax = upr, x = m3_age), fill = "grey", alpha = 0.5) +
      geom_line(data = data_line, aes(y = fit, x = m3_age), col = "dodgerblue2", size = 1) + 
      ylim(-1, 1.5) +
      theme_classic() + 
      theme(axis.text.x = element_text(color="black"), axis.ticks = element_line(color = "black")) +  
      labs(title = "", y = 'RESI | other', x = 'Skewness of age | Other')


# p4: estimated RESI vs design
new_data = plot_data
new_data$mean_age = 45
new_data$m2_age = 7
new_data$m3_age = 0
plot_data$pred_L_RESI_age = predict(fit, newdata = new_data)
## for the lines
data_line = data.frame(mean_age = 45, m2_age = 7, m3_age = 0, Design = c("Cross-sectional", "Longitudinal"))
pred = predict(fit, newdata = data_line, interval = "confidence")
data_line = cbind(data_line, pred)
p4 = ggplot(data = plot_data, aes(y = pred_L_RESI_age + res, x =  Design)) + 
      geom_boxplot( fill='#A4A4A4', color="black") + 
      ylim(-0.5, 1.9) +
      theme_classic() + 
      theme(axis.text.x = element_text(color="black"), axis.ticks = element_line(color = "black")) +  
      labs(title = "", y = 'RESI | other', x = 'Design | Other')

P1 = plot_grid(p1, p2, p3, p4, nrow = 1)


# ---- sGMV ------
# added variable plots
# with modified RESI
plot_data = ES_sGMV$ES
plot_data$w = 1/plot_data$L_RESI_se_age
fit = lm(L_RESI_age ~ Design + ns(mean_age, 3) + ns(m2_age, 3) + ns(m3_age, 3),
         data = plot_data, weights = w)
# residuals
plot_data$res = residuals(fit)
# the mean of sd(age) and skewness(age)
# mean_mean_age = plot_data$mean_age %>% weighted.mean(w = plot_data$N) # = 45
# mean_sd_age = plot_data$m2_age %>% weighted.mean(w = plot_data$N) # = 7
# mean_skew_age = plot_data$m3_age %>% weighted.mean(w = plot_data$N) # = 0

# vs mean age
## the expected value of RESI over mean age when sd and skewness are at sample mean
## for the points
new_data = plot_data
new_data$Design = "Cross-sectional"
new_data$m2_age = 7
new_data$m3_age = 0
plot_data$pred_L_RESI_age = predict(fit, newdata = new_data)
## for the lines
data_line = data.frame(mean_age = seq(0, 80, by = 0.1), m2_age = 7, m3_age = 0, Design = "Cross-sectional")
pred = predict(fit, newdata = data_line, interval = "confidence")
data_line = cbind(data_line, pred)
p1 = ggplot() + 
  geom_point(data = plot_data, aes(y = pred_L_RESI_age + res, x =  mean_age)) + 
  geom_ribbon(data = data_line, aes(ymin = lwr, ymax = upr, x = mean_age), fill = "grey", alpha = 0.6) +
  geom_line(data = data_line, aes(y = fit, x = mean_age), col = "dodgerblue2", size = 1) + 
  ylim(-0.5, 1.9) +
  theme_classic() + 
  theme(axis.text.x = element_text(color="black"), axis.ticks = element_line(color = "black")) +  
  labs(title = " ", y = 'RESI | other', x = 'Mean age | Other')

# vs sd(age)
new_data = plot_data
new_data$Design = "Cross-sectional"
new_data$mean_age = 45
new_data$m3_age = 0
plot_data$pred_L_RESI_age = predict(fit, newdata = new_data)
## for the lines
data_line = data.frame(mean_age = 45, m2_age = seq(0, 20, by = 0.1), m3_age = 0, Design = "Cross-sectional")
pred = predict(fit, newdata = data_line, interval = "confidence")
data_line = cbind(data_line, pred)
p2 = ggplot() + geom_point(data = plot_data, aes(y = pred_L_RESI_age + res, x =  m2_age)) + 
    geom_ribbon(data = data_line, aes(ymin = lwr, ymax = upr, x = m2_age), fill = "grey", alpha = 0.6) +
    geom_line(data = data_line, aes(y = fit, x = m2_age), col = "dodgerblue2", size = 1) + 
    ylim(-1.2, 1.5) +
    theme_classic() + 
    theme(axis.text.x = element_text(color="black"), axis.ticks = element_line(color = "black")) +
    labs(title = "", y = 'RESI | Other', x = 'SD of age | Other')


# P3: estimated RESI vs skewness of age
new_data = plot_data
new_data$Design = "Cross-sectional"
new_data$mean_age = 45
new_data$m2_age = 7
plot_data$pred_L_RESI_age = predict(fit, newdata = new_data)
## for the lines
data_line = data.frame(mean_age = 45, m2_age = 7, m3_age = seq(-15, 15, by = 0.1), Design = "Cross-sectional")
pred = predict(fit, newdata = data_line, interval = "confidence")
data_line = cbind(data_line, pred)
p3 = ggplot() + geom_point(data = plot_data, aes(y = pred_L_RESI_age + res, x =  m3_age)) +
      geom_ribbon(data = data_line, aes(ymin = lwr, ymax = upr, x = m3_age), fill = "grey", alpha = 0.5) +
      geom_line(data = data_line, aes(y = fit, x = m3_age), col = "dodgerblue2", size = 1) + 
      ylim(-1, 1.5) +
      theme_classic() + 
      theme(axis.text.x = element_text(color="black"), axis.ticks = element_line(color = "black")) +  
      labs(title = "", y = 'RESI | other', x = 'Skewness of age | Other')

# p4: estimated RESI vs design
new_data = plot_data
new_data$mean_age = 45
new_data$m2_age = 7
new_data$m3_age = 0
plot_data$pred_L_RESI_age = predict(fit, newdata = new_data)
## for the lines
data_line = data.frame(mean_age = 45, m2_age = 7, m3_age = 0, Design = c("Cross-sectional", "Longitudinal"))
pred = predict(fit, newdata = data_line, interval = "confidence")
data_line = cbind(data_line, pred)
p4 = ggplot(data = plot_data, aes(y = pred_L_RESI_age + res, x =  Design)) + 
      geom_boxplot( fill='#A4A4A4', color="black") + 
      ylim(-0.5, 1.9) +
      theme_classic() + 
      theme(axis.text.x = element_text(color="black"), axis.ticks = element_line(color = "black")) +  
      labs(title = "", y = 'RESI | other', x = 'Design | Other')



P2 = plot_grid(p1, p2, p3, p4, nrow = 1)




# ---- WMV ------
# added variable plots
# with modified RESI
plot_data = ES_WMV$ES
plot_data$w = 1/plot_data$L_RESI_se_age
fit = lm(L_RESI_age ~ Design + ns(mean_age, 3) + ns(m2_age, 3) + ns(m3_age, 3),
         data = plot_data, weights = w)
# residuals
plot_data$res = residuals(fit)
# the mean of sd(age) and skewness(age)
# mean_mean_age = plot_data$mean_age %>% weighted.mean(w = plot_data$N) # = 45
# mean_sd_age = plot_data$m2_age %>% weighted.mean(w = plot_data$N) # = 7
# mean_skew_age = plot_data$m3_age %>% weighted.mean(w = plot_data$N) # = 0

# vs mean age
## the expected value of RESI over mean age when sd and skewness are at sample mean
## for the points
new_data = plot_data
new_data$Design = "Cross-sectional"
new_data$m2_age = 7
new_data$m3_age = 0
plot_data$pred_L_RESI_age = predict(fit, newdata = new_data)
## for the lines
data_line = data.frame(mean_age = seq(0, 80, by = 0.1), m2_age = 7, m3_age = 0, Design = "Cross-sectional")
pred = predict(fit, newdata = data_line, interval = "confidence")
data_line = cbind(data_line, pred)
p1 = ggplot() + 
  geom_point(data = plot_data, aes(y = pred_L_RESI_age + res, x =  mean_age)) + 
  geom_ribbon(data = data_line, aes(ymin = lwr, ymax = upr, x = mean_age), fill = "grey", alpha = 0.6) +
  geom_line(data = data_line, aes(y = fit, x = mean_age), col = "dodgerblue2", size = 1) + 
  ylim(-0.5, 1.9) +
  theme_classic() + 
  theme(axis.text.x = element_text(color="black"), axis.ticks = element_line(color = "black")) +  
  labs(title = " ", y = 'RESI | other', x = 'Mean age | Other')

# vs sd(age)
new_data = plot_data
new_data$Design = "Cross-sectional"
new_data$mean_age = 45
new_data$m3_age = 0
plot_data$pred_L_RESI_age = predict(fit, newdata = new_data)
## for the lines
data_line = data.frame(mean_age = 45, m2_age = seq(0, 20, by = 0.1), m3_age = 0, Design = "Cross-sectional")
pred = predict(fit, newdata = data_line, interval = "confidence")
data_line = cbind(data_line, pred)
p2 = ggplot() + geom_point(data = plot_data, aes(y = pred_L_RESI_age + res, x =  m2_age)) + 
    geom_ribbon(data = data_line, aes(ymin = lwr, ymax = upr, x = m2_age), fill = "grey", alpha = 0.6) +
    geom_line(data = data_line, aes(y = fit, x = m2_age), col = "dodgerblue2", size = 1) + 
    ylim(-1.2, 1.5) +
    theme_classic() + 
    theme(axis.text.x = element_text(color="black"), axis.ticks = element_line(color = "black")) +  
    labs(title = "", y = 'RESI | Other', x = 'SD of age | Other')


# P3: estimated RESI vs skewness of age
new_data = plot_data
new_data$Design = "Cross-sectional"
new_data$mean_age = 45
new_data$m2_age = 7
plot_data$pred_L_RESI_age = predict(fit, newdata = new_data)
## for the lines
data_line = data.frame(mean_age = 45, m2_age = 7, m3_age = seq(-15, 15, by = 0.1), Design = "Cross-sectional")
pred = predict(fit, newdata = data_line, interval = "confidence")
data_line = cbind(data_line, pred)
p3 = ggplot() + geom_point(data = plot_data, aes(y = pred_L_RESI_age + res, x =  m3_age)) +
      geom_ribbon(data = data_line, aes(ymin = lwr, ymax = upr, x = m3_age), fill = "grey", alpha = 0.5) +
      geom_line(data = data_line, aes(y = fit, x = m3_age), col = "dodgerblue2", size = 1) + 
      ylim(-1, 1.5) +
      theme_classic() + 
      theme(axis.text.x = element_text(color="black"), axis.ticks = element_line(color = "black")) +  
      labs(title = "", y = 'RESI | other', x = 'Skewness of age | Other')

# p4: estimated RESI vs design
new_data = plot_data
new_data$mean_age = 45
new_data$m2_age = 7
new_data$m3_age = 0
plot_data$pred_L_RESI_age = predict(fit, newdata = new_data)
## for the lines
data_line = data.frame(mean_age = 45, m2_age = 7, m3_age = 0, Design = c("Cross-sectional", "Longitudinal"))
pred = predict(fit, newdata = data_line, interval = "confidence")
data_line = cbind(data_line, pred)
p4 = ggplot(data = plot_data, aes(y = pred_L_RESI_age + res, x =  Design)) + 
      geom_boxplot( fill='#A4A4A4', color="black") + 
      ylim(-0.5, 1.9) +
      theme_classic() + 
      theme(axis.text.x = element_text(color="black"), axis.ticks = element_line(color = "black")) +  
      labs(title = "", y = 'RESI | other', x = 'Design | Other')

P3 = plot_grid(p1, p2, p3, p4, nrow = 1) 

# ---- CT ------
# added variable plots
# with Longitudinal RESI
plot_data = ES_CT$ES
plot_data$w = 1/plot_data$L_RESI_se_age
fit = lm(L_RESI_age ~ Design + ns(mean_age, 3) + ns(m2_age, 3) + ns(m3_age, 3),
         data = plot_data, weights = w)
# residuals
plot_data$res = residuals(fit)
# the mean of sd(age) and skewness(age)

# vs mean age
## the expected value of RESI over mean age when sd and skewness are at sample mean
## for the points
new_data = plot_data
new_data$Design = "Cross-sectional"
new_data$m2_age = 7
new_data$m3_age = 0
plot_data$pred_L_RESI_age = predict(fit, newdata = new_data)
## for the lines
data_line = data.frame(mean_age = seq(0, 80, by = 0.1), m2_age = 7, m3_age = 0, Design = "Cross-sectional")
pred = predict(fit, newdata = data_line, interval = "confidence")
data_line = cbind(data_line, pred)
p1 = ggplot() + 
  geom_point(data = plot_data, aes(y = pred_L_RESI_age + res, x =  mean_age)) + 
  geom_ribbon(data = data_line, aes(ymin = lwr, ymax = upr, x = mean_age), fill = "grey", alpha = 0.6) +
  geom_line(data = data_line, aes(y = fit, x = mean_age), col = "dodgerblue2", size = 1) + 
  ylim(-0.5, 1.9) +
  theme_classic() + 
  theme(axis.text.x = element_text(color="black"), axis.ticks = element_line(color = "black")) +  
  labs(title = " ", y = 'RESI | other', x = 'Mean age | Other')

# vs sd(age)
new_data = plot_data
new_data$Design = "Cross-sectional"
new_data$mean_age = 45
new_data$m3_age = 0
plot_data$pred_L_RESI_age = predict(fit, newdata = new_data)
## for the lines
data_line = data.frame(mean_age = 45, m2_age = seq(0, 20, by = 0.1), m3_age = 0, Design = "Cross-sectional")
pred = predict(fit, newdata = data_line, interval = "confidence")
data_line = cbind(data_line, pred)
p2 = ggplot() + geom_point(data = plot_data, aes(y = pred_L_RESI_age + res, x =  m2_age)) + 
    geom_ribbon(data = data_line, aes(ymin = lwr, ymax = upr, x = m2_age), fill = "grey", alpha = 0.6) +
    geom_line(data = data_line, aes(y = fit, x = m2_age), col = "dodgerblue2", size = 1) + 
    ylim(-1.2, 1.5) +
    theme_classic() + 
    theme(axis.text.x = element_text(color="black"), axis.ticks = element_line(color = "black")) +  
    labs(title = "", y = 'RESI | Other', x = 'SD of age | Other')


# P3: estimated RESI vs skewness of age
new_data = plot_data
new_data$Design = "Cross-sectional"
new_data$mean_age = 45
new_data$m2_age = 7
plot_data$pred_L_RESI_age = predict(fit, newdata = new_data)
## for the lines
data_line = data.frame(mean_age = 45, m2_age = 7, m3_age = seq(-15, 15, by = 0.1), Design = "Cross-sectional")
pred = predict(fit, newdata = data_line, interval = "confidence")
data_line = cbind(data_line, pred)
p3 = ggplot() + geom_point(data = plot_data, aes(y = pred_L_RESI_age + res, x =  m3_age)) +
      geom_ribbon(data = data_line, aes(ymin = lwr, ymax = upr, x = m3_age), fill = "grey", alpha = 0.5) +
      geom_line(data = data_line, aes(y = fit, x = m3_age), col = "dodgerblue2", size = 1) + 
      ylim(-1, 1.5) +
      theme_classic() + 
      theme(axis.text.x = element_text(color="black"), axis.ticks = element_line(color = "black")) +  
      labs(title = "", y = 'RESI | other', x = 'Skewness of age | Other')

# p4: estimated RESI vs design
new_data = plot_data
new_data$mean_age = 45
new_data$m2_age = 7
new_data$m3_age = 0
plot_data$pred_L_RESI_age = predict(fit, newdata = new_data)
## for the lines
data_line = data.frame(mean_age = 45, m2_age = 7, m3_age = 0, Design = c("Cross-sectional", "Longitudinal"))
pred = predict(fit, newdata = data_line, interval = "confidence")
data_line = cbind(data_line, pred)
p4 = ggplot(data = plot_data, aes(y = pred_L_RESI_age + res, x =  Design)) + 
      geom_boxplot( fill='#A4A4A4', color="black") + 
      ylim(-0.5, 1.9) +
      theme_classic() + 
      theme(axis.text.x = element_text(color="black"), axis.ticks = element_line(color = "black")) +  
      labs(title = "", y = 'RESI | other', x = 'Design | Other')

P4 = plot_grid(p1, p2, p3, p4, nrow = 1)

# partial regression plots
P_par = plot_grid(NULL, P1, P2, P3, P4, NULL, labels = c("", "a  Total GMV", "b  Total sGMV", "c  Total WMV", "d  Mean CT", ""), 
                  rel_heights = c(0.1, 1, 1, 1, 1, 0.1),
                  vjust = 1, hjust = 0, ncol = 1)



# ROI images
dat <- readr::read_csv("Results/meta_analysis_results_ROI/meta_analysis_results_ROI.csv")
dat$label = lapply(dat$ROI %>% strsplit(split = "_"), FUN = function(x) {paste0(x[1], "_", x[3])}) %>% unlist
dat = dat[order(dat$label), ]


# Part 1: Volume 

dat_vol = subset(dat, measure_type == "Vol")
dat_vol = dat_vol[order(dat_vol$label), ]

# FDR adjusted p-values
dat_vol$fdr_p_val_mean_age_L_RESI = p.adjust(dat_vol$p_val_mean_age_L_RESI, method = "BH" ) 
dat_vol$fdr_p_val_m2_age_L_RESI = p.adjust(dat_vol$p_val_m2_age_L_RESI, method = "BH" )
dat_vol$fdr_p_val_m3_age_L_RESI = p.adjust(dat_vol$p_val_m3_age_L_RESI, method = "BH" )
dat_vol$fdr_p_val_design_L_RESI = p.adjust(dat_vol$p_val_design_L_RESI, method = "BH" )

# replace the non-significant p-values (after FDR) with NA
dat_vol[, c("fdr_p_val_mean_age_L_RESI", "fdr_p_val_m2_age_L_RESI", "fdr_p_val_m3_age_L_RESI", "fdr_p_val_design_L_RESI")] = lapply(dat_vol[, c("fdr_p_val_mean_age_L_RESI", "fdr_p_val_m2_age_L_RESI", "fdr_p_val_m3_age_L_RESI", "fdr_p_val_design_L_RESI")], FUN = function(x) ifelse(x <= 0.05, x, NA)) %>% do.call(cbind, .)

limit_val = c(-log10(0.05), max( -log10(dat_vol[, c("fdr_p_val_mean_age_L_RESI", "fdr_p_val_m2_age_L_RESI", "fdr_p_val_m3_age_L_RESI", "fdr_p_val_design_L_RESI")]), na.rm = TRUE  ) )

# Legend:
t = ggseg(dat_vol, atlas = dk, 
      colour = "black",
      size = .1, 
      position = "dispersed",
      mapping = aes(fill = -log10(fdr_p_val_mean_age_L_RESI ) )) + 
  scale_fill_viridis_c(name = "-log10(FDR-adjusted p-value)", option = "viridis", direction = 1, limits = limit_val, values = c(0, 1.5, 1.7, 2, 2.5, 2.6, 3.5, 8)/8) +
  theme(legend.position = "bottom", axis.title.x=element_blank(), axis.text = element_text(family = "sans"), text = element_text(family = "sans")) + 
  labs(title = "Mean age | Other") 
L = get_legend(t)

# Mean age
p1 <- ggseg(dat_vol, atlas = dk, 
      colour = "black",
      size = .1, 
      position = "dispersed",
      mapping = aes(fill = -log10(fdr_p_val_mean_age_L_RESI ) )) + 
  scale_fill_viridis_c(name = "-log10(p-value)", option = "viridis", direction = 1, limits = limit_val, values = c(0, 1.5, 1.7, 2, 2.5, 2.6, 3.5, 8)/8) +
  theme(legend.position = "none", axis.title.x=element_blank(), axis.text = element_text(family = "sans"), text = element_text(family = "sans")) +
  labs(title = "Mean age | Other") 


# SD of age
p2 <- ggseg(dat_vol, atlas = dk, 
      colour = "black",
      size = .1, 
      position = "dispersed",
      mapping = aes(fill = -log10(fdr_p_val_m2_age_L_RESI  ) )) + 
  scale_fill_viridis_c(name = "-log10(p-value)", option = "viridis", direction = 1, limits = limit_val, values = c(0, 1.5, 1.7, 2, 2.5, 2.6, 3.5, 8)/8) +
  theme(legend.position = "none", axis.title.x=element_blank(), axis.text = element_text(family = "sans"), text = element_text(family = "sans")) +
  labs(title = "SD of age | Other")



# Skewness of age
p3 <- ggseg(dat_vol, atlas = dk, 
      colour = "black",
      size = .1, 
      position = "dispersed",
      mapping = aes(fill = -log10(fdr_p_val_m3_age_L_RESI )  )) +  
  scale_fill_viridis_c(name = "-log10(p-value)", option = "viridis", direction = 1, limits = limit_val, values = c(0, 1.5, 1.7, 2, 2.5, 2.6, 3.5, 8)/8) +
  theme(legend.position = "none", axis.title.x=element_blank() , axis.text = element_text(family = "sans"), text = element_text(family = "sans")) +
  labs(title = "Skewness of age | Other")

# design
p4 <- ggseg(dat_vol, atlas = dk, 
      colour = "black",
      size = .1, 
      position = "dispersed",
      mapping = aes(fill = -log10(fdr_p_val_design_L_RESI ) )) + 
  scale_fill_viridis_c(name = "-log10(p-value)", option = "viridis", direction = 1, limits = limit_val, values = c(0, 1.5, 1.7, 2, 2.5, 2.6, 3.5, 8)/8) +
  theme(legend.position = "none", axis.title.x=element_blank(), axis.text = element_text(family = "sans"), text = element_text(family = "sans")) +
  labs(title = "Design | Other")
# p4 %<>% annotate_figure(top = "Design | Other")

p_vol = plot_grid(NULL, p1, p2, p3, p4, ncol = 1, rel_heights = c(0.2, 1, 1, 1, 1, 0.2))  



# Part 2: CT

dat_CT = subset(dat, measure_type == "CT")
dat_CT = dat_CT[order(dat_CT$label), ]

# FDR adjusted p-values
dat_CT$fdr_p_val_mean_age_L_RESI = p.adjust(dat_CT$p_val_mean_age_L_RESI, method = "BH" )
dat_CT$fdr_p_val_m2_age_L_RESI = p.adjust(dat_CT$p_val_m2_age_L_RESI, method = "BH" )
dat_CT$fdr_p_val_m3_age_L_RESI = p.adjust(dat_CT$p_val_m3_age_L_RESI, method = "BH" )
dat_CT$fdr_p_val_design_L_RESI = p.adjust(dat_CT$p_val_design_L_RESI, method = "BH" )

# replace the non-significant p-values (after FDR) with NA
dat_CT[, c("fdr_p_val_mean_age_L_RESI", "fdr_p_val_m2_age_L_RESI", "fdr_p_val_m3_age_L_RESI", "fdr_p_val_design_L_RESI")] = lapply(dat_CT[, c("fdr_p_val_mean_age_L_RESI", "fdr_p_val_m2_age_L_RESI", "fdr_p_val_m3_age_L_RESI", "fdr_p_val_design_L_RESI")], FUN = function(x) ifelse(x<=0.05, x, NA)) %>% do.call(cbind, .)


# Mean age
p1 <- ggseg(dat_CT, atlas = dk, 
      colour = "black",
      size = .1, 
      position = "dispersed",
      mapping = aes(fill = -log10(fdr_p_val_mean_age_L_RESI ) )) +
  scale_fill_viridis_c(name = "-log10(p-value)", option = "viridis", direction = 1, limits = limit_val, values = c(0, 1.5, 1.7, 2, 2.5, 2.6, 3.5, 8)/8) +
  theme(legend.position = "none", axis.title.x=element_blank(), axis.text = element_text(family = "sans"), text = element_text(family = "sans")) +
  labs(title = "Mean age | Other")
# p1 %<>% annotate_figure(top = "Mean age | Other")

# SD of age
p2 <- ggseg(dat_CT, atlas = dk, 
      colour = "black",
      size = .1, 
      position = "dispersed",
      mapping = aes(fill = -log10(fdr_p_val_m2_age_L_RESI )  )) +
  scale_fill_viridis_c(name = "-log10(p-value)", option = "viridis", direction = 1, limits = limit_val, values = c(0, 1.5, 1.7, 2, 2.5, 2.6, 3.5, 8)/8) +
  theme(legend.position = "none", axis.title.x=element_blank(), axis.text = element_text(family = "sans"), text = element_text(family = "sans")) +
  labs(title = "SD of age | Other")
# p2 %<>% annotate_figure(top = "SD of age | Other")

# Skewness of age
p3 <- ggseg(dat_CT, atlas = dk, 
      colour = "black",
      size = .1, 
      position = "dispersed",
      mapping = aes(fill = -log10(fdr_p_val_m3_age_L_RESI ) )) +
  scale_fill_viridis_c(name = "-log10(p-value)", option = "viridis", direction = 1, limits = limit_val, values = c(0, 1.5, 1.7, 2, 2.5, 2.6, 3.5, 8)/8) +
  theme(legend.position = "none", axis.title.x=element_blank(), axis.text = element_text(family = "sans"), text = element_text(family = "sans")) +
  labs(title = "Skewness of age | Other")
# p3 %<>% annotate_figure(top = "Skewness of age | Other")

# design
p4 <- ggseg(dat_CT, atlas = dk, 
      colour = "black",
      size = .1, 
      position = "dispersed",
      mapping = aes(fill = -log10(fdr_p_val_design_L_RESI ) ) ) +
  scale_fill_viridis_c(name = "-log10(p-value)", option = "viridis", direction = 1, limits = limit_val, values = c(0, 1.5, 1.7, 2, 2.5, 2.6, 3.5, 8)/8) +
  theme(legend.position = "none", axis.title.x=element_blank(), axis.text = element_text(family = "sans"), text = element_text(family = "sans")) +
  labs(title = "Design | Other")
# p4 %<>% annotate_figure(top = "Design | Other")

p_CT = plot_grid(NULL, p1, p2, p3, p4, ncol = 1, rel_heights = c(0.2, 1, 1, 1, 1))  

P_ROI = plot_grid(NULL, p_vol, NULL, p_CT, L, ncol = 1, rel_heights = c(0.02, 1, 0.02, 1, 0.1),
                  labels = c("", "e  Regional GMV", "", "f  Regional CT", ""), vjust = 1, hjust = 0)

# P_ROI = grid.arrange(
#   p_vol, p_CT, L, 
#   layout_matrix = rbind(c(1, 2),
#                         c(1, 2),
#                         c(3, 3)
#                         ),
#   heights = c(1.2, 1, 0.2)
#   
#   # ,
#   # bottom = "Hemisphere"
# )

Fig1 = plot_grid(P_par, NULL, P_ROI, nrow = 1, rel_widths = c(2, 0.01, 1.2))
ggsave("figures_pdf/Figure_1.pdf", width = 18, height = 12, units = "in")
```



```{r, fig.height=12, fig.width=18}
# Fig1
```



# Fig. 2. Resampling schemes in UKB (whole brain measures & ROI)
```{r, fig.width=12, fig.height=9}
output <- readRDS("Results/resamp_whole_brain_measures/resamp_scheme_UKB.rds")
output$scheme %<>% factor(levels = c(2, 0, 1), labels = c("Bell-shaped", "Uniform", "U-shaped"))


temp = subset(output, N == 400)

# the improvement (%) in ES and power
cat("The improvement in ES by sampling schemes in UKB: \n")
# 1. U-shaped vs bell-shaped
v = (temp$mean_RESI_age[temp$scheme == "U-shaped"] - temp$mean_RESI_age[temp$scheme == "Bell-shaped"]) / temp$mean_RESI_age[temp$scheme == "Bell-shaped"] * 100
cat("U-shaped vs. Bell-shaped: ", v, "% \n")

# 2. U-shaped vs uniform
v = (temp$mean_RESI_age[temp$scheme == "U-shaped"] - temp$mean_RESI_age[temp$scheme == "Uniform"]) / temp$mean_RESI_age[temp$scheme == "Uniform"] * 100
cat("U-shaped vs. Uniform: ", round(v, 2), "% \n")

# ------ GMV ------------
# (A) RESI of age
p_resi = ggplot(data = output, aes(x = N, y = mean_RESI_age, color = scheme, group = scheme)) +  
    geom_ribbon(aes(ymin = RESI_age_ll, ymax = RESI_age_ul, fill = scheme), alpha=0.2, linetype = 0) + 
    geom_line(size = 1) +
  theme_classic() + labs(title = "Standardized effect size of age", y = 'RESI', x = 'Sample size') + theme(legend.position = "bottom") 
p_resi = p_resi + theme(legend.position = "none")

# (B) Power

library(Hmisc)
output$power_100 = output$power * 100
output$power_100_ll = binconf(output$power * 1000, n = 1000, method = "wilson")[, 2] * 100
output$power_100_ul = binconf(output$power * 1000, n = 1000, method = "wilson")[, 3] * 100
 
p_power = ggplot(data = output, aes(x = N, y = power_100, color = scheme, group = scheme)) +  
    geom_ribbon(aes(ymin = power_100_ll, ymax = power_100_ul, fill = scheme), alpha=0.2, linetype = 0) + 
    geom_line(size = 1) + 
  theme_classic() + labs(title = "Statistical power", y = 'Statistical power (%)', x = 'Sample size') + 
  theme(legend.position = "none") +
  scale_y_continuous(breaks=c(0, 20, 40, 60, 80, 100))

# (C) Replicability
output$replicability_100 = output$replicability * 100
output$replicability_100_ll = binconf(output$replicability * 1000, n = 1000, method = "wilson")[, 2] * 100
output$replicability_100_ul = binconf(output$replicability * 1000, n = 1000, method = "wilson")[, 3] * 100

p_rep = ggplot(data = output, aes(x = N, y = replicability_100, color = scheme, group = scheme)) +  
    geom_ribbon(aes(ymin = replicability_100_ll, ymax = replicability_100_ul, fill = scheme), alpha=0.2, linetype = 0) + 
    geom_line(size = 1) + 
  theme_classic() + labs(title = "Probability of replication", y = 'Replicability (%)', x = 'Sample size') + 
  theme(legend.position = "none") 

# (f) Probability of larger ES
# plot_data = subset(output, scheme != "Flat")
output$prob_larger_ES_ll = binconf(output$prob_larger_ES * 1000, n = 1000, method = "wilson")[, 2] 
output$prob_larger_ES_ul = binconf(output$prob_larger_ES * 1000, n = 1000, method = "wilson")[, 3] 


p6 = ggplot(data = output, aes(x = N, y = prob_larger_ES * 100, color = scheme, group = scheme)) +  
      geom_ribbon(aes(ymin = prob_larger_ES_ll * 100, ymax = prob_larger_ES_ul * 100, fill = scheme), alpha=0.2, linetype = 0) + 
    geom_line(size = 1) + 
  theme_classic() + labs(title = "Probability of larger ES", y = 'Probability (%)', x = 'Sample size') + 
  theme(legend.position = "none") 

P_GMV = plot_grid(p_resi, p_rep,  labels = c("a", "b"), nrow = 1) # %>% suppressWarnings()
P_GMV = annotate_figure(P_GMV, left = grid::textGrob("Total GMV", vjust = 0.3, rot = 90, gp = grid::gpar(cex = 1, fontface = "plain")) )


# -------- ROI ------------------

plot_data <- readRDS("Results/resamp_ROI_measures/resamp_ROI_UKB.rds")

plot_data$scheme %<>% factor(levels = c(2, 0, 1), labels = c("Bell-shaped", "Uniform", "U-shaped"))
plot_data$measure = lapply(plot_data$ROI, FUN = function(x) {
                                          y = unlist(strsplit(x, split = "_"))[2]
                                          return(y)
                                        }) %>% unlist


# -------- Regional volume (regional GMV) ----------
library(splines)
plot_data_vol = subset(plot_data, measure == "Vol")

# obtain the p-value for age effect in the full sample to determine null or non-null effect
analysis_data <- readr::read_csv("data/analysis_data/ROI/analysis_data_ROI_complete_case_combat.csv") 
analysis_data %<>% as.data.frame # `tibble` will cause a lot of problems with current RESI package
UKB = subset(analysis_data, study == "UKB")

for (y in unique(plot_data_vol$ROI)){
  formula_age = paste0(y, "~ sex_01 +  ns(age_years, df = 2)")
  fit =  eval(parse(text = paste0("lm(formula =", formula_age, ", data = UKB)") ) )
  # use the robust (sandwich) standard error estimates for p-values
  fit %<>% RESI::resi_pe()
  p_val = fit$anova['ns(age_years, df = 2)', 'Pr(>F)']
  plot_data_vol[which(plot_data_vol$ROI == y), "p_val"] = p_val
}

plot_data_vol %<>% group_by(scheme, N) %>% mutate(class = ifelse(p_val <= 0.05, "Non-null", "Null"))
# only use the ROIs that were judged as "true positive"
plot_data_vol = subset(plot_data_vol, class == "Non-null")


# P1: RESI
p_RESI = ggplot(data = plot_data_vol, aes(x = N, y = mean_RESI_age, group = interaction(scheme, ROI), color = scheme)) + 
            geom_line(linewidth = 0.4, alpha = 0.2) +
            geom_smooth(method = "loess", formula = 'y ~ x',  aes(group = interaction(scheme, class))) + 
            theme_classic() + 
            labs(title = "Standardized effect size of age", y = 'RESI', x = 'Sample size') + 
            theme(legend.position = "bottom") +
            labs(color='Sampling scheme', linetype = "Effect size") +
            ylim(0, 0.45)
legend = get_legend(p_RESI)

p_RESI = p_RESI + theme(legend.position = "none")


# P2: Power
library(Hmisc)
plot_data_vol$power_100 = plot_data_vol$power * 100
plot_data_vol$power_100_ll = binconf(plot_data_vol$power * 1000, n = 1000, method = "wilson")[, 2] * 100
plot_data_vol$power_100_ul = binconf(plot_data_vol$power * 1000, n = 1000, method = "wilson")[, 3] * 100

p_power = ggplot(data = plot_data_vol, aes(x = N, y = power_100, group = interaction(scheme, ROI), color = scheme)) + 
            geom_line(linewidth = 0.4, alpha = 0.2) +
            geom_smooth(method = "loess", formula = 'y ~ x', aes(group = interaction(scheme, class))) + 
            theme_classic() + 
            labs(title = "Statistical power", y = 'Statistical power (%)', x = 'Sample size') + 
            theme(legend.position = "none") +
            scale_y_continuous(breaks=c(0, 20, 40, 60, 80, 100))

# P3: replicability
p_rep = ggplot(data = plot_data_vol, aes(x = N, y = replicability, group = interaction(scheme, ROI), color = scheme)) + 
            geom_line(linewidth = 0.4, alpha = 0.2) +
            geom_smooth(method = "loess", formula = 'y ~ x', aes(group = interaction(scheme, class))) + 
            theme_classic() + 
            labs(title = "Probability of replication", y = 'Replicability (%)', x = 'Sample size') + 
            theme(legend.position = "none") 

P_Vol = plot_grid(p_RESI, p_rep, labels = c("c", "d"), nrow = 1) 
P_Vol = annotate_figure(P_Vol, left = grid::textGrob("Regional GMV", vjust = 0.3, rot = 90, gp = grid::gpar(cex = 1, fontface = "plain")))

# --------- regional CT ---------------

plot_data_CT = subset(plot_data, measure == "CT")

for (y in unique(plot_data_CT$ROI)){
  formula_age = paste0(y, "~ sex_01 +  ns(age_years, df = 2)")
  fit =  eval(parse(text = paste0("lm(formula =", formula_age, ", data = UKB)") ) )
  # use the robust (sandwich) standard error estimates for p-values
  fit %<>% RESI::resi_pe()
  p_val = fit$anova['ns(age_years, df = 2)', 'Pr(>F)']
  plot_data_CT[which(plot_data_CT$ROI == y), "p_val"] = p_val
}

plot_data_CT %<>% group_by(scheme, N) %>% mutate(class = ifelse(p_val <= 0.05, "Non-null", "Null"))

# only use the ROIs that were judged as "true positive"
plot_data_CT = subset(plot_data_CT, class == "Non-null")

# P1: RESI
p_RESI = ggplot(data = plot_data_CT, aes(x = N, y = mean_RESI_age, group = interaction(scheme, ROI), color = scheme)) + 
            geom_line(linewidth = 0.4, alpha = 0.2) +
            geom_smooth(method = "loess", formula = 'y ~ x',  aes(group = interaction(scheme, class))) + 
            theme_classic() + 
            labs(title = "Standardized effect size of age", y = 'RESI', x = 'Sample size') + 
            theme(legend.position = "none") +
            labs(color='Baseline Resampling Scheme') +
            ylim(0, 0.45)


# P2: Power
library(Hmisc)
plot_data_CT$power_100 = plot_data_CT$power * 100
plot_data_CT$power_100_ll = binconf(plot_data_CT$power * 1000, n = 1000, method = "wilson")[, 2] * 100
plot_data_CT$power_100_ul = binconf(plot_data_CT$power * 1000, n = 1000, method = "wilson")[, 3] * 100

p_power = ggplot(data = plot_data_CT, aes(x = N, y = power_100, group = interaction(scheme, ROI), color = scheme)) + 
            geom_line(linewidth = 0.4, alpha = 0.2) +
            geom_smooth(method = "loess", formula = 'y ~ x', aes(group = interaction(scheme, class))) + 
            theme_classic() + 
            labs(title = "Statistical power", y = 'Statistical power (%)', x = 'Sample size') + 
            theme(legend.position = "none") +
            scale_y_continuous(breaks=c(0, 20, 40, 60, 80, 100)) 
  

# P3: replicability
p_rep = ggplot(data = plot_data_CT, aes(x = N, y = replicability, group = interaction(scheme, ROI), color = scheme)) + 
            geom_line(linewidth = 0.4, alpha = 0.2) +
            geom_smooth(method = "loess", formula = 'y ~ x', aes(group = interaction(scheme, class))) + 
            theme_classic() + 
            labs(title = "Probability of replication", y = 'Replicability (%)', x = 'Sample size') + 
            theme(legend.position = "none") 

P_CT = plot_grid(p_RESI, p_rep, labels = c("e", "f"), nrow = 1) 
P_CT = annotate_figure(P_CT, left = grid::textGrob("Regional CT", vjust = 0.3, rot = 90, gp = grid::gpar(cex = 1, fontface = "plain")) )

P = plot_grid(P_GMV, P_Vol, P_CT, ncol = 1)
P = plot_grid(P, legend, ncol = 1, rel_heights = c(1, 0.05))

ggsave("figures_pdf/Figure_2.pdf", width = 8, height = 10, units = "in")

```

```{r, fig.height= 8, fig.width=6}
# P
```

# Fig. 3. Resampling schemes in ADNI on GMV-age & ROI outcomes & the influence of num of obs

```{r, fig.height = 7, fig.width = 12}
# ------- Whole brain measure (GMV) --------
output <- readRDS("Results/resamp_whole_brain_measures/resamp_scheme_ADNI_m=2.rds")


library(Hmisc)

# restrict to N <= 150
output = subset(output, N <= 150)

# creating scheme labels
output$`Baseline Sampling Scheme` = factor(output$bl_scheme, levels = c(2, 0, 1), labels = c("Baseline: bell-shaped", "Baseline: uniform", "Baseline: U-shaped"))
output$`Within-subject Sampling Scheme` = factor(output$D_scheme, levels = c(2, 0, 1), labels = c( "Decreasing", "Uniform", "Increasing"))

# --------- L-RESI -------------
p_l_resi = ggplot(data = output, aes(x = N, y = L_RESI_age, color = `Within-subject Sampling Scheme`, group = `Within-subject Sampling Scheme`)) + 
                geom_ribbon(aes(ymin = L_RESI_age_ll, ymax = L_RESI_age_ul, fill = `Within-subject Sampling Scheme`), alpha=0.2, linetype = 0) +
                geom_line(size = 1) + 
                facet_wrap(~ `Baseline Sampling Scheme`) + theme_classic() + theme(legend.position = "bottom")  + 
                labs(title = "Standardized effect size of age", y = 'RESI', x = 'Sample size')
legend = get_legend(p_l_resi)
p_l_resi = p_l_resi + theme(legend.position = "none")

# Power
output$power_100 = output$power * 100
output$power_100_ll = binconf(output$power * 1000, n = 1000, method = "wilson")[, 2] * 100
output$power_100_ul = binconf(output$power * 1000, n = 1000, method = "wilson")[, 3] * 100

p_power = ggplot(data = output, aes(x = N, y = power_100, color = `Within-subject Sampling Scheme`, group = `Within-subject Sampling Scheme`)) + 
                geom_ribbon(aes(ymin = power_100_ll, ymax = power_100_ul, fill = `Within-subject Sampling Scheme`), alpha=0.2, linetype = 0) +
                geom_line(size = 1) + 
                facet_wrap(~ `Baseline Sampling Scheme`) + theme_classic() + theme(legend.position = "none") + ylim(40, 100) +
                labs(title = "Statistical power", y = 'Statistical power (%)', x = 'Sample size')

# replicability
output$replicability_100 = output$replicability * 100
output$replicability_100_ll = binconf(output$replicability * 1000, n = 1000, method = "wilson")[, 2] * 100
output$replicability_100_ul = binconf(output$replicability * 1000, n = 1000, method = "wilson")[, 3] * 100

p_replicate = ggplot(data = output, aes(x = N, y = replicability_100, color = `Within-subject Sampling Scheme`, group = `Within-subject Sampling Scheme`)) + 
                geom_ribbon(aes(ymin = replicability_100_ll, ymax = replicability_100_ul, fill = `Within-subject Sampling Scheme`), alpha=0.2, linetype = 0) +
                geom_line(size = 1) + 
                facet_wrap(~ `Baseline Sampling Scheme`) + theme_classic() + theme(legend.position = "none") + ylim(40, 100) +
                labs(title = "Probability of replication", y = 'Replicability (%)', x = 'Sample size')



P_1 = plot_grid(p_l_resi, p_replicate, labels = c("a", "b"), ncol = 1) # %>% suppressWarnings()

# P_1 = plot_grid(P_1, legend, rel_heights = c(1, 0.1), ncol = 1)


# ---------- influence of m --------------

m1 = readRDS("Results/resamp_whole_brain_measures/resamp_scheme_ADNI_m=1.rds")
m2 = readRDS("Results/resamp_whole_brain_measures/resamp_scheme_ADNI_m=2.rds")
m2 = subset(m2, N == 30 & D_scheme == 0 & bl_scheme == 0)
m3 = readRDS("Results/resamp_whole_brain_measures/resamp_scheme_ADNI_m=3.rds")
m4 = readRDS("Results/resamp_whole_brain_measures/resamp_scheme_ADNI_m=4.rds")

# data clean
# m1 = expand_grid(m1, D_scheme = 0:2)
m1$D_scheme = 0

m1$m = 1
m2$m = 2
m3$m = 3
m4$m = 4

plot_data = rbind(m1, m2[, colnames(m1)], m3, m4)

plot_data %<>% arrange(m)

# L-RESI
p_L_resi = ggplot(data = plot_data, aes(x = as.factor(m), y = L_RESI_age, ymin = L_RESI_age_ll, ymax = L_RESI_age_ul))+ 
              geom_errorbar(width = .1) +
              geom_point(size=1) + 
              geom_line(aes(x = m, y = L_RESI_age), alpha = 0.3) + 
              scale_x_discrete(name="Number of measurements per subject") +
              theme_classic() +
              labs(y = "RESI", title = "Standardized effect size of age") + theme(legend.position = "none") 

# power
plot_data$power_100 = plot_data$power * 100
plot_data$power_100_ll = binconf(plot_data$power * 1000, n = 1000, method = "wilson")[, 2] * 100
plot_data$power_100_ul = binconf(plot_data$power * 1000, n = 1000, method = "wilson")[, 3] * 100


p_power = ggplot(data = plot_data, aes(x = as.factor(m), y = power_100, ymin = power_100_ll, ymax = power_100_ul)) + 
              geom_errorbar(width = .1) +
              geom_point(size=1) + 
              geom_line(aes(x = m, y = power_100), alpha = 0.3) + 
              scale_x_discrete(name="Number of measurements per subject") +
              theme_classic() +
              labs(y = "Statistical power (%)", title = "Statistical power") + theme(legend.position = "none")

# replicability
plot_data$replicability_100 = plot_data$replicability * 100
plot_data$replicability_100_ll = binconf(plot_data$replicability * 1000, n = 1000, method = "wilson")[, 2] * 100
plot_data$replicability_100_ul = binconf(plot_data$replicability * 1000, n = 1000, method = "wilson")[, 3] * 100


p_rep = ggplot(data = plot_data, aes(x = as.factor(m), y = replicability_100, ymin = replicability_100_ll, ymax = replicability_100_ul)) + 
              geom_errorbar(width = .1) +
              geom_point(size=1) + 
              geom_line(aes(x = m, y = replicability_100), alpha = 0.3) + 
              scale_x_discrete(name="Number of measurements per subject") +
              theme_classic() + 
              labs(y = "Replicability (%)", title = "Probability of replication") + theme(legend.position = "none") 



P_2 = plot_grid(p_L_resi, p_rep,  labels = c("c", "d"), ncol = 1,
              hjust = 0) # %>% suppressWarnings()
# P_2 = plot_grid(P_2, NULL, ncol = 1, rel_heights = c(1, 0.1))


P_GMV = plot_grid(P_1, NULL, P_2, nrow = 1, rel_widths = c(2, 0.2, 1))
P_GMV = annotate_figure(P_GMV, left = grid::textGrob("Total GMV", vjust = 0.2, rot = 90, gp = grid::gpar(cex = 1.3, fontface = "plain")) )


# ------- Regional GMV & CT ----------------

plot_data <- readRDS("Results/resamp_ROI_measures/resamp_ROI_ADNI.rds")
ROI_dict = readr::read_csv("data/analysis_data/ROI/ROI_dict_DKparcellation.csv")
ROI_dict$ROI_id = 1:nrow(ROI_dict)

plot_data = subset(plot_data, N <= 150)

plot_data$outcome = lapply(plot_data$ROI %>% as.character, FUN = function(x){
  z = strsplit(x, split = "_") %>% unlist
  return(z[2])
}) %>% unlist

# outcome labels
plot_data$outcome_label = NA
plot_data$outcome_label[plot_data$outcome == "Vol"] = "Volume"
plot_data$outcome_label[plot_data$outcome == "CT"] = "CT"

# scheme labels
plot_data$bl_scheme_label = NA
plot_data$bl_scheme_label[plot_data$bl_scheme == 0] = "Baseline: uniform"
plot_data$bl_scheme_label[plot_data$bl_scheme == 1] = "Baseline: U-shaped"
plot_data$bl_scheme_label[plot_data$bl_scheme == 2] = "Baseline: bell-shaped"
plot_data$bl_scheme_label %<>% factor(levels = c("Baseline: bell-shaped", "Baseline: uniform", "Baseline: U-shaped"))

plot_data$D_scheme_label = NA
plot_data$D_scheme_label[plot_data$D_scheme == 0] = "Uniform"
plot_data$D_scheme_label[plot_data$D_scheme == 1] = "Increasing"
plot_data$D_scheme_label[plot_data$D_scheme == 2] = "Decreasing"

plot_data$D_scheme_label %<>% factor(levels = c("Decreasing", "Uniform", "Increasing"))



# 1. ------- Regional GMV -----------
dat = subset(plot_data, outcome_label == "Volume")

library(splines)
library(geepack)
# null vs non-null effect
# obtain the p-value for age effect in the full sample to determine null or non-null effect
analysis_data <- readr::read_csv("data/analysis_data/ROI/analysis_data_ROI_complete_case_combat.csv") 
analysis_data %<>% as.data.frame # `tibble` will cause a lot of problems with current RESI package
ADNI = subset(analysis_data, study == "ADNI")

for (y in unique(dat$ROI)){
  formula_age = paste0(y, "~ sex_01 +  ns(age_years, df = 2)")
  fit =  eval(parse(text = paste0("geeglm(formula =", formula_age, ", data = ADNI, id = participant, corstr = 'exchangeable')") ) )
  # use the robust (sandwich) standard error estimates for p-values
  fit %<>% RESI::resi_pe()
  p_val = fit$anova['ns(age_years, df = 2)', 'P(>|Chi|)']
  dat[which(dat$ROI == y), "p_val"] = p_val
}

dat %<>% mutate(class = ifelse(p_val <= 0.05, "True positive", "False positive"))
dat$class %<>% factor(levels = c("True positive", "False positive"))

# only use the ROIs that were judged as "true positive"
dat = subset(dat, class == "True positive")


# RESI
p_l_resi = ggplot(data = dat, aes(x = N, y = L_RESI_age, color = D_scheme_label, group = interaction(D_scheme_label, ROI) )) + 
                geom_line(linewidth = 0.4, alpha = 0.1) +
                geom_smooth(method = "loess", formula = 'y ~ x',  aes(group = D_scheme)) +
                facet_wrap(~ bl_scheme_label) + theme_classic() + 
                theme(legend.position = "none") +
                labs(title = "Standardized effect size of age", y = 'RESI', x = 'Sample size')

# Power
dat$power_100 = dat$power * 100
p_power = ggplot(data = dat, aes(x = N, y = power_100, color = D_scheme_label, group = interaction(D_scheme_label, ROI) )) + 
                geom_line(linewidth = 0.4, alpha = 0.1) +
                geom_smooth(method = "loess", formula = 'y ~ x',  aes(group = D_scheme) ) +
                facet_wrap(~ bl_scheme_label) + theme_classic() + 
                theme(legend.position = "none") +
                labs(title = "Statistical power", y = 'Statistical power (%)', x = 'Sample size')

# replicability
dat$replicability_100 = dat$replicability * 100

p_replicate = ggplot(data = dat, aes(x = N, y = replicability_100, color = D_scheme_label, group = interaction(D_scheme_label, ROI) )) + 
                geom_line(linewidth = 0.4, alpha = 0.1) +
                geom_smooth(method = "loess", formula = 'y ~ x',  aes(group = D_scheme)) +
                facet_wrap(~ bl_scheme_label) + theme_classic() + 
                theme(legend.position = "none") +
                labs(title = "Probability of replication", y = 'Replicability (%)', x = 'Sample size')


P_vol = plot_grid(p_l_resi, p_replicate,  labels = c("e", "f"), nrow = 1) 
P_vol = annotate_figure(P_vol, left = grid::textGrob("Regional GMV", vjust = 0.25, rot = 90, gp = grid::gpar(cex = 1.3, fontface = "plain")))

# 2. ----- Regional CT  ---
dat = subset(plot_data, outcome_label == "CT")
# null vs non-null effect
for (y in unique(dat$ROI)){
  formula_age = paste0(y, "~ sex_01 +  ns(age_years, df = 2)")
  fit =  eval(parse(text = paste0("geeglm(formula =", formula_age, ", data = ADNI, id = participant, corstr = 'exchangeable')") ) )
  # use the robust (sandwich) standard error estimates for p-values
  fit %<>% RESI::resi_pe()
  p_val = fit$anova['ns(age_years, df = 2)', 'P(>|Chi|)']
  dat[which(dat$ROI == y), "p_val"] = p_val
}

dat %<>%  mutate(class = ifelse(p_val <= 0.05, "True positive", "False positive"))
dat$class %<>% factor(levels = c("True positive", "False positive"))

# only use the ROIs that were judged as "true positive"
dat = subset(dat, class == "True positive")

# RESI
p_l_resi = ggplot(data = dat, aes(x = N, y = L_RESI_age, color = D_scheme_label, group = interaction(D_scheme_label, ROI) )) + 
                geom_line(linewidth = 0.4, alpha = 0.1) +
                geom_smooth(method = "loess", formula = 'y ~ x',  aes(group = D_scheme)) +
                facet_wrap(~ bl_scheme_label) + theme_classic() + 
                theme(legend.position = "none") +
                labs(title = "Standardized effect size of age", y = 'RESI', x = 'Sample size')

# Power
dat$power_100 = dat$power * 100
p_power = ggplot(data = dat, aes(x = N, y = power_100, color = D_scheme_label, group = interaction(D_scheme_label, ROI) )) + 
                geom_line(linewidth = 0.4, alpha = 0.1) +
                geom_smooth(method = "loess", formula = 'y ~ x',  aes(group = D_scheme)) +
                facet_wrap(~ bl_scheme_label) + theme_classic() + 
                theme(legend.position = "none") +
                labs(title = "Statistical power", y = 'Statistical power (%)', x = 'Sample size')

# replicability
dat$replicability_100 = dat$replicability * 100

p_replicate = ggplot(data = dat, aes(x = N, y = replicability_100, color = D_scheme_label, group = interaction(D_scheme_label, ROI) )) + 
                geom_line(linewidth = 0.4, alpha = 0.1) +
                geom_smooth(method = "loess", formula = 'y ~ x',  aes(group = D_scheme)) +
                facet_wrap(~ bl_scheme_label) + theme_classic() + 
                theme(legend.position = "none") +
                labs(title = "Probability of replication", y = 'Replicability (%)', x = 'Sample size')


P_CT = plot_grid(p_l_resi, p_replicate,  labels = c("g", "h"), nrow = 1) 
P_CT = annotate_figure(P_CT, left = grid::textGrob("Regional CT", vjust = 0.3, rot = 90, gp = grid::gpar(cex = 1.3, fontface = "plain")) )

P = plot_grid(P_GMV, P_vol, P_CT, legend, ncol = 1, rel_heights = c(2, 1, 1, 0.1))

ggsave("figures_pdf/Figure_3.pdf", width = 10, height = 10, units = "in")
```


```{r, fig.height = 10, fig.width = 10}
# P
```

```{r}
# Calculate: the increase in ES between different schemes
output <- readRDS("Results/resamp_whole_brain_measures/resamp_scheme_ADNI_m=2.rds")
data = subset(output, N == 150 & D_scheme == 0)
# bl_scheme = 0 (uniform); 1 (U-shaped); 2 (bell-shaped)
## U-shaped vs bell-shaped
(data$L_RESI_age[data$bl_scheme == 1] - data$L_RESI_age[data$bl_scheme == 2]) / data$L_RESI_age[data$bl_scheme == 2]
## U-shaped vs uniform
(data$L_RESI_age[data$bl_scheme == 1] - data$L_RESI_age[data$bl_scheme == 0]) / data$L_RESI_age[data$bl_scheme == 0]
```

```{r}
# the increase in ES, power & replicability by adding the second measurement
m1 = readRDS("Results/resamp_whole_brain_measures/resamp_scheme_ADNI_m=1.rds")
m2 = readRDS("Results/resamp_whole_brain_measures/resamp_scheme_ADNI_m=2.rds")
m2 = subset(m2, N == 30 & D_scheme == 0 & bl_scheme == 0)

# data clean
# m1 = expand_grid(m1, D_scheme = 0:2)
m1$D_scheme = 0
m1$m = 1
m2$m = 2

plot_data = rbind(m1, m2[, colnames(m1)])
plot_data %<>% arrange(m)

(plot_data$L_RESI_age[plot_data$m == 2] - plot_data$L_RESI_age[plot_data$m == 1]) / plot_data$L_RESI_age[plot_data$m == 1] * 100

(plot_data$power[plot_data$m == 2] - plot_data$power[plot_data$m == 1]) / plot_data$power[plot_data$m == 1] * 100

(plot_data$replicability[plot_data$m == 2] - plot_data$replicability[plot_data$m == 1]) / plot_data$replicability[plot_data$m == 1] * 100

```


# Fig. 4. Sampling schemes on other covariates in ABCD - select
```{r}
library(Hmisc)

# ------ global & regional brain outcomes -----------
filenames <- list.files("Results/ABCD_samp_other_covariate_ROI_global", pattern = "nsim1000", full.names=TRUE)

col_names = readRDS("Results/ABCD_samp_other_covariate_ROI_global/samp_nihtbx_totalcomp_fc_nsim1000.rds") %>% colnames

obj = list()
for (i in 1:length(filenames)){
  temp = readRDS(filenames[i])
  obj[[i]] = temp[, col_names]
}

plot_data = do.call(rbind, obj)

# check sample size
plot_data$N %>% unique
# check schemes
plot_data$bl_scheme %>% unique
plot_data$D_scheme %>% unique

# plot_data = subset(plot_data, X %in% c("nihtbx_totalcomp_fc", "nihtbx_cardsort_fc", "nihtbx_fluidcomp_fc", 
#                                        "nihtbx_cryst_fc", "nihtbx_flanker_fc", "nihtbx_list_fc", "nihtbx_pattern_fc", 
#                                        "nihtbx_picture_fc",  "nihtbx_picvocab_fc",  "nihtbx_reading_fc",
#                                        "BMI", "cbcl_scr_syn_totprob_t", "bw", "handedness") )

plot_data = subset(plot_data, X %in% c("nihtbx_cryst_fc", "BMI", "cbcl_scr_syn_totprob_t", "bw") )

# adding labels for sampling schemes
plot_data$bl_scheme %<>% factor(levels = c(2, 1), labels = c("Smaller (Bell-shaped)", "Larger (U-shaped)"))
plot_data$D_scheme %<>% factor(levels = c(2, 1), labels = c("Smaller (Bell-shaped)", "Larger (U-shaped)"))

# clean 
plot_data$D_scheme[plot_data$X %in% c("bw", "handedness", "nihtbx_totalcomp_fc", "nihtbx_cardsort_fc", "nihtbx_fluidcomp_fc") ] = "Smaller (Bell-shaped)"


plot_data$X_type = ifelse(plot_data$X %in% c("nihtbx_totalcomp_fc", "nihtbx_cardsort_fc", "nihtbx_fluidcomp_fc"), "Cross-sectional", "Longitudinal")

# adding labels for the covariates
plot_data$X %<>% factor(levels = c("nihtbx_cryst_fc",
                                   "cbcl_scr_syn_totprob_t",
                                   "BMI", "bw"),
                        labels = c("Crystallized Composite", 
                                   "CBCL",
                                   "BMI", "Birth Weight")
)


# labels for ROI outcomes
outcome = lapply(plot_data$Y %>% as.character, FUN = function(x){
  z = strsplit(x, split = "_") %>% unlist
  return(z[2])
}) %>% unlist

plot_data$outcome_type = NA
plot_data$outcome_type[outcome == "Vol"] = "Regional Vol"
plot_data$outcome_type[outcome == "CT"] = "Regional CT"

# CIs for Power and Replicability
## m = 2
plot_data$power_100 = plot_data$power * 100
plot_data$power_100_ll = binconf(plot_data$power * 1000, n = 1000, method = "wilson")[, 2] * 100
plot_data$power_100_ul = binconf(plot_data$power * 1000, n = 1000, method = "wilson")[, 3] * 100

plot_data$replicability_100 = plot_data$replicability * 100
plot_data$replicability_100_ll = binconf(plot_data$replicability * 1000, n = 1000, method = "wilson")[, 2] * 100
plot_data$replicability_100_ul = binconf(plot_data$replicability * 1000, n = 1000, method = "wilson")[, 3] * 100

## m = 1
plot_data$power_m1_100 = plot_data$power_m1 * 100
plot_data$power_m1_100_ll[!is.na(plot_data$power_m1)] = binconf(plot_data$power_m1[!is.na(plot_data$power_m1)] * 1000, n = 1000, method = "wilson")[, 2] * 100
plot_data$power_m1_100_ul[!is.na(plot_data$power_m1)] = binconf(plot_data$power_m1[!is.na(plot_data$power_m1)] * 1000, n = 1000, method = "wilson")[, 3] * 100

plot_data$replicability_m1_100 = plot_data$replicability_m1 * 100
plot_data$replicability_m1_100_ll[!is.na(plot_data$replicability_m1)] = binconf(plot_data$replicability_m1[!is.na(plot_data$replicability_m1)] * 1000, n = 1000, method = "wilson")[, 2] * 100
plot_data$replicability_m1_100_ul[!is.na(plot_data$replicability_m1)] = binconf(plot_data$replicability_m1[!is.na(plot_data$replicability_m1)] * 1000, n = 1000, method = "wilson")[, 3] * 100



# calculate: sample size needed for 80% replicability
plot_data$N_80 = lapply(plot_data$gee_L_RESI, FUN = function(S) {
  df = 5 # total number of parameters in the model
  f = function(n) {pf(qf(0.95, df1 = 1, df2= n - df), df1 = 1, df2 = n - df, ncp = S^2*n, lower.tail = FALSE) - sqrt(0.8)}
  N = uniroot(f, lower = 6, upper = 1000000)$root
  return(N)
} ) %>% unlist

plot_data$N_80_ceil = ifelse(plot_data$N_80 >= 3000, 3000, plot_data$N_80)


# # calculate: the reduction factor for the sample sizes needed for 80% power by increasing between-subject variability (comparing with between-subject variability == "smaller & within-subject variability = "smaller)
# plot_data %<>% arrange(Y, X)
# plot_data %<>% group_by(Y, X) %>% 
#   mutate(red_factor_N_80 = N_80[bl_scheme == "Smaller (Bell-shaped)" & D_scheme == "Smaller (Bell-shaped)"] / N_80) 
# 
# # calculate: the increase factor for the ES by increasing the between-subject variability (comparing with between-subject variability == "smaller & within-subject variability = "smaller)
# plot_data %<>% group_by(Y, X) %>% mutate(inc_factor_L_RESI = gee_L_RESI / gee_L_RESI[bl_scheme == "Smaller (Bell-shaped)" & D_scheme == "Smaller (Bell-shaped)"]) 


# figure element configuration
errorbar_line_size = 0.8
point_size = 2.5


# ----- 1. outcome GMV -------
data_GMV = subset(plot_data, Y == "GMV_10000_combat")

# data_GMV$bl_scheme %<>% factor(levels = c("NA", "Smaller", "Larger"))
# data_GMV$D_scheme %<>% factor(levels = c("NA", "Smaller", "Larger"))

# adding labels for outcome
data_GMV$Y_lab = "Outcome: Global GMV"

# 1.1 GMV & L-RESI
P_GMV_L_RESI = ggplot(data_GMV, aes(x = X, y = gee_L_RESI, ymin = gee_L_RESI_ll, ymax = gee_L_RESI_ul, col = bl_scheme, group = interaction(bl_scheme, D_scheme))) + 
  #specify position here
  geom_errorbar(width = .35, size = errorbar_line_size, position = position_dodge(width = 0.5)) +
  geom_point(aes(shape = D_scheme), size = point_size, position=position_dodge(width = 0.5)) + 
  # facet_grid(. ~ X_type, space = "free_x", scales = "free_x") +
  theme_bw() +
  theme(#axis.text.x = element_text(angle = 45, hjust = 1), 
        legend.position = "none", panel.border = element_blank(), axis.line = element_line()) +
  theme(
    axis.text.x = element_text(color="black"),
    axis.ticks = element_line(color = "black")
  ) + 
  labs(col = "Between-subject Variability", linetype = "Within-subject Variability", x = "", y = "RESI", title = "Standardized effect size")

# 1.2 GMV & power
# P_GMV_power = ggplot(data_GMV, aes(x = X, y = power_100, ymin = power_100_ll, ymax = power_100_ul, linetype = D_scheme, col = bl_scheme)) + 
#   #specify position here
#   geom_errorbar(width = .5, position = position_dodge(width = 0.5)) +
#   geom_point(size = 1, position=position_dodge(width = 0.5)) + 
#   facet_grid(. ~ X_type, space = "free_x", scales = "free_x") +
#   theme_bw() +
#   theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none", panel.border = element_blank(), axis.line = element_line()) +
#   labs(x = "", y = "Power (%)", title = "Statistical Power") 
# 
# # 1.3 GMV & replicability
# P_GMV_rep = ggplot(data_GMV, aes(x = X, y = replicability_100, ymin = replicability_100_ll, ymax = replicability_100_ul, linetype = D_scheme, col = bl_scheme)) +
#   #specify position here
#   geom_errorbar(width = .5, position = position_dodge(width = 0.5)) +
#   geom_point(size = 1, position=position_dodge(width = 0.5)) + 
#   facet_grid(. ~ X_type, space = "free_x", scales = "free_x") +
#   theme_bw() +
#   theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none", panel.border = element_blank(), axis.line = element_line()) +
#   labs(x = "", y = "Replicability (%)", title = "Probability of Replication") 

# 1.4 GMV & Sample size needed for 80% replicability
P_GMV_N_80 = ggplot(data_GMV, aes(x = X, y = N_80_ceil, col = bl_scheme)) +
  #specify position here
  # geom_errorbar(width = .5, position = position_dodge(width = 0.5)) +
  geom_point(aes(shape = D_scheme), size = point_size, position=position_dodge(width = 0.5)) + 
  # facet_grid(. ~ X_type, space = "free_x", scales = "free_x") +
  theme_bw() +
  theme( # axis.text.x = element_text(angle = 45, hjust = 1), 
        legend.position = "bottom", panel.border = element_blank(), axis.line = element_line()) +
  theme(
    axis.text.x = element_text(color="black"),
    axis.ticks = element_line(color = "black")
  ) + 
  scale_y_continuous(breaks=c(0, 500, 1000, 2000, 3000),
        labels=c("0", "500", "1000", "2000", ">3000")) + 
  labs(col = "Between-subject Variability", shape = "Within-subject Variability",
       x = "", y = "Sample Size", title = "N needed for 80% replicability") 

legend_GMV = get_legend(P_GMV_N_80)
P_GMV_N_80 = P_GMV_N_80 + theme(legend.position = "none")


# ------ 2. outcome: ROI GMV -------------

# 2.1 ROI Vol & L-RESI
data_ROI_vol = subset(plot_data, outcome_type == "Regional Vol")
# data_ROI_vol$bl_scheme %<>% factor(levels = c("Smaller", "Larger"))
# data_ROI_vol$D_scheme %<>% factor(levels = c("Smaller", "Larger"))

data_ROI_vol$Y_lab = "Outcome: Regional GMV"

P_vol_L_RESI = ggplot(data_ROI_vol, aes(x = X, y = gee_L_RESI, linetype = D_scheme, fill = bl_scheme)) +
  # geom_violin(position = position_dodge(width = 0.7)) + 
  geom_boxplot(width = 0.4, position = position_dodge(width = 0.7), outlier.shape = NA) + 
  # facet_grid(. ~ X_type, space = "free_x", scales = "free_x") +
  theme_bw() +
  theme( #axis.text.x = element_text(angle = 45, hjust = 1), 
        legend.position = "none", panel.border = element_blank(), axis.line = element_line()) +
  theme(
    axis.text.x = element_text(color="black"),
    axis.ticks = element_line(color = "black")
  ) + 
  labs( x = "", y = "RESI", title = "Standardized effect size") 


legend_ROI = get_legend(P_vol_L_RESI)
P_vol_L_RESI = P_vol_L_RESI + theme(legend.position = "none")

# 
# # 2.2 ROI Vol & power
# P_vol_power = ggplot(data_ROI_vol, aes(x = X, y = power_100, linetype = D_scheme, fill = bl_scheme)) +
#   # geom_violin(position = position_dodge(width = 0.7)) + 
#   geom_boxplot(width = 0.4, position = position_dodge(width = 0.7), outlier.shape = NA) + 
#   facet_grid(. ~ X_type, space = "free_x", scales = "free_x") +
#   theme_bw() +
#   theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none", panel.border = element_blank(), axis.line = element_line()) +
#   labs( x ="", y = "Power (%)", title = "Statistical Power") 
# 
# 
# # 2.3 ROI Vol & replicability
# P_vol_rep = ggplot(data_ROI_vol, aes(x = X, y = replicability_100, linetype = D_scheme, fill = bl_scheme)) +
#   # geom_violin(position = position_dodge(width = 0.7)) + 
#   geom_boxplot(width = 0.4, position = position_dodge(width = 0.7), outlier.shape = NA) + 
#   facet_grid(. ~ X_type, space = "free_x", scales = "free_x") +
#   theme_bw() +
#   theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none", panel.border = element_blank(), axis.line = element_line()) +
#   labs( x = "", y = "Replicability (%)", title = "Probability of Replication" ) 


# 2.4 ROI & Sample size needed for 80% replicability
P_vol_N_80 = ggplot(data_ROI_vol, aes(x = X, y = N_80_ceil, linetype = D_scheme, fill = bl_scheme)) +
  #specify position here
  geom_boxplot(width = 0.4, position = position_dodge(width = 0.7), outlier.shape = NA) + 
  # facet_grid(. ~ X_type, space = "free_x", scales = "free_x") +
  theme_bw() +
  theme(# axis.text.x = element_text(angle = 45, hjust = 1), 
    legend.position = "none", panel.border = element_blank(), axis.line = element_line()) +
  theme(
    axis.text.x = element_text(color="black"),
    axis.ticks = element_line(color = "black")
  ) + 
  scale_y_continuous(breaks=c(0, 500, 1000, 2000, 3000),
        labels=c("0", "500", "1000", "2000", ">3000")) +
  labs(x = "", y = "Sample Size", title = "N needed for 80% replicability")


# ------ 3. outcome: ROI CT ---------
data_ROI_CT = subset(plot_data, outcome_type == "Regional CT")
data_ROI_CT$Y_lab = "Outcome: Regional CT"

# 3.1 CT & L-RESI
P_CT_L_RESI = ggplot(data_ROI_CT, aes(x = X, y = gee_L_RESI, linetype = D_scheme, fill = bl_scheme)) +
  # geom_violin(position = position_dodge(width = 0.7)) + 
  geom_boxplot(width = 0.4, position = position_dodge(width = 0.7), outlier.shape = NA) + 
  # facet_grid(. ~ X_type, space = "free_x", scales = "free_x") +
  theme_bw() +
  theme(# axis.text.x = element_text(angle = 45, hjust = 1), 
        legend.position = "none", panel.border = element_blank(), axis.line = element_line()) +
  theme(
    axis.text.x = element_text(color="black"),
    axis.ticks = element_line(color = "black")
  ) + 
  labs( x = "", y = "RESI", title = "Standardized effect size")


# # 3.2 ROI CT & power
# P_CT_power = ggplot(data_ROI_CT, aes(x = X, y = power_100, linetype = D_scheme, fill = bl_scheme)) +
#   # geom_violin(position = position_dodge(width = 0.7)) + 
#   geom_boxplot(width = 0.4, position = position_dodge(width = 0.7), outlier.shape = NA) + 
#   facet_grid(. ~ X_type, space = "free_x", scales = "free_x") +
#   theme_bw() +
#   theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none", panel.border = element_blank(), axis.line = element_line()) +
#   labs( x = "", y = "Power (%)", title = "Statistical Power") 
# 
# 
# # 3.3 ROI CT & replicability
# P_CT_rep = ggplot(data_ROI_CT, aes(x = X, y = replicability_100, linetype = D_scheme, fill = bl_scheme)) +
#   # geom_violin(position = position_dodge(width = 0.7)) + 
#   geom_boxplot(width = 0.4, position = position_dodge(width = 0.7), outlier.shape = NA) + 
#   facet_grid(. ~ X_type, space = "free_x", scales = "free_x") +
#   theme_bw() +
#   theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none", panel.border = element_blank(), axis.line = element_line()) +
#   labs( x = "", y = "Replicability (%)", title = "Probability of Replication") +
#   ylim(0, 25)


# 3.4 ROI CT & Sample size needed for 80% replicability
P_CT_N_80 = ggplot(data_ROI_CT, aes(x = X, y = N_80_ceil, linetype = D_scheme, fill = bl_scheme)) +
  #specify position here
  geom_boxplot(width = 0.4, position = position_dodge(width = 0.7), outlier.shape = NA) + 
  # facet_grid(. ~ X_type, space = "free_x", scales = "free_x") +
  theme_bw() +
  theme(# axis.text.x = element_text(angle = 45, hjust = 1), 
        legend.position = "none", panel.border = element_blank(), axis.line = element_line()) +
  theme(
    axis.text.x = element_text(color="black"),
    axis.ticks = element_line(color = "black")
  ) + 
  labs(x = "", y = "Sample Size", title = "N needed for 80% replicability") +
  scale_y_continuous(breaks=c(0, 500, 1000, 2000, 3000),
        labels=c("0", "500", "1000", "2000", ">3000")) 


# ---------------- outcomes: FC -------------------

filenames <- list.files("Results/ABCD_samp_other_covariate_FC", pattern = ".rds",  full.names=TRUE)

plot_data_1 = plot_data_2 = NULL
var_list_1 = c("N", "nboot", "bl_scheme", "D_scheme", "X", "Y", "L_RESI", "L_RESI_ll", "L_RESI_ul")
var_list_2 = c("N", "nboot", "bl_scheme", "D_scheme", "X", "Y", "gee_L_RESI", "gee_L_RESI_ll", "gee_L_RESI_ul")
for (i in 1:length(filenames)){
  temp = readRDS(filenames[i])
  if (unique(temp$X) %in% c("nihtbx_totalcomp_fc", "nihtbx_list_fc", "nihtbx_cardsort_fc", "nihtbx_fluidcomp_fc", "handedness")){
    plot_data_1 = rbind(plot_data_1, temp[, var_list_1])
  } else {
    plot_data_2 = rbind(plot_data_2, temp[, var_list_2])
  }
}

plot_data_2 %<>% rename(L_RESI = gee_L_RESI, L_RESI_ll = gee_L_RESI_ll, L_RESI_ul = gee_L_RESI_ul)

plot_data = rbind(plot_data_1, plot_data_2)

# check sample size
plot_data$N %>% unique
# check schemes
plot_data$bl_scheme %>% unique
plot_data$D_scheme %>% unique

plot_data = subset(plot_data, bl_scheme %in% c(2, 1) )

# plot_data = subset(plot_data, X %in% c("nihtbx_totalcomp_fc", "nihtbx_cardsort_fc", "nihtbx_fluidcomp_fc",
#                                        "nihtbx_cryst_fc", "nihtbx_flanker_fc", "nihtbx_list_fc", "nihtbx_pattern_fc",
#                                        "nihtbx_picture_fc",  "nihtbx_picvocab_fc",  "nihtbx_reading_fc",
#                                        "BMI",  "cbcl_scr_syn_totprob_t","bw", "handedness"))

plot_data = subset(plot_data, X %in% c("nihtbx_cryst_fc", 
                                       "BMI",  "cbcl_scr_syn_totprob_t","bw"))

# adding labels for sampling schemes
plot_data$bl_scheme %<>% factor(levels = c(2, 1), labels = c("Smaller (Bell-shaped)", "Larger (U-shaped)"))
plot_data$D_scheme %<>% factor(levels = c(2, 1), labels = c("Smaller (Bell-shaped)", "Larger (U-shaped)"))

# clean 
plot_data$D_scheme[plot_data$X %in% c("bw", "handedness", "nihtbx_totalcomp_fc", "nihtbx_list_fc", "nihtbx_cardsort_fc", "nihtbx_fluidcomp_fc") ] = "Smaller (Bell-shaped)"


plot_data$X_type = ifelse(plot_data$X %in% c("nihtbx_totalcomp_fc", "nihtbx_list_fc", "nihtbx_cardsort_fc", "nihtbx_fluidcomp_fc"), "Cross-sectional", "Longitudinal")

# adding labels for the covariates
plot_data$X %<>% factor(levels = c("nihtbx_cryst_fc",
                                   "cbcl_scr_syn_totprob_t",
                                   "BMI", "bw"),
                        labels = c("Crystallized Composite", 
                                   "CBCL",
                                   "BMI", "Birth Weight")
)



# ------ 3. outcome: FC ---------
data_FC = plot_data

# calculate: sample size needed for 80% replicability
data_FC$N_80 = lapply(data_FC$L_RESI, FUN = function(S) {
  df = 8 # total num of parameters in the model
  f = function(n) {pf(qf(0.95, df1 = 1, df2= n - df), df1 = 1, df2 = n - df, ncp = S^2*n, lower.tail = FALSE) - sqrt(0.8)}
  N = uniroot(f, lower = 9, upper = 1000000)$root
  return(N)
} ) %>% unlist

data_FC$N_80_ceil = ifelse(data_FC$N_80 >= 3000, 3000, data_FC$N_80)

# calculate: the reduction factor for the sample sizes needed for 80% power by increasing between-subject variability (comparing with between-subject variability == "smaller & within-subject variability = "smaller)
data_FC %<>% arrange(Y, X)
data_FC %<>% group_by(Y, X) %>% 
  mutate(red_factor_N_80 = N_80[bl_scheme == "Smaller (Bell-shaped)" & D_scheme == "Smaller (Bell-shaped)"] / N_80) 

# calculate: the increase factor for the ES by increasing the between-subject variability (comparing with between-subject variability == "smaller & within-subject variability = "smaller)
data_FC %<>% group_by(Y, X) %>% mutate(inc_factor_L_RESI = L_RESI / L_RESI[bl_scheme == "Smaller (Bell-shaped)" & D_scheme == "Smaller (Bell-shaped)"]) 


# 4.1 RSFC & L-RESI
P_RSFC_L_RESI = ggplot(data_FC, aes(x = X, y = L_RESI, linetype = D_scheme, fill = bl_scheme)) +
  # geom_violin(position = position_dodge(width = 0.7)) + 
  geom_boxplot(width = 0.4, position = position_dodge(width = 0.7), outlier.shape = NA) + 
  # facet_grid(. ~ X_type, space = "free_x", scales = "free_x") +
  theme_bw() +
  theme( # axis.text.x = element_text(angle = 45, hjust = 1), 
        legend.position = "none", panel.border = element_blank(), axis.line = element_line()) +
  theme(
    axis.text.x = element_text(color="black"),
    axis.ticks = element_line(color = "black")
  ) + 
  labs( x = "", y = "RESI", title = "Standardized effect size")

# # 4.2 RSFC & power
# P_RSFC_power = ggplot(data_FC, aes(x = X, y = power_100, linetype = D_scheme, fill = bl_scheme)) +
#   # geom_violin(position = position_dodge(width = 0.7)) + 
#   geom_boxplot(width = 0.4, position = position_dodge(width = 0.7), outlier.shape = NA) + 
#   facet_grid(. ~ X_type, space = "free_x", scales = "free_x") +
#   theme_bw() +
#   theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none", panel.border = element_blank(), axis.line = element_line()) +
#   labs( x = "", y = "Power (%)", title = "Statistical Power") 
# 
# # 4.3 RSFC & replicability
# P_RSFC_rep = ggplot(data_FC, aes(x = X, y = replicability_100, linetype = D_scheme, fill = bl_scheme)) +
#   # geom_violin(position = position_dodge(width = 0.7)) + 
#   geom_boxplot(width = 0.4, position = position_dodge(width = 0.7), outlier.shape = NA) + 
#   facet_grid(. ~ X_type, space = "free_x", scales = "free_x") +
#   theme_bw() +
#   theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none", panel.border = element_blank(), axis.line = element_line()) +
#   labs( x = "", y = "Replicability (%)", title = "Probability of Replication") 


# 4.4 RSFC & Sample size needed for 80% replicability
P_RSFC_N_80 = ggplot(data_FC, aes(x = X, y = N_80_ceil, linetype = D_scheme, fill = bl_scheme)) +
  #specify position here
  geom_boxplot(width = 0.4, position = position_dodge(width = 0.7), outlier.shape = NA) + 
  # facet_grid(. ~ X_type, space = "free_x", scales = "free_x") +
  theme_bw() +
  theme( # axis.text.x = element_text(angle = 45, hjust = 1), 
        legend.position = "bottom", panel.border = element_blank(), axis.line = element_line()) +
  theme(
    axis.text.x = element_text(color="black"),
    axis.ticks = element_line(color = "black")
  ) + 
  labs(fill = "Between-subject Variability", linetype = "Within-subject Variability",
       x = "", y = "Sample Size", title = "N needed for 80% replicability") + 
  scale_y_continuous(breaks=c(0, 500, 1000, 2000, 3000),
        labels=c("0", "500", "1000", "2000", ">3000")) 

legend_other = get_legend(P_RSFC_N_80)
P_RSFC_N_80 = P_RSFC_N_80 + theme(legend.position = "none")

```

```{r, fig.height = 10, fig.width=10}
library(ggpubr)
# -------------- Combined plot ----------
# # row 1: GMV
P_1 = plot_grid(P_GMV_L_RESI,  P_GMV_N_80,  labels = c("a", "b"), nrow = 1)
P_1 = annotate_figure(P_1, left = grid::textGrob("Total GMV", vjust = 0.3, hjust = 0.3, rot = 90, gp = grid::gpar(cex = 1, fontface = "plain")) )
# # row 2: Regional GMV
P_2 = plot_grid( P_vol_L_RESI, P_vol_N_80, labels = c("c", "d"), nrow = 1)
P_2 = annotate_figure(P_2, left = grid::textGrob("Regional GMV", vjust = 0.3, hjust = 0.3, rot = 90, gp = grid::gpar(cex = 1, fontface = "plain")) )

# # row 3: regional CT
P_3 = plot_grid( P_CT_L_RESI, P_CT_N_80, labels = c("e", "f"), nrow = 1)
P_3 = annotate_figure(P_3, left = grid::textGrob("Regional CT", vjust = 0.3, hjust = 0.3, rot = 90, gp = grid::gpar(cex = 1, fontface = "plain")) )

# # row 4: RSFC
P_4 = plot_grid( P_RSFC_L_RESI, P_RSFC_N_80, labels = c("g", "h"), nrow = 1)
P_4 = annotate_figure(P_4, left = grid::textGrob("Functional connectivity", vjust = 0.3, hjust = 0.5, rot = 90, gp = grid::gpar(cex = 1, fontface = "plain")) )

P = plot_grid(P_1, 
              legend_GMV,
              NULL,
              P_2,
              P_3,
              P_4, 
              legend_other, 
              ncol = 1,
              rel_heights = c(1, 0.07, 0.05, 1, 1, 1, 0.07))

ggsave("figures_pdf/Figure_4.pdf", width = 10, height = 10, units = "in")

# P
```



# Fig. 5. The effects of using longitudinal designs in ABCD (select) & the patterns of between- and within-subject associations

```{r}
library(Hmisc)
library(ggh4x)

#  effect of using longitudinal designs -------------

# results for regional outcomes (Reginal GMV and CT)
filenames <- list.files("Results/ABCD_CS_L_analysis", pattern = "bl_and_full_data_analysis_ROI",  full.names=TRUE)

plot_data_ROI = NULL
for (i in 1:length(filenames)){
  temp = readRDS(filenames[i])
  # cols = c("Y", "X", "resi_bl", "p_val_bl", "N_bl", "resi_2nd", "p_val_2nd", "N_2nd", "gee_resi_full", "gee_p_val_full", "lmm_resi_full", "lmm_p_val_full", "N_full")
  # print(colnames(temp))
  plot_data_ROI = rbind(plot_data_ROI, temp)
}

# labels for ROI outcomes
outcome = lapply(plot_data_ROI$Y %>% as.character, FUN = function(x){
  z = strsplit(x, split = "_") %>% unlist
  return(z[2])
}) %>% unlist

plot_data_ROI$outcome_type = NA
plot_data_ROI$outcome_type[outcome == "Vol"] = "Regional Vol"
plot_data_ROI$outcome_type[outcome == "CT"] = "Regional CT"

# results for FC outcomes
plot_data_FC <- readRDS("Results/ABCD_CS_L_analysis/FC_results_bl_and_full_data_analyses.rds")
plot_data_FC$outcome_type = "FC"
plot_data_FC$X[plot_data_FC$X == "handedness_impute"] = "handedness"

# results for total GMV
plot_data_GMV <- readRDS("Results/ABCD_CS_L_analysis/bl_and_full_data_analysis_GMV.rds")
plot_data_GMV$outcome_type = "Total GMV"

# plot data
plot_data = rbind(plot_data_ROI, plot_data_FC[, colnames(plot_data_ROI)])

plot_data = subset(plot_data, X %in% c("nihtbx_cryst_fc", 
                                       "BMI",  "cbcl_scr_syn_totprob_t","bw"))


# adding labels for the covariates
plot_data$X %<>% factor(levels = c("nihtbx_cryst_fc",
                                   "cbcl_scr_syn_totprob_t",
                                   "BMI", "bw"),
                        labels = c("Crystallized Composite", 
                                   "CBCL",
                                   "BMI", "Birth Weight")
)

# ----- 1. outcome GMV -------

data_GMV = subset(plot_data_GMV, X %in% c("nihtbx_cryst_fc", 
                                       "BMI",  "cbcl_scr_syn_totprob_t","bw"))
data_GMV$X %<>% factor(levels = c("nihtbx_cryst_fc",
                                   "cbcl_scr_syn_totprob_t",
                                   "BMI", "bw"),
                        labels = c("Crystallized Composite", 
                                   "CBCL",
                                   "BMI", "Birth Weight")
                        )

# reformat plot data
# Full data
m_all = data_GMV %>% dplyr::select(X, Y, gee_resi_full, gee_resi_full_ll, gee_resi_full_ul)
m_all$m = "all"
m_all %<>% rename(resi = gee_resi_full,
               resi_ll = gee_resi_full_ll,
               resi_ul = gee_resi_full_ul)

# baseline (1st)
m1 = data_GMV %>% dplyr::select(X, Y, resi_bl, resi_bl_ll, resi_bl_ul)
m1$m = "1st"
m1 %<>% rename(resi = resi_bl,
               resi_ll = resi_bl_ll,
               resi_ul = resi_bl_ul)


data_GMV = rbind(m1, m_all)
data_GMV$m %<>% factor()
data_GMV$resi %<>% as.numeric()
data_GMV$resi_ll %<>% as.numeric()
data_GMV$resi_ul %<>% as.numeric()

p_resi_GMV = ggplot(data_GMV, aes(x = interaction(m, X), y = resi, ymin = resi_ll, ymax = resi_ul)) +
  geom_errorbar(width = .35) + 
  geom_point(size = 1.5) + 
  guides(x = "axis_nested") + 
  geom_line(aes(x = as.numeric(m), y = resi), alpha = 0.2) + 
  facet_grid(. ~ X, space = "free_x", scales = "free_x") +
  theme_classic() +
  theme(# ggh4x.axis.nesttext.x = element_text(angle = 45, hjust = 1), 
        legend.position = "none", panel.border = element_blank(), axis.line = element_line(),
        axis.line.x = element_blank(),
        # remove the facet labels
        strip.text.x = element_blank()) + 
  labs(x = " ", y = "", title = "Effect Size")

# ----- 2. outcome regional GMV -------

data_ROI_vol = subset(plot_data, outcome_type == "Regional Vol")

# reformat plot data
m_all = data_ROI_vol %>% dplyr::select(X, Y, gee_resi_full)
m_all$m = "all"
m_all %<>% rename(resi = gee_resi_full)

m1 = data_ROI_vol %>% dplyr::select(X, Y, resi_bl)
m1$m = "1st"
m1 %<>% rename(resi = resi_bl)

data_ROI_vol = rbind(m1, m_all)
data_ROI_vol$m %<>% factor()
data_ROI_vol$resi %<>% as.numeric()


# RESI
df_med = data_ROI_vol %>% group_by(X, m) %>% summarise(med = median(resi)) %>% ungroup()

p_resi_ROI_vol = ggplot(data_ROI_vol, aes(x = interaction(m, X), y = resi)) +
  geom_boxplot(width = 0.4, outlier.shape = NA)  + 
  guides(x = "axis_nested") + 
  geom_line(data = df_med, aes(x = as.numeric(m), y = med), alpha = 0.4) + 
  facet_grid(. ~ X, space = "free_x", scales = "free_x") +
  theme_classic() +
  theme(# ggh4x.axis.nesttext.x = element_text(angle = 45, hjust = 1), 
        legend.position = "none", panel.border = element_blank(), axis.line = element_line(),
        axis.line.x = element_blank(),
        # remove the facet labels
        strip.text.x = element_blank()) + 
  labs(x = " ", y = "", title = "Effect Size")

# ----- 3. outcome regional CT -------

data_ROI_CT = subset(plot_data, outcome_type == "Regional CT")

# reformat plot data
m_all = data_ROI_CT %>% dplyr::select(X, Y, gee_resi_full)
m_all$m = "all"
m_all %<>% rename(resi = gee_resi_full)

m1 = data_ROI_CT %>% dplyr::select(X, Y, resi_bl)
m1$m = "1st"
m1 %<>% rename(resi = resi_bl)

data_ROI_CT = rbind(m1, m_all)
data_ROI_CT$m %<>% factor()
data_ROI_CT$resi %<>% as.numeric()

# RESI
df_med = data_ROI_CT %>% group_by(X, m) %>% summarise(med = median(resi)) %>% ungroup()

p_resi_ROI_CT = ggplot(data_ROI_CT, aes(x = interaction(m, X), y = resi)) +
  geom_boxplot(width = 0.4, outlier.shape = NA)  + 
  guides(x = "axis_nested") + 
  geom_line(data = df_med, aes(x = as.numeric(m), y = med), alpha = 0.4) + 
  facet_grid(. ~ X, space = "free_x", scales = "free_x") +
  theme_classic() +
  theme(# ggh4x.axis.nesttext.x = element_text(angle = 45, hjust = 1), 
        legend.position = "none", panel.border = element_blank(), axis.line = element_line(),
        axis.line.x = element_blank(),
        # remove the facet labels
        strip.text.x = element_blank()) + 
  labs(x = " ", y = "", title = "Effect Size")

# ------ 4. outcome: RSFC ---------
data_FC = subset(plot_data, outcome_type == "FC")

# reformat plot data
m_all = data_FC %>% dplyr::select(X, Y, gee_resi_full)
m_all$m = "all"
m_all %<>% rename(resi = gee_resi_full)

m1 = data_FC %>% dplyr::select(X, Y, resi_bl)
m1$m = "1st"
m1 %<>% rename(resi = resi_bl)

data_FC = rbind(m1, m_all)
data_FC$m %<>% factor()
data_FC$resi %<>% as.numeric()

# RESI
df_med = data_FC %>% group_by(X, m) %>% summarise(med = median(resi)) %>% ungroup()

p_resi_FC = ggplot(data_FC, aes(x = interaction(m, X), y = resi)) +
  geom_boxplot(width = 0.4, outlier.shape = NA)  + 
  guides(x = "axis_nested") + 
  geom_line(data = df_med, aes(x = as.numeric(m), y = med), alpha = 0.4) + 
  facet_grid(. ~ X, space = "free_x", scales = "free_x") +
  theme_classic() +
  theme(# ggh4x.axis.nesttext.x = element_text(angle = 45, hjust = 1), 
        legend.position = "none", panel.border = element_blank(), axis.line = element_line(),
        axis.line.x = element_blank(),
        # remove the facet labels
        strip.text.x = element_blank()) + 
  labs(x = " ", y = "", title = "Effect Size")

# b. The patterns of between- and within-subject associations. ----------

plot_data_1 <- readRDS("Results/CS_and_L_effects/ROI_GMV_nonbrain_covaraites_CS_L_effect_estimates.rds")
plot_data_1$Y_type = "Regional GMV"
plot_data_2 <- readRDS("Results/CS_and_L_effects/FC_nonbrain_covaraites_CS_L_effect_estimates.rds")
plot_data_2$Y_type = "FC"
# plot_data_3 <-  readRDS("Results/CS_and_L_effects/GMV_nonbrain_covaraites_CS_L_effect_estimates.rds")
# plot_data_3$Y_type = "Total GMV"

plot_data = rbind(plot_data_1, plot_data_2)
plot_data$diff = with(plot_data, beta_CS - beta_L)
plot_data$Y_type %<>% factor(levels = c("Regional GMV", "FC"))

# # adding labels for the covariates
# plot_data$X %<>% factor(levels = c("nihtbx_totalcomp_fc", "nihtbx_cardsort_fc", "nihtbx_fluidcomp_fc", 
#                                    "nihtbx_cryst_fc", "nihtbx_flanker_fc", "nihtbx_list_fc", "nihtbx_pattern_fc", 
#                                    "nihtbx_picture_fc",  "nihtbx_picvocab_fc",  "nihtbx_reading_fc",
#                                    "cbcl_scr_syn_totprob_t",
#                                    "BMI", "bw", "handedness"),
#                         labels = c("Cgntn Ttl Cmpst Scr", "Dmnsnl Chng Crd Srt", "Cgntn Fld Cmpst",
#                                    "Crystllzd Cmpst", "Flnkr Inhbtry Ctrl", "Lst Srtng Wrkng Mmry", "Pttrn Cmprsn Prcssng Spd",
#                                    "Pctr Sqnc Mmry", "Pctr Vcblry", "Orl Rdng Rcgntn",
#                                    "CBCL",
#                                     "BMI", "Birth Weight", "Handedness")
# )

p1_ROI_GMV = ggplot(subset(plot_data, Y_type == "Regional GMV"), aes(x = beta_CS, y = beta_L)) + 
  geom_point(alpha = 0.2) + theme_classic() + facet_grid(~ Y_type) + ylim(-50, 50) + xlim(-50, 50) + 
  geom_hline(yintercept = 0, linetype = "dashed") + 
  geom_vline(xintercept = 0, linetype = "dashed") + 
  labs(x = expression(hat(beta)[b]), y = expression(hat(beta)[w]))
p2_FC = ggplot(subset(plot_data, Y_type == "FC"), aes(x = beta_CS * 1000, y = beta_L* 1000)) + 
  geom_point(alpha = 0.2) + theme_classic() + facet_grid(~ Y_type) + ylim(-4, 4) + xlim(-4, 4) + 
  geom_hline(yintercept = 0, linetype = "dashed") + 
  geom_vline(xintercept = 0, linetype = "dashed") + 
  labs(x = expression(hat(beta)[b] %*% 1000), y = expression(hat(beta)[w]%*% 1000))

P2 = plot_grid(NULL, p1_ROI_GMV, NULL, p2_FC, NULL, rel_widths = c(0.4, 1, 0.4, 1, 0.4), nrow = 1, labels = c("", "e", "", "f", ""))

```



```{r, fig.height = 8, fig.width=10}
library(ggpubr)

P1 = plot_grid(p_resi_GMV + labs(title = "Total GMV", y = "RESI") + theme(axis.text.x = element_text(color="black"), axis.ticks = element_line(color = "black")),
              p_resi_ROI_vol + labs(title = "Regional GMV", y = "RESI") + theme(axis.text.x = element_text(color="black"), axis.ticks = element_line(color = "black")),
              p_resi_ROI_CT + labs(title = "Regional CT", y = "RESI") + theme(axis.text.x = element_text(color="black"), axis.ticks = element_line(color = "black")),
              p_resi_FC + labs(title = "Functional connectivity", y = "RESI") + theme(axis.text.x = element_text(color="black"), axis.ticks = element_line(color = "black")),
              labels = "auto", ncol = 2
              )
# P2 = plot_grid(P2, labels = "e")
P = plot_grid(P1, P2, ncol = 1, rel_heights = c(2, 1.2))

ggsave("figures_pdf/Figure_5.pdf", width = 10, height = 8, units = "in")

```



# Extended Data Figures

## ED Fig. 1. Resampling schemes in UKB and ADNI; Region-specific improvements in the RESI and power in UKB

```{r}
# ---------- UKB -----------
# U-shaped
x = seq(50, 78, by = 0.01)
a = x -  mean(range(x))
y = (a^2 + 0.05 * max(a^2)) / (1.05*max(a^2 ))
s1 = data.frame(x, y, bl_scheme = "U-shaped")
# Uniform
x = seq(50, 78, by = 0.01)
y = rep(0.5, length(x))
s0 = data.frame(x, y, bl_scheme = "Uniform")
# Bell_shaped
x = seq(50, 78, by = 0.01)
y = - s1$y + 1.03
s2 = data.frame(x, y, bl_scheme = "Bell-shaped")

plot_data = rbind(s0, s1, s2)
plot_data$bl_scheme %<>% factor(levels = c("Bell-shaped", "Uniform", "U-shaped"))

p_sampling_UKB = ggplot(data = plot_data, aes(x = x, y = y, group = bl_scheme, col = bl_scheme)) + 
  geom_line(linewidth = 1.5) + 
  theme_classic() + 
  scale_x_continuous(breaks=c(50, 60, 70, 78),
        labels=c("<50", "60", "70", ">78")) +
  labs(title = "", x = "Age (in years)", y = "Relative Probability") + 
  labs(col = "Sampling scheme")

# P_sampling_UKB = plot_grid(NULL, p_sampling_UKB, NULL, rel_widths = c(0.65, 1, 0.65), nrow = 1)

L_UKB = get_legend(p_sampling_UKB)
p_sampling_UKB = p_sampling_UKB + theme(legend.position = "none")

# -------- ADNI -------------

# bl schemes
x = seq(65, 85, by = 0.01)
a = x -  mean(range(x))
y = (a^2 + 0.05 * max(a^2)) / (1.05*max(a^2 ))
s1 = data.frame(x, y, bl_scheme = "U-shaped")
# Uniform
y = rep(0.5, length(x))
s0 = data.frame(x, y, bl_scheme = "Uniform")
# Bell_shaped
y = - s1$y + 1.05
s2 = data.frame(x, y, bl_scheme = "Bell-shaped")

plot_data = rbind(s0, s1, s2)
plot_data$bl_scheme %<>% factor(levels = c("Bell-shaped", "Uniform", "U-shaped"))
p_sampling_ADNI_bl = ggplot(data = plot_data, aes(x = x, y = y, group = bl_scheme, col = bl_scheme)) + 
            geom_line(linewidth = 1.5) + 
            theme_classic() +
            scale_x_continuous(breaks=c(65, 70, 75, 80, 85),
                  labels=c("< 65", "70", "75", "80", "> 85")) +
            labs(title = "", x = "Baseline age (in years)", y = "Relative Probability") + 
            labs(col = "Between-subject \nsampling scheme")

L_ADNI_bl = get_legend(p_sampling_ADNI_bl)
p_sampling_ADNI_bl = p_sampling_ADNI_bl + theme(legend.position = "none")

# D schemes
## 1 - increasing
x = seq(0, 5, by = 0.01)
y = (exp(x) + 0.05 * exp(5) )/ max(exp(x) + 0.05 * exp(5) )
s1 = data.frame(x, y, D_scheme = "Increasing")
## 0 - uniform
y = rep(0.5, length(x))
s0 = data.frame(x, y, D_scheme = "Uniform")
## 2 - decreasing
y = (exp(-x) + 0.05 )/ max(exp(-x) + 0.05  )
s2 = data.frame(x, y, D_scheme = "Decreasing")

plot_data = rbind(s0, s1, s2)
plot_data$D_scheme %<>% factor(levels = c("Decreasing", "Uniform", "Increasing"))

p_sampling_ADNI_D = ggplot(data = plot_data, aes(x = x, y = y, group = D_scheme, col = D_scheme)) + 
            geom_line(linewidth = 1.5) + 
            theme_classic() + 
            scale_x_continuous(breaks=c(0:5),
                  labels=c("0", "1", "2", "3", "4", "> 5")) +
            ylim(0, 1) + 
            labs(title = "", x = "Change in age (in years)", y = "Relative Probability") + 
            labs(col = "Within-subject\nsampling scheme")
L_ADNI_D = get_legend(p_sampling_ADNI_D)
p_sampling_ADNI_D = p_sampling_ADNI_D + theme(legend.position = "none")


P_sampling = plot_grid(p_sampling_UKB, L_UKB, p_sampling_ADNI_bl, L_ADNI_bl, p_sampling_ADNI_D, L_ADNI_D, nrow = 1, rel_widths = c(1, 0.5, 1, 0.5, 1, 0.5),
                       labels = c("a", "", "b", "", "c", ""))

# region-specific improvement in UKB ----------------

plot_data <- readRDS("Results/resamp_ROI_measures/resamp_ROI_UKB.rds")

plot_data$label = lapply(plot_data$ROI %>% strsplit(split = "_"), FUN = function(x) {paste0(x[1], "_", x[3])}) %>% unlist
plot_data %<>% arrange(label)

plot_data$scheme %<>% factor(levels = c(2, 0, 1), labels = c("Bell-shaped", "Uniform", "U-shaped"))

plot_data = subset(plot_data, N == 300 & scheme %in% c("Bell-shaped", "U-shaped"))

plot_data$measure = lapply(plot_data$ROI, FUN = function(x) {
                                          y = unlist(strsplit(x, split = "_"))[2]
                                          return(y)
                                        }) %>% unlist

# derive the change in ES and power
plot_data = plot_data %>% group_by(measure, label) %>% summarise(diff_ES = mean_RESI_age[scheme == "U-shaped"] - mean_RESI_age[scheme == "Bell-shaped"],
                                                                 diff_power = power[scheme == "U-shaped"] - power[scheme == "Bell-shaped"],
                                                                 diff_rep = replicability[scheme == "U-shaped"] - replicability[scheme == "Bell-shaped"])

# ------- ROI Vol ------------
## improvement in RESI
plot_data_vol = subset(plot_data, measure == "Vol")

p_diff_ES_vol <- ggseg(plot_data_vol, atlas = dk, 
                    colour = "black",
                    size = .1, 
                    position = "dispersed",
                    mapping = aes(fill = diff_ES )) +
                scale_fill_viridis_c(name = "Change in RESI", option = "viridis", breaks = c(0, 0.1, 0.2),
                                     limits = c(-0.01, 0.2)) +
                theme(legend.position = "bottom", axis.title.x=element_blank(), axis.text = element_text(family = "sans"), text = element_text(family = "sans")) +
                labs(title = "  Regional GMV")

## improvement in replicability
p_diff_rep_vol <- ggseg(plot_data_vol, atlas = dk, 
                    colour = "black",
                    size = .1, 
                    position = "dispersed",
                    mapping = aes(fill = diff_rep * 100 )) +
                scale_fill_viridis_c(name = "Change in replicability (%)", option = "plasma", limits = c(-2, 60)) +
                theme(legend.position = "bottom", axis.title.x=element_blank(), axis.text = element_text(family = "sans"), text = element_text(family = "sans")) +
                labs(title = "")
p_ROI_vol = plot_grid(p_diff_ES_vol, p_diff_rep_vol, ncol = 1)

# ------- ROI CT ------------
## improvement in RESI
plot_data_CT = subset(plot_data, measure == "CT")

p_diff_ES_CT <- ggseg(plot_data_CT, atlas = dk, 
                    colour = "black",
                    size = .1, 
                    position = "dispersed",
                    mapping = aes(fill = diff_ES )) +
                scale_fill_viridis_c(name = "Change in RESI", option = "viridis", breaks = c(0, 0.1, 0.2),
                                     limits = c(-0.01, 0.2)) +
                theme(legend.position = "bottom", axis.title.x=element_blank(), axis.text = element_text(family = "sans"), text = element_text(family = "sans")) +
                labs(title = "  Regional CT")

## improvement in replicability
p_diff_rep_CT <- ggseg(plot_data_CT, atlas = dk, 
                    colour = "black",
                    size = .1, 
                    position = "dispersed",
                    mapping = aes(fill = diff_rep * 100 )) +
                scale_fill_viridis_c(name = "Change in replicability (%)", option = "plasma", limits = c(-2, 60)) +
                theme(legend.position = "bottom", axis.title.x=element_blank(), axis.text = element_text(family = "sans"), text = element_text(family = "sans") ) +
                labs(title = "")

p_ROI_CT = plot_grid(p_diff_ES_CT, p_diff_rep_CT, ncol = 1)

P_ROI = plot_grid(p_ROI_vol, p_ROI_CT, nrow = 1, labels = c("d", "e"), vjust = 2, hjust = 0)
# P = ggarrange(p_diff_ES_vol, p_diff_rep_vol, p_diff_ES_CT, p_diff_rep_CT,
#               labels = c("a", "", "b", ""), ncol = 1)

P = plot_grid(P_sampling, P_ROI, ncol = 1, rel_heights = c(1, 1.5))

ggsave("figures_pdf/ED_Figure_1.pdf", plot = P, width = 16, height = 9, units = "in")

```



## ED Fig. 2. Sampling schemes on other covariates in ABCD (all)
```{r}
library(Hmisc)

# ------ global & regional brain outcomes -----------
filenames <- list.files("Results/ABCD_samp_other_covariate_ROI_global", pattern = "nsim1000", full.names=TRUE)

col_names = readRDS("Results/ABCD_samp_other_covariate_ROI_global/samp_nihtbx_totalcomp_fc_nsim1000.rds") %>% colnames

obj = list()
for (i in 1:length(filenames)){
  temp = readRDS(filenames[i])
  obj[[i]] = temp[, col_names]
}

plot_data = do.call(rbind, obj)

# check sample size
plot_data$N %>% unique
# check schemes
plot_data$bl_scheme %>% unique
plot_data$D_scheme %>% unique

plot_data = subset(plot_data, X %in% c("nihtbx_totalcomp_fc", "nihtbx_cardsort_fc", "nihtbx_fluidcomp_fc",
                                       "nihtbx_cryst_fc", "nihtbx_flanker_fc", "nihtbx_list_fc", "nihtbx_pattern_fc",
                                       "nihtbx_picture_fc",  "nihtbx_picvocab_fc",  "nihtbx_reading_fc",
                                       "BMI", "cbcl_scr_syn_totprob_t", "bw", "handedness") )

# adding labels for sampling schemes
plot_data$bl_scheme %<>% factor(levels = c(2, 1), labels = c("Smaller (Bell-shaped)", "Larger (U-shaped)"))
plot_data$D_scheme %<>% factor(levels = c(2, 1), labels = c("Smaller (Bell-shaped)", "Larger (U-shaped)"))

# clean 
plot_data$D_scheme[plot_data$X %in% c("bw", "handedness", "nihtbx_totalcomp_fc", "nihtbx_cardsort_fc", "nihtbx_fluidcomp_fc") ] = "Smaller (Bell-shaped)"


plot_data$X_type = ifelse(plot_data$X %in% c("nihtbx_totalcomp_fc", "nihtbx_cardsort_fc", "nihtbx_fluidcomp_fc"), "Cross-sectional", "Longitudinal")

# adding labels for the covariates
plot_data$X %<>% factor(levels = c("nihtbx_totalcomp_fc", "nihtbx_cardsort_fc", "nihtbx_fluidcomp_fc", 
                                   "nihtbx_cryst_fc", "nihtbx_flanker_fc", "nihtbx_list_fc", "nihtbx_pattern_fc", 
                                   "nihtbx_picture_fc",  "nihtbx_picvocab_fc",  "nihtbx_reading_fc",
                                   "cbcl_scr_syn_totprob_t",
                                   "BMI", "bw", "handedness"),
                        labels = c("Cgntn Ttl Cmpst Scr", "Dmnsnl Chng Crd Srt", "Cgntn Fld Cmpst",
                                   "Crystllzd Cmpst", "Flnkr Inhbtry Ctrl", "Lst Srtng Wrkng Mmry", "Pttrn Cmprsn Prcssng Spd",
                                   "Pctr Sqnc Mmry", "Pctr Vcblry", "Orl Rdng Rcgntn",
                                   "CBCL",
                                   "BMI", "Birth Weight", "Handedness")
)

# labels for ROI outcomes
outcome = lapply(plot_data$Y %>% as.character, FUN = function(x){
  z = strsplit(x, split = "_") %>% unlist
  return(z[2])
}) %>% unlist

plot_data$outcome_type = NA
plot_data$outcome_type[outcome == "Vol"] = "Regional Vol"
plot_data$outcome_type[outcome == "CT"] = "Regional CT"

# CIs for Power and Replicability
## m = 2
plot_data$power_100 = plot_data$power * 100
plot_data$power_100_ll = binconf(plot_data$power * 1000, n = 1000, method = "wilson")[, 2] * 100
plot_data$power_100_ul = binconf(plot_data$power * 1000, n = 1000, method = "wilson")[, 3] * 100

plot_data$replicability_100 = plot_data$replicability * 100
plot_data$replicability_100_ll = binconf(plot_data$replicability * 1000, n = 1000, method = "wilson")[, 2] * 100
plot_data$replicability_100_ul = binconf(plot_data$replicability * 1000, n = 1000, method = "wilson")[, 3] * 100

## m = 1
plot_data$power_m1_100 = plot_data$power_m1 * 100
plot_data$power_m1_100_ll[!is.na(plot_data$power_m1)] = binconf(plot_data$power_m1[!is.na(plot_data$power_m1)] * 1000, n = 1000, method = "wilson")[, 2] * 100
plot_data$power_m1_100_ul[!is.na(plot_data$power_m1)] = binconf(plot_data$power_m1[!is.na(plot_data$power_m1)] * 1000, n = 1000, method = "wilson")[, 3] * 100

plot_data$replicability_m1_100 = plot_data$replicability_m1 * 100
plot_data$replicability_m1_100_ll[!is.na(plot_data$replicability_m1)] = binconf(plot_data$replicability_m1[!is.na(plot_data$replicability_m1)] * 1000, n = 1000, method = "wilson")[, 2] * 100
plot_data$replicability_m1_100_ul[!is.na(plot_data$replicability_m1)] = binconf(plot_data$replicability_m1[!is.na(plot_data$replicability_m1)] * 1000, n = 1000, method = "wilson")[, 3] * 100



# calculate: sample size needed for 80% replicability
plot_data$N_80 = lapply(plot_data$gee_L_RESI, FUN = function(S) {
  df = 5 # total number of parameters in the model
  f = function(n) {pf(qf(0.95, df1 = 1, df2= n - df), df1 = 1, df2 = n - df, ncp = S^2*n, lower.tail = FALSE) - sqrt(0.8)}
  N = uniroot(f, lower = 6, upper = 1000000)$root
  return(N)
} ) %>% unlist

plot_data$N_80_ceil = ifelse(plot_data$N_80 >= 3000, 3000, plot_data$N_80)


# calculate: the reduction factor for the sample sizes needed for 80% power by increasing between-subject variability (comparing with between-subject variability == "smaller & within-subject variability = "smaller)
plot_data %<>% arrange(Y, X)
plot_data %<>% group_by(Y, X) %>%
  mutate(red_factor_N_80 = N_80[bl_scheme == "Smaller (Bell-shaped)" & D_scheme == "Smaller (Bell-shaped)"] / N_80)

# calculate: the increase factor for the ES by increasing the between-subject variability (comparing with between-subject variability == "smaller & within-subject variability = "smaller)
plot_data %<>% group_by(Y, X) %>% mutate(inc_factor_L_RESI = gee_L_RESI / gee_L_RESI[bl_scheme == "Smaller (Bell-shaped)" & D_scheme == "Smaller (Bell-shaped)"])

# ----- 1. outcome GMV -------
data_GMV = subset(plot_data, Y == "GMV_10000_combat")

# adding labels for outcome
data_GMV$Y_lab = "Outcome: Global GMV"

# 1.1 GMV & L-RESI
P_GMV_L_RESI = ggplot(data_GMV, aes(x = X, y = gee_L_RESI, ymin = gee_L_RESI_ll, ymax = gee_L_RESI_ul, col = bl_scheme, group = interaction(bl_scheme, D_scheme))) + 
  #specify position here
  geom_errorbar(width = .35, position = position_dodge(width = 0.5)) +
  geom_point(aes(shape = D_scheme),  position=position_dodge(width = 0.5)) + 
  facet_grid(. ~ X_type, space = "free_x", scales = "free_x") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), 
        legend.position = "none", panel.border = element_blank(), axis.line = element_line()) +
  theme(
    axis.text.x = element_text(color="black"),
    axis.ticks = element_line(color = "black")
  ) + 
  labs(col = "Between-subject Variability", linetype = "Within-subject Variability", x = "", y = "RESI", title = "Standardized effect size")

# 1.2 GMV & power
# P_GMV_power = ggplot(data_GMV, aes(x = X, y = power_100, ymin = power_100_ll, ymax = power_100_ul, linetype = D_scheme, col = bl_scheme)) + 
#   #specify position here
#   geom_errorbar(width = .5, position = position_dodge(width = 0.5)) +
#   geom_point(size = 1, position=position_dodge(width = 0.5)) + 
#   facet_grid(. ~ X_type, space = "free_x", scales = "free_x") +
#   theme_bw() +
#   theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none", panel.border = element_blank(), axis.line = element_line()) +
#   labs(x = "", y = "Power (%)", title = "Statistical Power") 
# 
# # 1.3 GMV & replicability
# P_GMV_rep = ggplot(data_GMV, aes(x = X, y = replicability_100, ymin = replicability_100_ll, ymax = replicability_100_ul, linetype = D_scheme, col = bl_scheme)) +
#   #specify position here
#   geom_errorbar(width = .5, position = position_dodge(width = 0.5)) +
#   geom_point(size = 1, position=position_dodge(width = 0.5)) + 
#   facet_grid(. ~ X_type, space = "free_x", scales = "free_x") +
#   theme_bw() +
#   theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none", panel.border = element_blank(), axis.line = element_line()) +
#   labs(x = "", y = "Replicability (%)", title = "Probability of Replication") 

# 1.4 GMV & Sample size needed for 80% replicability
P_GMV_N_80 = ggplot(data_GMV, aes(x = X, y = N_80_ceil, col = bl_scheme)) +
  #specify position here
  # geom_errorbar(width = .5, position = position_dodge(width = 0.5)) +
  geom_point(aes(shape = D_scheme), position=position_dodge(width = 0.5)) + 
  facet_grid(. ~ X_type, space = "free_x", scales = "free_x") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), 
        legend.position = "bottom", panel.border = element_blank(), axis.line = element_line()) +
  theme(
    axis.text.x = element_text(color="black"),
    axis.ticks = element_line(color = "black")
  ) + 
  scale_y_continuous(breaks=c(0, 500, 1000, 2000, 3000),
        labels=c("0", "500", "1000", "2000", ">3000")) + 
  labs(col = "Between-subject Variability", shape = "Within-subject Variability",
       x = "", y = "Sample size", title = "N needed for 80% replicability") 

legend_GMV = get_legend(P_GMV_N_80)
P_GMV_N_80 = P_GMV_N_80 + theme(legend.position = "none")


# ------ 2. outcome: ROI GMV -------------

# 2.1 ROI Vol & L-RESI
data_ROI_vol = subset(plot_data, outcome_type == "Regional Vol")

data_ROI_vol$Y_lab = "Outcome: Regional GMV"

P_vol_L_RESI = ggplot(data_ROI_vol, aes(x = X, y = gee_L_RESI, linetype = D_scheme, fill = bl_scheme)) +
  # geom_violin(position = position_dodge(width = 0.7)) + 
  geom_boxplot(width = 0.4, position = position_dodge(width = 0.7), outlier.shape = NA) + 
  facet_grid(. ~ X_type, space = "free_x", scales = "free_x") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), 
        legend.position = "none", panel.border = element_blank(), axis.line = element_line()) +
  theme(
    axis.text.x = element_text(color="black"),
    axis.ticks = element_line(color = "black")
  ) + 
  labs( x = "", y = "RESI", title = "Standardized effect size") 


legend_ROI = get_legend(P_vol_L_RESI)
P_vol_L_RESI = P_vol_L_RESI + theme(legend.position = "none")

# 
# # 2.2 ROI Vol & power
# P_vol_power = ggplot(data_ROI_vol, aes(x = X, y = power_100, linetype = D_scheme, fill = bl_scheme)) +
#   # geom_violin(position = position_dodge(width = 0.7)) + 
#   geom_boxplot(width = 0.4, position = position_dodge(width = 0.7), outlier.shape = NA) + 
#   facet_grid(. ~ X_type, space = "free_x", scales = "free_x") +
#   theme_bw() +
#   theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none", panel.border = element_blank(), axis.line = element_line()) +
#   labs( x ="", y = "Power (%)", title = "Statistical Power") 
# 
# 
# # 2.3 ROI Vol & replicability
# P_vol_rep = ggplot(data_ROI_vol, aes(x = X, y = replicability_100, linetype = D_scheme, fill = bl_scheme)) +
#   # geom_violin(position = position_dodge(width = 0.7)) + 
#   geom_boxplot(width = 0.4, position = position_dodge(width = 0.7), outlier.shape = NA) + 
#   facet_grid(. ~ X_type, space = "free_x", scales = "free_x") +
#   theme_bw() +
#   theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none", panel.border = element_blank(), axis.line = element_line()) +
#   labs( x = "", y = "Replicability (%)", title = "Probability of Replication" ) 


# 2.4 ROI & Sample size needed for 80% replicability
P_vol_N_80 = ggplot(data_ROI_vol, aes(x = X, y = N_80_ceil, linetype = D_scheme, fill = bl_scheme)) +
  #specify position here
  geom_boxplot(width = 0.4, position = position_dodge(width = 0.7), outlier.shape = NA) + 
  facet_grid(. ~ X_type, space = "free_x", scales = "free_x") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), 
        legend.position = "none", panel.border = element_blank(), axis.line = element_line()) +
  theme(
    axis.text.x = element_text(color="black"),
    axis.ticks = element_line(color = "black")
  ) + 
  scale_y_continuous(breaks=c(0, 500, 1000, 2000, 3000),
        labels=c("0", "500", "1000", "2000", ">3000")) +
  labs(x = "", y = "Sample size", title = "N needed for 80% replicability")


# ------ 3. outcome: ROI CT ---------
data_ROI_CT = subset(plot_data, outcome_type == "Regional CT")
data_ROI_CT$Y_lab = "Outcome: Regional CT"

# 3.1 CT & L-RESI
P_CT_L_RESI = ggplot(data_ROI_CT, aes(x = X, y = gee_L_RESI, linetype = D_scheme, fill = bl_scheme)) +
  # geom_violin(position = position_dodge(width = 0.7)) + 
  geom_boxplot(width = 0.4, position = position_dodge(width = 0.7), outlier.shape = NA) + 
  facet_grid(. ~ X_type, space = "free_x", scales = "free_x") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), 
        legend.position = "none", panel.border = element_blank(), axis.line = element_line()) +
  theme(
    axis.text.x = element_text(color="black"),
    axis.ticks = element_line(color = "black")
  ) + 
  labs( x = "", y = "RESI", title = "Standardized effect size")


# # 3.2 ROI CT & power
# P_CT_power = ggplot(data_ROI_CT, aes(x = X, y = power_100, linetype = D_scheme, fill = bl_scheme)) +
#   # geom_violin(position = position_dodge(width = 0.7)) + 
#   geom_boxplot(width = 0.4, position = position_dodge(width = 0.7), outlier.shape = NA) + 
#   facet_grid(. ~ X_type, space = "free_x", scales = "free_x") +
#   theme_bw() +
#   theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none", panel.border = element_blank(), axis.line = element_line()) +
#   labs( x = "", y = "Power (%)", title = "Statistical Power") 
# 
# 
# # 3.3 ROI CT & replicability
# P_CT_rep = ggplot(data_ROI_CT, aes(x = X, y = replicability_100, linetype = D_scheme, fill = bl_scheme)) +
#   # geom_violin(position = position_dodge(width = 0.7)) + 
#   geom_boxplot(width = 0.4, position = position_dodge(width = 0.7), outlier.shape = NA) + 
#   facet_grid(. ~ X_type, space = "free_x", scales = "free_x") +
#   theme_bw() +
#   theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none", panel.border = element_blank(), axis.line = element_line()) +
#   labs( x = "", y = "Replicability (%)", title = "Probability of Replication") +
#   ylim(0, 25)


# 3.4 ROI CT & Sample size needed for 80% replicability
P_CT_N_80 = ggplot(data_ROI_CT, aes(x = X, y = N_80_ceil, linetype = D_scheme, fill = bl_scheme)) +
  #specify position here
  geom_boxplot(width = 0.4, position = position_dodge(width = 0.7), outlier.shape = NA) + 
  facet_grid(. ~ X_type, space = "free_x", scales = "free_x") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), 
        legend.position = "none", panel.border = element_blank(), axis.line = element_line()) +
  theme(
    axis.text.x = element_text(color="black"),
    axis.ticks = element_line(color = "black")
  ) + 
  labs(x = "", y = "Sample size", title = "N needed for 80% replicability") +
  scale_y_continuous(breaks=c(0, 500, 1000, 2000, 3000),
        labels=c("0", "500", "1000", "2000", ">3000")) 


# ---------------- outcomes: FC -------------------

filenames <- list.files("Results/ABCD_samp_other_covariate_FC", pattern = ".rds",  full.names=TRUE)

plot_data_1 = plot_data_2 = NULL
var_list_1 = c("N", "nboot", "bl_scheme", "D_scheme", "X", "Y", "L_RESI", "L_RESI_ll", "L_RESI_ul")
var_list_2 = c("N", "nboot", "bl_scheme", "D_scheme", "X", "Y", "gee_L_RESI", "gee_L_RESI_ll", "gee_L_RESI_ul")
for (i in 1:length(filenames)){
  temp = readRDS(filenames[i])
  if (unique(temp$X) %in% c("nihtbx_totalcomp_fc", "nihtbx_list_fc", "nihtbx_cardsort_fc", "nihtbx_fluidcomp_fc", "handedness")){
    plot_data_1 = rbind(plot_data_1, temp[, var_list_1])
  } else {
    plot_data_2 = rbind(plot_data_2, temp[, var_list_2])
  }
}

plot_data_2 %<>% rename(L_RESI = gee_L_RESI, L_RESI_ll = gee_L_RESI_ll, L_RESI_ul = gee_L_RESI_ul)

plot_data = rbind(plot_data_1, plot_data_2)

# check sample size
plot_data$N %>% unique
# check schemes
plot_data$bl_scheme %>% unique
plot_data$D_scheme %>% unique

plot_data = subset(plot_data, bl_scheme %in% c(2, 1) )

plot_data = subset(plot_data, X %in% c("nihtbx_totalcomp_fc", "nihtbx_cardsort_fc", "nihtbx_fluidcomp_fc",
                                       "nihtbx_cryst_fc", "nihtbx_flanker_fc", "nihtbx_list_fc", "nihtbx_pattern_fc",
                                       "nihtbx_picture_fc",  "nihtbx_picvocab_fc",  "nihtbx_reading_fc",
                                       "BMI",  "cbcl_scr_syn_totprob_t","bw", "handedness"))

# adding labels for sampling schemes
plot_data$bl_scheme %<>% factor(levels = c(2, 1), labels = c("Smaller (Bell-shaped)", "Larger (U-shaped)"))
plot_data$D_scheme %<>% factor(levels = c(2, 1), labels = c("Smaller (Bell-shaped)", "Larger (U-shaped)"))

# clean 
plot_data$D_scheme[plot_data$X %in% c("bw", "handedness", "nihtbx_totalcomp_fc", "nihtbx_list_fc", "nihtbx_cardsort_fc", "nihtbx_fluidcomp_fc") ] = "Smaller (Bell-shaped)"


plot_data$X_type = ifelse(plot_data$X %in% c("nihtbx_totalcomp_fc", "nihtbx_list_fc", "nihtbx_cardsort_fc", "nihtbx_fluidcomp_fc"), "Cross-sectional", "Longitudinal")

# adding labels for the covariates
plot_data$X %<>% factor(levels = c("nihtbx_totalcomp_fc", "nihtbx_cardsort_fc", "nihtbx_fluidcomp_fc", 
                                   "nihtbx_cryst_fc", "nihtbx_flanker_fc", "nihtbx_list_fc", "nihtbx_pattern_fc", 
                                   "nihtbx_picture_fc",  "nihtbx_picvocab_fc",  "nihtbx_reading_fc",
                                   "cbcl_scr_syn_totprob_t",
                                   "BMI", "bw", "handedness"),
                        labels = c("Cgntn Ttl Cmpst Scr", "Dmnsnl Chng Crd Srt", "Cgntn Fld Cmpst",
                                   "Crystllzd Cmpst", "Flnkr Inhbtry Ctrl", "Lst Srtng Wrkng Mmry", "Pttrn Cmprsn Prcssng Spd",
                                   "Pctr Sqnc Mmry", "Pctr Vcblry", "Orl Rdng Rcgntn",
                                   "CBCL",
                                   "BMI", "Birth Weight", "Handedness")
)


# ------ 3. outcome: FC ---------
data_FC = plot_data

# calculate: sample size needed for 80% replicability
data_FC$N_80 = lapply(data_FC$L_RESI, FUN = function(S) {
  df = 8 # total num of parameters in the model
  f = function(n) {pf(qf(0.95, df1 = 1, df2= n - df), df1 = 1, df2 = n - df, ncp = S^2*n, lower.tail = FALSE) - sqrt(0.8)}
  N = uniroot(f, lower = 9, upper = 1000000)$root
  return(N)
} ) %>% unlist

data_FC$N_80_ceil = ifelse(data_FC$N_80 >= 3000, 3000, data_FC$N_80)

# calculate: the reduction factor for the sample sizes needed for 80% power by increasing between-subject variability (comparing with between-subject variability == "smaller & within-subject variability = "smaller)
data_FC %<>% arrange(Y, X)
data_FC %<>% group_by(Y, X) %>% 
  mutate(red_factor_N_80 = N_80[bl_scheme == "Smaller (Bell-shaped)" & D_scheme == "Smaller (Bell-shaped)"] / N_80) 

# calculate: the increase factor for the ES by increasing the between-subject variability (comparing with between-subject variability == "smaller & within-subject variability = "smaller)
data_FC %<>% group_by(Y, X) %>% mutate(inc_factor_L_RESI = L_RESI / L_RESI[bl_scheme == "Smaller (Bell-shaped)" & D_scheme == "Smaller (Bell-shaped)"]) 


# 4.1 RSFC & L-RESI
P_RSFC_L_RESI = ggplot(data_FC, aes(x = X, y = L_RESI, linetype = D_scheme, fill = bl_scheme)) +
  # geom_violin(position = position_dodge(width = 0.7)) + 
  geom_boxplot(width = 0.4, position = position_dodge(width = 0.7), outlier.shape = NA) + 
  facet_grid(. ~ X_type, space = "free_x", scales = "free_x") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), 
        legend.position = "none", panel.border = element_blank(), axis.line = element_line()) +
  theme(
    axis.text.x = element_text(color="black"),
    axis.ticks = element_line(color = "black")
  ) + 
  labs( x = "", y = "RESI", title = "Standardized effect size")

# # 4.2 RSFC & power
# P_RSFC_power = ggplot(data_FC, aes(x = X, y = power_100, linetype = D_scheme, fill = bl_scheme)) +
#   # geom_violin(position = position_dodge(width = 0.7)) + 
#   geom_boxplot(width = 0.4, position = position_dodge(width = 0.7), outlier.shape = NA) + 
#   facet_grid(. ~ X_type, space = "free_x", scales = "free_x") +
#   theme_bw() +
#   theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none", panel.border = element_blank(), axis.line = element_line()) +
#   labs( x = "", y = "Power (%)", title = "Statistical Power") 
# 
# # 4.3 RSFC & replicability
# P_RSFC_rep = ggplot(data_FC, aes(x = X, y = replicability_100, linetype = D_scheme, fill = bl_scheme)) +
#   # geom_violin(position = position_dodge(width = 0.7)) + 
#   geom_boxplot(width = 0.4, position = position_dodge(width = 0.7), outlier.shape = NA) + 
#   facet_grid(. ~ X_type, space = "free_x", scales = "free_x") +
#   theme_bw() +
#   theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none", panel.border = element_blank(), axis.line = element_line()) +
#   labs( x = "", y = "Replicability (%)", title = "Probability of Replication") 


# 4.4 RSFC & Sample size needed for 80% replicability
P_RSFC_N_80 = ggplot(data_FC, aes(x = X, y = N_80_ceil, linetype = D_scheme, fill = bl_scheme)) +
  #specify position here
  geom_boxplot(width = 0.4, position = position_dodge(width = 0.7), outlier.shape = NA) + 
  facet_grid(. ~ X_type, space = "free_x", scales = "free_x") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), 
        legend.position = "bottom", panel.border = element_blank(), axis.line = element_line()) +
  theme(
    axis.text.x = element_text(color="black"),
    axis.ticks = element_line(color = "black")
  ) + 
  labs(fill = "Between-subject Variability", linetype = "Within-subject Variability",
       x = "", y = "Sample size", title = "N needed for 80% replicability") + 
  scale_y_continuous(breaks=c(0, 500, 1000, 2000, 3000),
        labels=c("0", "500", "1000", "2000", ">3000")) 

legend_other = get_legend(P_RSFC_N_80)
P_RSFC_N_80 = P_RSFC_N_80 + theme(legend.position = "none")


library(ggpubr)
# -------------- Combined plot ----------
# # row 1: GMV
P_1 = plot_grid(P_GMV_L_RESI,  P_GMV_N_80,  labels = c("a", "b"), nrow = 1)
P_1 = annotate_figure(P_1, left = grid::textGrob("Total GMV", vjust = 0.3, hjust = 0, rot = 90, gp = grid::gpar(cex = 1, fontface = "plain")) )
# # row 2: Regional GMV
P_2 = plot_grid( P_vol_L_RESI, P_vol_N_80, labels = c("c", "d"), nrow = 1)
P_2 = annotate_figure(P_2, left = grid::textGrob("Regional GMV", vjust = 0.3, hjust = 0, rot = 90, gp = grid::gpar(cex = 1, fontface = "plain")) )

# # row 3: regional CT
P_3 = plot_grid( P_CT_L_RESI, P_CT_N_80, labels = c("e", "f"), nrow = 1)
P_3 = annotate_figure(P_3, left = grid::textGrob("Regional CT", vjust = 0.3, hjust = 0, rot = 90, gp = grid::gpar(cex = 1, fontface = "plain")) )

# # row 4: RSFC
P_4 = plot_grid( P_RSFC_L_RESI, P_RSFC_N_80, labels = c("g", "h"), nrow = 1)
P_4 = annotate_figure(P_4, left = grid::textGrob("Functional connectivity", vjust = 0.3, hjust = 0.3, rot = 90, gp = grid::gpar(cex = 1, fontface = "plain")) )

P = plot_grid(P_1, 
              legend_GMV,
              NULL,
              P_2,
              P_3,
              P_4, 
              legend_other, 
              ncol = 1,
              rel_heights = c(1, 0.07, 0.05, 1, 1, 1, 0.07))

ggsave("figures_pdf/ED_Figure_2.pdf", plot = P, width = 13, height = 15, units = "in")

```

```{r, fig.width=13, fig.height=15}
P
```


## ED Fig. 3. The reduction factor of sample size needed for 80% replicability in ABCD
```{r}
# ------ global & regional structural brain outcomes -----------
filenames <- list.files("Results/ABCD_samp_other_covariate_ROI_global", pattern = ".rds", full.names=TRUE)

col_names = readRDS("Results/ABCD_samp_other_covariate_ROI_global/samp_nihtbx_totalcomp_fc_nsim1000.rds") %>% colnames

obj = list()
for (i in 1:length(filenames)){
  temp = readRDS(filenames[i])
  obj[[i]] = temp[, col_names]
}

plot_data = do.call(rbind, obj)

plot_data %<>% dplyr::select(bl_scheme, D_scheme, X, Y, gee_L_RESI) %<>% rename(L_RESI = gee_L_RESI)

# # check sample size
# plot_data$N %>% unique
# # check schemes
# plot_data$bl_scheme %>% unique
# plot_data$D_scheme %>% unique

plot_data = subset(plot_data, X %in% c("nihtbx_totalcomp_fc", "nihtbx_cardsort_fc", "nihtbx_fluidcomp_fc", 
                                       "nihtbx_cryst_fc", "nihtbx_flanker_fc", "nihtbx_list_fc", "nihtbx_pattern_fc", 
                                       "nihtbx_picture_fc",  "nihtbx_picvocab_fc",  "nihtbx_reading_fc",
                                       "BMI", "cbcl_scr_syn_totprob_t", "bw", "handedness") )


# adding labels for sampling schemes
plot_data$bl_scheme %<>% factor(levels = c(2, 1), labels = c("Smaller (Bell-shaped)", "Larger (U-shaped)"))
plot_data$D_scheme %<>% factor(levels = c(2, 1), labels = c("Smaller (Bell-shaped)", "Larger (U-shaped)"))

# clean 
plot_data$D_scheme[plot_data$X %in% c("bw", "handedness", "nihtbx_totalcomp_fc", "nihtbx_cardsort_fc", "nihtbx_fluidcomp_fc") ] = "Smaller (Bell-shaped)"


plot_data$X_type = ifelse(plot_data$X %in% c("nihtbx_totalcomp_fc", "nihtbx_cardsort_fc", "nihtbx_fluidcomp_fc"), "Cross-sectional", "Longitudinal")

# adding labels for the covariates
plot_data$X %<>% factor(levels = c("nihtbx_totalcomp_fc", "nihtbx_cardsort_fc", "nihtbx_fluidcomp_fc", 
                                   "nihtbx_cryst_fc", "nihtbx_flanker_fc", "nihtbx_list_fc", "nihtbx_pattern_fc", 
                                   "nihtbx_picture_fc",  "nihtbx_picvocab_fc",  "nihtbx_reading_fc",
                                   "cbcl_scr_syn_totprob_t",
                                   "BMI", "bw", "handedness"),
                        labels = c("Cgntn Ttl Cmpst Scr", "Dmnsnl Chng Crd Srt", "Cgntn Fld Cmpst",
                                   "Crystllzd Cmpst", "Flnkr Inhbtry Ctrl", "Lst Srtng Wrkng Mmry", "Pttrn Cmprsn Prcssng Spd",
                                   "Pctr Sqnc Mmry", "Pctr Vcblry", "Orl Rdng Rcgntn",
                                   "CBCL",
                                   "BMI", "Birth Weight", "Handedness")
)


# labels for ROI outcomes
outcome = lapply(plot_data$Y %>% as.character, FUN = function(x){
  z = strsplit(x, split = "_") %>% unlist
  return(z[2])
}) %>% unlist

plot_data$outcome_type = NA
plot_data$outcome_type[outcome == "Vol"] = "Regional Vol"
plot_data$outcome_type[outcome == "CT"] = "Regional CT"


# calculate: sample size needed for 80% replicability
plot_data$N_80 = lapply(plot_data$L_RESI, FUN = function(S) {
  df = 5 # total number of parameters in the model
  f = function(n) {pf(qf(0.95, df1 = 1, df2= n - df), df1 = 1, df2 = n - df, ncp = S^2*n, lower.tail = FALSE) - sqrt(0.8)}
  N = uniroot(f, lower = 6, upper = 1000000)$root
  return(N)
} ) %>% unlist


# calculate: the reduction factor for the sample sizes needed for 80% replicability by increasing between-subject variability (comparing with between-subject variability == "smaller & within-subject variability = "smaller)
plot_data %<>% arrange(Y, X)
plot_data %<>% group_by(Y, X) %>% 
  mutate(red_factor_N_80 = N_80[bl_scheme == "Smaller (Bell-shaped)" & D_scheme == "Smaller (Bell-shaped)"] / N_80) 

# calculate: the increase factor for the ES by increasing the between-subject variability (comparing with between-subject variability == "smaller & within-subject variability = "smaller)
plot_data %<>% group_by(Y, X) %>% mutate(inc_factor_L_RESI = L_RESI / L_RESI[bl_scheme == "Smaller (Bell-shaped)" & D_scheme == "Smaller (Bell-shaped)"]) 


# ----- 1. outcome GMV -------
data_GMV = subset(plot_data, Y == "GMV_10000_combat")

# ------ 2. outcome: ROI GMV -------------
data_ROI_vol = subset(plot_data, outcome_type == "Regional Vol")

# ------ 3. outcome: ROI CT ---------
data_ROI_CT = subset(plot_data, outcome_type == "Regional CT")


# ------- 4. outcome FC -------------
filenames <- list.files("Results/ABCD_samp_other_covariate_FC", pattern = ".rds",  full.names=TRUE)

plot_data_1 = plot_data_2 = NULL
var_list_1 = c("N", "nboot", "bl_scheme", "D_scheme", "X", "Y", "L_RESI", "L_RESI_ll", "L_RESI_ul")
var_list_2 = c("N", "nboot", "bl_scheme", "D_scheme", "X", "Y", "gee_L_RESI", "gee_L_RESI_ll", "gee_L_RESI_ul")
for (i in 1:length(filenames)){
  temp = readRDS(filenames[i])
  if (unique(temp$X) %in% c("nihtbx_totalcomp_fc", "nihtbx_list_fc", "nihtbx_cardsort_fc", "nihtbx_fluidcomp_fc", "handedness")){
    plot_data_1 = rbind(plot_data_1, temp[, var_list_1])
  } else {
    plot_data_2 = rbind(plot_data_2, temp[, var_list_2])
  }
}

plot_data_2 %<>% rename(L_RESI = gee_L_RESI, L_RESI_ll = gee_L_RESI_ll, L_RESI_ul = gee_L_RESI_ul)

plot_data = rbind(plot_data_1, plot_data_2)

# # check sample size
# plot_data$N %>% unique
# # check schemes
# plot_data$bl_scheme %>% unique
# plot_data$D_scheme %>% unique

plot_data = subset(plot_data, bl_scheme %in% c(2, 1) )

plot_data = subset(plot_data, X %in% c("nihtbx_totalcomp_fc", "nihtbx_cardsort_fc", "nihtbx_fluidcomp_fc",
                                       "nihtbx_cryst_fc", "nihtbx_flanker_fc", "nihtbx_list_fc", "nihtbx_pattern_fc",
                                       "nihtbx_picture_fc",  "nihtbx_picvocab_fc",  "nihtbx_reading_fc",
                                       "BMI",  "cbcl_scr_syn_totprob_t","bw", "handedness"))

# adding labels for sampling schemes
plot_data$bl_scheme %<>% factor(levels = c(2, 1), labels = c("Smaller (Bell-shaped)", "Larger (U-shaped)"))
plot_data$D_scheme %<>% factor(levels = c(2, 1), labels = c("Smaller (Bell-shaped)", "Larger (U-shaped)"))

# clean 
plot_data$D_scheme[plot_data$X %in% c("bw", "handedness", "nihtbx_totalcomp_fc", "nihtbx_list_fc", "nihtbx_cardsort_fc", "nihtbx_fluidcomp_fc") ] = "Smaller (Bell-shaped)"


plot_data$X_type = ifelse(plot_data$X %in% c("nihtbx_totalcomp_fc", "nihtbx_list_fc", "nihtbx_cardsort_fc", "nihtbx_fluidcomp_fc"), "Cross-sectional", "Longitudinal")

# adding labels for the covariates
plot_data$X %<>% factor(levels = c("nihtbx_totalcomp_fc", "nihtbx_cardsort_fc", "nihtbx_fluidcomp_fc",
                                   "nihtbx_cryst_fc", "nihtbx_flanker_fc", "nihtbx_list_fc", "nihtbx_pattern_fc",
                                   "nihtbx_picture_fc",  "nihtbx_picvocab_fc",  "nihtbx_reading_fc",
                                   "cbcl_scr_syn_totprob_t",
                                   "BMI",  "bw", "handedness"),
                        labels = c("Cgntn Ttl Cmpst Scr", "Dmnsnl Chng Crd Srt", "Cgntn Fld Cmpst",
                                   "Crystllzd Cmpst", "Flnkr Inhbtry Ctrl", "Lst Srtng Wrkng Mmry", "Pttrn Cmprsn Prcssng Spd",
                                   "Pctr Sqnc Mmry", "Pctr Vcblry", "Orl Rdng Rcgntn",
                                   "CBCL",
                                   "BMI",  "Birth Weight", "Handedness")
)


data_FC = plot_data

# calculate: sample size needed for 80% replicability
data_FC$N_80 = lapply(data_FC$L_RESI, FUN = function(S) {
  df = 8 # total num of parameters in the model
  f = function(n) {pf(qf(0.95, df1 = 1, df2= n - df), df1 = 1, df2 = n - df, ncp = S^2*n, lower.tail = FALSE) - sqrt(0.8)}
  N = uniroot(f, lower = 9, upper = 1000000)$root
  return(N)
} ) %>% unlist

# calculate: the reduction factor for the sample sizes needed for 80% power by increasing between-subject variability (comparing with between-subject variability == "smaller & within-subject variability = "smaller)
data_FC %<>% arrange(Y, X)
data_FC %<>% group_by(Y, X) %>% 
  mutate(red_factor_N_80 = N_80[bl_scheme == "Smaller (Bell-shaped)" & D_scheme == "Smaller (Bell-shaped)"] / N_80) 

# calculate: the increase factor for the ES by increasing the between-subject variability (comparing with between-subject variability == "smaller & within-subject variability = "smaller)
data_FC %<>% group_by(Y, X) %>% mutate(inc_factor_L_RESI = L_RESI / L_RESI[bl_scheme == "Smaller (Bell-shaped)" & D_scheme == "Smaller (Bell-shaped)"]) 



# Combined data
# outcome: total GMV
dat_GMV = subset(data_GMV, bl_scheme == "Larger (U-shaped)" & D_scheme == "Smaller (Bell-shaped)") %>% dplyr::select(bl_scheme, D_scheme, X, Y, L_RESI, N_80, X_type, red_factor_N_80, inc_factor_L_RESI)
dat_GMV$Y_type = "Total GMV"
# outcome: regioanl GMV
dat_ROI_vol = subset(data_ROI_vol, bl_scheme == "Larger (U-shaped)" & D_scheme == "Smaller (Bell-shaped)") %>% dplyr::select(bl_scheme, D_scheme, X, Y, L_RESI, N_80, X_type, red_factor_N_80, inc_factor_L_RESI)
dat_ROI_vol$Y_type = "Regional GMV"

# outcome: regioanl CT
dat_ROI_CT = subset(data_ROI_CT, bl_scheme == "Larger (U-shaped)" & D_scheme == "Smaller (Bell-shaped)") %>% dplyr::select(bl_scheme, D_scheme, X, Y, L_RESI, N_80, X_type, red_factor_N_80, inc_factor_L_RESI)
dat_ROI_CT$Y_type = "Regional CT"

# outcome: FC
dat_FC = subset(data_FC, bl_scheme == "Larger (U-shaped)" & D_scheme == "Smaller (Bell-shaped)") %>% dplyr::select(bl_scheme, D_scheme, X, Y, L_RESI, N_80, X_type, red_factor_N_80, inc_factor_L_RESI)
dat_FC$Y_type = "FC"

dat = rbind(dat_GMV, dat_ROI_vol, dat_ROI_CT, dat_FC)
dat$Y_type %<>% factor(levels = c("Total GMV", "Regional GMV", "Regional CT", "FC"))

p1 = ggplot(dat, aes(x = Y_type, y = log2(red_factor_N_80))) + geom_boxplot() + theme_classic() + theme(axis.text.x = element_text(angle = 45, hjust = 1)) +       theme(axis.text.x = element_text(color="black"), axis.ticks = element_line(color = "black")) +  
labs(x = element_blank(), y = "log2 of reduction factor", title = "Reduction in N needed for 80% replicability") + geom_hline(yintercept = 0, linetype = "dashed")

ggsave("figures_pdf/ED_Figure_3.pdf", plot = p1, width = 5, height = 5, units = "in")

```

```{r, fig.width=6, fig.height=6}
# p1
```

```{r}
# The medians of the increase/reduction factors in ES and N 
cat("The median increase factors of the ES is: ", dat$inc_factor_L_RESI %>% median %>% round(1), "\n")
cat("The median reduction factors of the sample size is: ", dat$red_factor_N_80 %>% median %>% round(1), "\n")
# the proportion of associations that had increased ES by between-subject sampling schemes
v = mean(dat$inc_factor_L_RESI >= 1)
cat("The proportion of associations that had increased ES by between-subject sampling schemes: ", v * 100, "%\n")
```


## ED Fig. 4. The effects of using longitudinal designs in ABCD (all)

```{r}
library(Hmisc)
library(ggh4x)

#  effect of using longitudinal designs -------------

# results for regional outcomes (Reginal GMV and CT)
filenames <- list.files("Results/ABCD_CS_L_analysis", pattern = "bl_and_full_data_analysis_ROI",  full.names=TRUE)

plot_data_ROI = NULL
for (i in 1:length(filenames)){
  temp = readRDS(filenames[i])
  plot_data_ROI = rbind(plot_data_ROI, temp)
}

# labels for ROI outcomes
outcome = lapply(plot_data_ROI$Y %>% as.character, FUN = function(x){
  z = strsplit(x, split = "_") %>% unlist
  return(z[2])
}) %>% unlist

plot_data_ROI$outcome_type = NA
plot_data_ROI$outcome_type[outcome == "Vol"] = "Regional Vol"
plot_data_ROI$outcome_type[outcome == "CT"] = "Regional CT"

# results for FC outcomes
plot_data_FC <- readRDS("Results/ABCD_CS_L_analysis/FC_results_bl_and_full_data_analyses.rds")
plot_data_FC$outcome_type = "FC"
plot_data_FC$X[plot_data_FC$X == "handedness_impute"] = "handedness"

# results for total GMV
plot_data_GMV <- readRDS("Results/ABCD_CS_L_analysis/bl_and_full_data_analysis_GMV.rds")
plot_data_GMV$outcome_type = "Total GMV"

# plot data
plot_data = rbind(plot_data_ROI, plot_data_FC)

plot_data = subset(plot_data, X %in% c("nihtbx_totalcomp_fc", "nihtbx_cardsort_fc", "nihtbx_fluidcomp_fc",
                                       "nihtbx_cryst_fc", "nihtbx_flanker_fc", "nihtbx_list_fc", "nihtbx_pattern_fc",
                                       "nihtbx_picture_fc",  "nihtbx_picvocab_fc",  "nihtbx_reading_fc",
                                       "BMI", "cbcl_scr_syn_totprob_t", "bw", "handedness") )


# adding labels for the covariates
plot_data$X %<>% factor(levels = c("nihtbx_totalcomp_fc", "nihtbx_cardsort_fc", "nihtbx_fluidcomp_fc", 
                                   "nihtbx_cryst_fc", "nihtbx_flanker_fc", "nihtbx_list_fc", "nihtbx_pattern_fc", 
                                   "nihtbx_picture_fc",  "nihtbx_picvocab_fc",  "nihtbx_reading_fc",
                                   "cbcl_scr_syn_totprob_t",
                                   "BMI", "bw", "handedness"),
                        labels = c("Cgntn Ttl Cmpst Scr", "Dmnsnl Chng Crd Srt", "Cgntn Fld Cmpst",
                                   "Crystllzd Cmpst", "Flnkr Inhbtry Ctrl", "Lst Srtng Wrkng Mmry", "Pttrn Cmprsn Prcssng Spd",
                                   "Pctr Sqnc Mmry", "Pctr Vcblry", "Orl Rdng Rcgntn",
                                   "CBCL",
                                   "BMI", "Birth Weight", "Handedness")
)


# ----- 1. outcome GMV -------

data_GMV = plot_data_GMV
# adding labels for the covariates
data_GMV$X %<>% factor(levels = c("nihtbx_totalcomp_fc", "nihtbx_cardsort_fc", "nihtbx_fluidcomp_fc", 
                                   "nihtbx_cryst_fc", "nihtbx_flanker_fc", "nihtbx_list_fc", "nihtbx_pattern_fc", 
                                   "nihtbx_picture_fc",  "nihtbx_picvocab_fc",  "nihtbx_reading_fc",
                                   "cbcl_scr_syn_totprob_t",
                                   "BMI", "bw", "handedness"),
                        labels = c("Cgntn Ttl Cmpst Scr", "Dmnsnl Chng Crd Srt", "Cgntn Fld Cmpst",
                                   "Crystllzd Cmpst", "Flnkr Inhbtry Ctrl", "Lst Srtng Wrkng Mmry", "Pttrn Cmprsn Prcssng Spd",
                                   "Pctr Sqnc Mmry", "Pctr Vcblry", "Orl Rdng Rcgntn",
                                   "CBCL",
                                   "BMI", "Birth Weight", "Handedness")
)


# reformat plot data
# Full data
m_all = data_GMV %>% dplyr::select(X, Y, gee_resi_full, gee_resi_full_ll, gee_resi_full_ul)
m_all$m = "all"
m_all %<>% rename(resi = gee_resi_full,
               resi_ll = gee_resi_full_ll,
               resi_ul = gee_resi_full_ul)

# baseline (1st)
m1 = data_GMV %>% dplyr::select(X, Y, resi_bl, resi_bl_ll, resi_bl_ul)
m1$m = "1st"
m1 %<>% rename(resi = resi_bl,
               resi_ll = resi_bl_ll,
               resi_ul = resi_bl_ul)

# 2nd measurement
m2 = data_GMV %>% dplyr::select(X, Y, resi_2nd, resi_2nd_ll, resi_2nd_ul)
m2$m = "2nd"
m2 %<>% rename(resi = resi_2nd,
               resi_ll = resi_2nd_ll,
               resi_ul = resi_2nd_ul)

data_GMV = rbind(m1, m2, m_all)
data_GMV$m %<>% factor()
data_GMV$resi %<>% as.numeric()
data_GMV$resi_ll %<>% as.numeric()
data_GMV$resi_ul %<>% as.numeric()

p_resi_GMV = ggplot(data_GMV, aes(x = interaction(m, X), y = resi, ymin = resi_ll, ymax = resi_ul)) +
  geom_errorbar(width = .35) + 
  geom_point(size = 1.5) + 
  guides(x = "axis_nested") + 
  geom_line(aes(x = as.numeric(m), y = resi), alpha = 0.2) +
  facet_grid(. ~ X, space = "free_x", scales = "free_x") +
  theme_classic() +
  theme(ggh4x.axis.nesttext.x = element_text(angle = 45, hjust = 1), 
        legend.position = "none", panel.border = element_blank(), axis.line = element_line(),
        axis.line.x = element_blank(),
        # remove the facet labels
        strip.text.x = element_blank()) + 
  labs(x = " ", y = "", title = "Effect Size")

# ----- 2. outcome regional GMV -------

data_ROI_vol = subset(plot_data, outcome_type == "Regional Vol")

# reformat plot data
m_all = data_ROI_vol %>% dplyr::select(X, Y, gee_resi_full)
m_all$m = "all"
m_all %<>% rename(resi = gee_resi_full)

m1 = data_ROI_vol %>% dplyr::select(X, Y, resi_bl)
m1$m = "1st"
m1 %<>% rename(resi = resi_bl)

m2 = data_ROI_vol %>% dplyr::select(X, Y, resi_2nd)
m2$m = "2nd"
m2 %<>% rename(resi = resi_2nd)

data_ROI_vol = rbind(m1, m2, m_all)
data_ROI_vol$m %<>% factor()
data_ROI_vol$resi %<>% as.numeric()


# RESI
df_med = data_ROI_vol %>% group_by(X, m) %>% summarise(med = median(resi)) %>% ungroup()

p_resi_ROI_vol = ggplot(data_ROI_vol, aes(x = interaction(m, X), y = resi)) +
  geom_boxplot(width = 0.4, outlier.shape = NA)  + 
  guides(x = "axis_nested") + 
  geom_line(data = df_med, aes(x = as.numeric(m), y = med), alpha = 0.4) +
  facet_grid(. ~ X, space = "free_x", scales = "free_x") +
  theme_classic() +
  theme(ggh4x.axis.nesttext.x = element_text(angle = 45, hjust = 1), 
        legend.position = "none", panel.border = element_blank(), axis.line = element_line(),
        axis.line.x = element_blank(),
        # remove the facet labels
        strip.text.x = element_blank()) + 
  labs(x = " ", y = "", title = "Effect Size")

# ----- 3. outcome regional CT -------

data_ROI_CT = subset(plot_data, outcome_type == "Regional CT")

# reformat plot data
m_all = data_ROI_CT %>% dplyr::select(X, Y, gee_resi_full)
m_all$m = "all"
m_all %<>% rename(resi = gee_resi_full)

m1 = data_ROI_CT %>% dplyr::select(X, Y, resi_bl)
m1$m = "1st"
m1 %<>% rename(resi = resi_bl)

m2 = data_ROI_CT %>% dplyr::select(X, Y, resi_2nd)
m2$m = "2nd"
m2 %<>% rename(resi = resi_2nd)

data_ROI_CT = rbind(m1, m2, m_all)
data_ROI_CT$m %<>% factor()
data_ROI_CT$resi %<>% as.numeric()

# RESI
df_med = data_ROI_CT %>% group_by(X, m) %>% summarise(med = median(resi)) %>% ungroup()

p_resi_ROI_CT = ggplot(data_ROI_CT, aes(x = interaction(m, X), y = resi)) +
  geom_boxplot(width = 0.4, outlier.shape = NA)  + 
  guides(x = "axis_nested") + 
  geom_line(data = df_med, aes(x = as.numeric(m), y = med), alpha = 0.4) +
  facet_grid(. ~ X, space = "free_x", scales = "free_x") +
  theme_classic() +
  theme(ggh4x.axis.nesttext.x = element_text(angle = 45, hjust = 1), 
        legend.position = "none", panel.border = element_blank(), axis.line = element_line(),
        axis.line.x = element_blank(),
        # remove the facet labels
        strip.text.x = element_blank()) + 
  labs(x = " ", y = "", title = "Effect Size")

# ------ 4. outcome: RSFC ---------
data_FC = subset(plot_data, outcome_type == "FC")

# reformat plot data
m_all = data_FC %>% dplyr::select(X, Y, gee_resi_full)
m_all$m = "all"
m_all %<>% rename(resi = gee_resi_full)

m1 = data_FC %>% dplyr::select(X, Y, resi_bl)
m1$m = "1st"
m1 %<>% rename(resi = resi_bl)

m2 = data_FC %>% dplyr::select(X, Y, resi_2nd)
m2$m = "2nd"
m2 %<>% rename(resi = resi_2nd)

data_FC = rbind(m1, m2, m_all)
data_FC$m %<>% factor()
data_FC$resi %<>% as.numeric()

# RESI
df_med = data_FC %>% group_by(X, m) %>% summarise(med = median(resi)) %>% ungroup()

p_resi_FC = ggplot(data_FC, aes(x = interaction(m, X), y = resi)) +
  geom_boxplot(width = 0.4, outlier.shape = NA)  + 
  guides(x = "axis_nested") + 
  geom_line(data = df_med, aes(x = as.numeric(m), y = med), alpha = 0.4) +
  facet_grid(. ~ X, space = "free_x", scales = "free_x") +
  theme_classic() +
  theme(ggh4x.axis.nesttext.x = element_text(angle = 45, hjust = 1), 
        legend.position = "none", panel.border = element_blank(), axis.line = element_line(),
        axis.line.x = element_blank(),
        # remove the facet labels
        strip.text.x = element_blank()) + 
  labs(x = " ", y = "", title = "Effect Size")


```



```{r, fig.height = 12, fig.width=9}
library(ggpubr)

P1 = plot_grid(p_resi_GMV + labs(title = "Total GMV", y = "RESI") + theme(axis.text.x = element_text(color="black"), axis.ticks = element_line(color = "black")),
              p_resi_ROI_vol + labs(title = "Regional GMV", y = "RESI") + theme(axis.text.x = element_text(color="black"), axis.ticks = element_line(color = "black")),
              p_resi_ROI_CT + labs(title = "Regional CT", y = "RESI") + theme(axis.text.x = element_text(color="black"), axis.ticks = element_line(color = "black")),
              p_resi_FC + labs(title = "Functional connectivity", y = "RESI") + theme(axis.text.x = element_text(color="black"), axis.ticks = element_line(color = "black")),
              labels = "auto", ncol = 1
              )

ggsave("figures_pdf/ED_Figure_4.pdf", plot = P1, width = 9, height = 12, units = "in")

```






## ED Fig. 5. The effect of sampling schemes on between- and within-subject associations, respectively.
```{r, fig.height = 15, fig.width=12}
# ------ global & regional brain outcomes -----------
filenames <- list.files("Results/ABCD_samp_other_covariate_ROI_global", pattern = "nsim1000", full.names=TRUE)

plot_data = NULL
for (i in 1:length(filenames)){
  temp = readRDS(filenames[i])
  if (!unique(temp$X) %in% c("nihtbx_totalcomp_fc", "nihtbx_cardsort_fc", "nihtbx_fluidcomp_fc", "bw", "handedness")) {
    plot_data = rbind(plot_data, temp)
  }
}

plot_data$X %>% unique


# check sample size
plot_data$N %>% unique
# check schemes
plot_data$bl_scheme %>% unique
plot_data$D_scheme %>% unique

plot_data = subset(plot_data, X %in% c("nihtbx_totalcomp_fc", "nihtbx_cardsort_fc", "nihtbx_fluidcomp_fc",
                                       "nihtbx_cryst_fc", "nihtbx_flanker_fc", "nihtbx_list_fc", "nihtbx_pattern_fc",
                                       "nihtbx_picture_fc",  "nihtbx_picvocab_fc",  "nihtbx_reading_fc",
                                       "BMI", "cbcl_scr_syn_totprob_t", "bw", "handedness") )

# adding labels for sampling schemes
plot_data$bl_scheme %<>% factor(levels = c(2, 1), labels = c("Smaller (Bell-shaped)", "Larger (U-shaped)"))
plot_data$D_scheme %<>% factor(levels = c(2, 1), labels = c("Smaller (Bell-shaped)", "Larger (U-shaped)"))

# clean 
plot_data$D_scheme[plot_data$X %in% c("bw", "handedness", "nihtbx_totalcomp_fc", "nihtbx_cardsort_fc", "nihtbx_fluidcomp_fc") ] = "Smaller (Bell-shaped)"

plot_data$X_type = ifelse(plot_data$X %in% c("nihtbx_totalcomp_fc", "nihtbx_cardsort_fc", "nihtbx_fluidcomp_fc"), "Cross-sectional", "Longitudinal")

# adding labels for the covariates
plot_data$X %<>% factor(levels = c("nihtbx_totalcomp_fc", "nihtbx_cardsort_fc", "nihtbx_fluidcomp_fc", 
                                   "nihtbx_cryst_fc", "nihtbx_flanker_fc", "nihtbx_list_fc", "nihtbx_pattern_fc", 
                                   "nihtbx_picture_fc",  "nihtbx_picvocab_fc",  "nihtbx_reading_fc",
                                   "cbcl_scr_syn_totprob_t",
                                   "BMI", "bw", "handedness"),
                        labels = c("Cgntn Ttl Cmpst Scr", "Dmnsnl Chng Crd Srt", "Cgntn Fld Cmpst",
                                   "Crystllzd Cmpst", "Flnkr Inhbtry Ctrl", "Lst Srtng Wrkng Mmry", "Pttrn Cmprsn Prcssng Spd",
                                   "Pctr Sqnc Mmry", "Pctr Vcblry", "Orl Rdng Rcgntn",
                                   "CBCL",
                                   "BMI", "Birth Weight", "Handedness")
)


# labels for ROI outcomes
outcome = lapply(plot_data$Y %>% as.character, FUN = function(x){
  z = strsplit(x, split = "_") %>% unlist
  return(z[2])
}) %>% unlist

plot_data$outcome_type = NA
plot_data$outcome_type[outcome == "Vol"] = "Regional Vol"
plot_data$outcome_type[outcome == "CT"] = "Regional CT"

# 1. Total GMV ---------------
data_GMV = subset(plot_data, Y == "GMV_10000_combat")

# adding labels for outcome
data_GMV$Y_lab = "Outcome: Global GMV"

# 1.1 GMV & L-RESI for between-subject associations
P_GMV_effect_b = ggplot(data_GMV, aes(x = X, y = L_resi_b, ymin = L_resi_b_ll, ymax = L_resi_b_ul, col = bl_scheme, group = interaction(bl_scheme, D_scheme))) +
  #specify position here
  geom_errorbar(width = .5, position = position_dodge(width = 0.5)) +
  geom_point(aes(shape = D_scheme), size = 2, position=position_dodge(width = 0.5)) + 
  facet_grid(. ~ X_type, space = "free_x", scales = "free_x") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none", panel.border = element_blank(), axis.line = element_line()) +
  theme(axis.text.x = element_text(color="black"), axis.ticks = element_line(color = "black")) +
  labs(col = "Between-subject Variability", linetype = "Within-subject Variability", x = "", y = "RESI", title = "Standardized effect sizes for between-subject association")

# 1.2 GMV & L-RESI for within-subject associations
P_GMV_effect_w = ggplot(data_GMV, aes(x = X, y = L_resi_w, ymin = L_resi_w_ll, ymax = L_resi_w_ul, col = bl_scheme, group = interaction(bl_scheme, D_scheme))) + 
  #specify position here
  geom_errorbar(width = .5, position = position_dodge(width = 0.5)) +
  geom_point(aes(shape = D_scheme), size = 2, position=position_dodge(width = 0.5)) + 
  facet_grid(. ~ X_type, space = "free_x", scales = "free_x") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "bottom", panel.border = element_blank(), axis.line = element_line()) +
  theme(axis.text.x = element_text(color="black"), axis.ticks = element_line(color = "black")) +
  labs(col = "Between-subject Variability", shape = "Within-subject Variability", x = "", y = "RESI", title = "Standardized effect sizes for within-subject association")

legend_GMV = get_legend(P_GMV_effect_w)
P_GMV_effect_w = P_GMV_effect_w + theme(legend.position = "none")

# 2. Regional GMV ---------------
data_ROI_GMV = subset(plot_data, outcome_type == "Regional Vol")
data_ROI_GMV$Y_lab = "Outcome: Regional GMV"

# 2.1 Regional GMV & L-RESI for between-subject associations
P_ROI_GMV_effect_b = ggplot(data_ROI_GMV, aes(x = X, y = L_resi_b, linetype = D_scheme, fill = bl_scheme)) + 
  #specify position here
  geom_boxplot(width = 0.4, position = position_dodge(width = 0.7), outlier.shape = NA) + 
  facet_grid(. ~ X_type, space = "free_x", scales = "free_x") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none", panel.border = element_blank(), axis.line = element_line()) +
  theme(axis.text.x = element_text(color="black"), axis.ticks = element_line(color = "black")) +
  labs(fill = "Between-subject Variability", linetype = "Within-subject Variability", x = "", y = "RESI", title = "Standardized effect sizes for between-subject association")


# 2.2 Regional GMV & L-RESI for within-subject associations
P_ROI_GMV_effect_w = ggplot(data_ROI_GMV, aes(x = X, y = L_resi_w, linetype = D_scheme, fill = bl_scheme)) + 
  #specify position here
  geom_boxplot(width = 0.4, position = position_dodge(width = 0.7), outlier.shape = NA) + 
  facet_grid(. ~ X_type, space = "free_x", scales = "free_x") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none", panel.border = element_blank(), axis.line = element_line()) +
  theme(axis.text.x = element_text(color="black"), axis.ticks = element_line(color = "black")) +
  labs(fill = "Between-subject Variability", linetype = "Within-subject Variability", x = "", y = "RESI", title = "Standardized effect sizes for within-subject association")


# 3. Regional CT ---------------
data_ROI_CT = subset(plot_data, outcome_type == "Regional CT")
data_ROI_CT$Y_lab = "Outcome: Regional CT"

# 3.1 Regional CT & L-RESI for between-subject associations
P_ROI_CT_effect_b = ggplot(data_ROI_CT, aes(x = X, y = L_resi_b, linetype = D_scheme, fill = bl_scheme)) + 
  #specify position here
  geom_boxplot(width = 0.4, position = position_dodge(width = 0.7), outlier.shape = NA) + 
  facet_grid(. ~ X_type, space = "free_x", scales = "free_x") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none", panel.border = element_blank(), axis.line = element_line()) +
  theme(axis.text.x = element_text(color="black"), axis.ticks = element_line(color = "black")) +
  labs(fill = "Between-subject Variability", linetype = "Within-subject Variability", x = "", y = "RESI", title = "Standardized effect sizes for between-subject association")


# 3.2 Regional CT & L-RESI for within-subject associations
P_ROI_CT_effect_w = ggplot(data_ROI_CT, aes(x = X, y = L_resi_w, linetype = D_scheme, fill = bl_scheme)) + 
  #specify position here
  geom_boxplot(width = 0.4, position = position_dodge(width = 0.7), outlier.shape = NA) + 
  facet_grid(. ~ X_type, space = "free_x", scales = "free_x") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "bottom", panel.border = element_blank(), axis.line = element_line()) +
  theme(axis.text.x = element_text(color="black"), axis.ticks = element_line(color = "black")) +
  labs(fill = "Between-subject Variability", linetype = "Within-subject Variability", x = "", y = "RESI", title = "Standardized effect sizes for within-subject association")

legend_other = get_legend(P_ROI_CT_effect_w)
P_ROI_CT_effect_w = P_ROI_CT_effect_w + theme(legend.position = "none")

# 4. Functional connectivities ------------

filenames <- list.files("Results/ABCD_samp_other_covariate_FC", pattern = ".rds",  full.names=TRUE)
plot_data = NULL

for (i in 1:length(filenames)){
  temp = readRDS(filenames[i])
  if (!unique(temp$X) %in% c("nihtbx_totalcomp_fc", "nihtbx_list_fc", "nihtbx_cardsort_fc", "nihtbx_fluidcomp_fc", "handedness", "bw")){
    plot_data = rbind(plot_data, temp)
  } 
}

# check sample size
plot_data$N %>% unique
# check schemes
plot_data$bl_scheme %>% unique
plot_data$D_scheme %>% unique

plot_data = subset(plot_data, bl_scheme %in% c(2, 1) )

plot_data = subset(plot_data, X %in% c("nihtbx_totalcomp_fc", "nihtbx_cardsort_fc", "nihtbx_fluidcomp_fc",
                                       "nihtbx_cryst_fc", "nihtbx_flanker_fc", "nihtbx_list_fc", "nihtbx_pattern_fc",
                                       "nihtbx_picture_fc",  "nihtbx_picvocab_fc",  "nihtbx_reading_fc",
                                       "BMI",  "cbcl_scr_syn_totprob_t","bw", "handedness"))

# adding labels for sampling schemes
plot_data$bl_scheme %<>% factor(levels = c(2, 1), labels = c("Smaller (Bell-shaped)", "Larger (U-shaped)"))
plot_data$D_scheme %<>% factor(levels = c(2, 1), labels = c("Smaller (Bell-shaped)", "Larger (U-shaped)"))


plot_data$X_type = ifelse(plot_data$X %in% c("nihtbx_totalcomp_fc", "nihtbx_list_fc", "nihtbx_cardsort_fc", "nihtbx_fluidcomp_fc"), "Cross-sectional", "Longitudinal")

# adding labels for the covariates
plot_data$X %<>% factor(levels = c("nihtbx_totalcomp_fc", "nihtbx_cardsort_fc", "nihtbx_fluidcomp_fc",
                                   "nihtbx_cryst_fc", "nihtbx_flanker_fc", "nihtbx_list_fc", "nihtbx_pattern_fc",
                                   "nihtbx_picture_fc",  "nihtbx_picvocab_fc",  "nihtbx_reading_fc",
                                   "cbcl_scr_syn_totprob_t",
                                   "BMI",  "bw", "handedness"),
                        labels = c("Cgntn Ttl Cmpst Scr", "Dmnsnl Chng Crd Srt", "Cgntn Fld Cmpst",
                                   "Crystllzd Cmpst", "Flnkr Inhbtry Ctrl", "Lst Srtng Wrkng Mmry", "Pttrn Cmprsn Prcssng Spd",
                                   "Pctr Sqnc Mmry", "Pctr Vcblry", "Orl Rdng Rcgntn",
                                   "CBCL",
                                   "BMI",  "Birth Weight", "Handedness")
)

data_FC = plot_data
# 4.1 FC & L-RESI for between-subject associations
P_FC_effect_b = ggplot(data_FC, aes(x = X, y = L_resi_b, linetype = D_scheme, fill = bl_scheme)) + 
  #specify position here
  geom_boxplot(width = 0.4, position = position_dodge(width = 0.7), outlier.shape = NA) + 
  facet_grid(. ~ X_type, space = "free_x", scales = "free_x") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none", panel.border = element_blank(), axis.line = element_line()) +
  theme(axis.text.x = element_text(color="black"), axis.ticks = element_line(color = "black")) +
  labs(fill = "Between-subject Variability", linetype = "Within-subject Variability", x = "", y = "RESI", title = "Standardized effect sizes for between-subject association")


# 2.2 Regional GMV & L-RESI for within-subject associations
P_FC_effect_w = ggplot(data_FC, aes(x = X, y = L_resi_w, linetype = D_scheme, fill = bl_scheme)) + 
  #specify position here
  geom_boxplot(width = 0.4, position = position_dodge(width = 0.7), outlier.shape = NA) + 
  facet_grid(. ~ X_type, space = "free_x", scales = "free_x") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none", panel.border = element_blank(), axis.line = element_line()) +
  theme(axis.text.x = element_text(color="black"), axis.ticks = element_line(color = "black")) +
  labs(fill = "Between-subject Variability", linetype = "Within-subject Variability", x = "", y = "RESI", title = "Standardized effect sizes for within-subject association")

#----------
P_1 = plot_grid(P_GMV_effect_b + ylim(0, 0.5),  P_GMV_effect_w + ylim(0, 0.2),  labels = c("a", "b"), nrow = 1)
P_1 = annotate_figure(P_1, left = grid::textGrob("Total GMV", vjust = 0.3, hjust = 0, rot = 90, gp = grid::gpar(cex = 1, fontface = "plain")) )
# # row 2: Regional GMV
P_2 = plot_grid( P_ROI_GMV_effect_b + ylim(0, 0.32), P_ROI_GMV_effect_w + ylim(0, 0.12), labels = c("c", "d"), nrow = 1)
P_2 = annotate_figure(P_2, left = grid::textGrob("Regional GMV", vjust = 0.3, hjust = 0, rot = 90, gp = grid::gpar(cex = 1, fontface = "plain")) )

# # row 3: regional CT
P_3 = plot_grid( P_ROI_CT_effect_b + ylim(0, 0.22), P_ROI_CT_effect_w + ylim(0, 0.12), labels = c("e", "f"), nrow = 1)
P_3 = annotate_figure(P_3, left = grid::textGrob("Regional CT", vjust = 0.3, hjust = 0, rot = 90, gp = grid::gpar(cex = 1, fontface = "plain")) )

# row 4: FC
P_4 = plot_grid( P_FC_effect_b + ylim(0, 0.35), P_FC_effect_w + ylim(0, 0.35), labels = c("g", "h"), nrow = 1)
P_4 = annotate_figure(P_4, left = grid::textGrob("Functional connectivity", vjust = 0.3, hjust = 0.1, rot = 90, gp = grid::gpar(cex = 1, fontface = "plain")) )

P = plot_grid(P_1,
              legend_GMV,
              NULL,
              P_2,
              P_3,
              P_4,
              legend_other, 
              ncol = 1,
              rel_heights = c(1, 0.05, 0.05, 1, 1, 1, 0.05))

ggsave("figures_pdf/ED_Figure_5.pdf", plot = P, width = 12, height = 15, units = "in")

```

## ED Fig. 6. The benefit of using longitudinal designs on the standardized ESs for between-subject effects.

```{r}
library(Hmisc)
library(ggh4x)

#  effect of using longitudinal designs -------------

# results for regional outcomes (Reginal GMV and CT)
filenames <- list.files("Results/ABCD_CS_L_analysis", pattern = "CS_L_data_analysis_ROI",  full.names=TRUE)

plot_data_ROI = NULL
for (i in 1:length(filenames)){
  temp = readRDS(filenames[i])
  # print(colnames(temp))
  plot_data_ROI = rbind(plot_data_ROI, temp)
}

# labels for ROI outcomes
outcome = lapply(plot_data_ROI$Y %>% as.character, FUN = function(x){
  z = strsplit(x, split = "_") %>% unlist
  return(z[2])
}) %>% unlist

plot_data_ROI$outcome_type = NA
plot_data_ROI$outcome_type[outcome == "Vol"] = "Regional Vol"
plot_data_ROI$outcome_type[outcome == "CT"] = "Regional CT"

# results for FC outcomes
plot_data_FC <- readRDS("Results/ABCD_CS_L_analysis/between_subject_effects_CS_L_data_analysis_FC.rds")
plot_data_FC$outcome_type = "FC"

# results for total GMV
plot_data_GMV <- readRDS("Results/ABCD_CS_L_analysis/between_subject_effects_CS_L_data_analysis_GMV.rds")
plot_data_GMV$outcome_type = "Total GMV"

# plot data
plot_data = rbind(plot_data_ROI, plot_data_FC)

plot_data = subset(plot_data, X %in% c("nihtbx_totalcomp_fc", "nihtbx_cardsort_fc", "nihtbx_fluidcomp_fc",
                                       "nihtbx_cryst_fc", "nihtbx_flanker_fc", "nihtbx_list_fc", "nihtbx_pattern_fc",
                                       "nihtbx_picture_fc",  "nihtbx_picvocab_fc",  "nihtbx_reading_fc",
                                       "BMI", "cbcl_scr_syn_totprob_t") )


# adding labels for the covariates
plot_data$X %<>% factor(levels = c("nihtbx_totalcomp_fc", "nihtbx_cardsort_fc", "nihtbx_fluidcomp_fc", 
                                   "nihtbx_cryst_fc", "nihtbx_flanker_fc", "nihtbx_list_fc", "nihtbx_pattern_fc", 
                                   "nihtbx_picture_fc",  "nihtbx_picvocab_fc",  "nihtbx_reading_fc",
                                   "cbcl_scr_syn_totprob_t",
                                   "BMI"),
                        labels = c("Cgntn Ttl Cmpst Scr", "Dmnsnl Chng Crd Srt", "Cgntn Fld Cmpst",
                                   "Crystllzd Cmpst", "Flnkr Inhbtry Ctrl", "Lst Srtng Wrkng Mmry", "Pttrn Cmprsn Prcssng Spd",
                                   "Pctr Sqnc Mmry", "Pctr Vcblry", "Orl Rdng Rcgntn",
                                   "CBCL",
                                   "BMI")
)


# ----- 1. outcome GMV -------

data_GMV = plot_data_GMV %>% subset( X %in% c("nihtbx_totalcomp_fc", "nihtbx_cardsort_fc", "nihtbx_fluidcomp_fc",
                                                         "nihtbx_cryst_fc", "nihtbx_flanker_fc", "nihtbx_list_fc", "nihtbx_pattern_fc",
                                                         "nihtbx_picture_fc",  "nihtbx_picvocab_fc",  "nihtbx_reading_fc",
                                                         "BMI", "cbcl_scr_syn_totprob_t") )
# adding labels for the covariates
data_GMV$X %<>% factor(levels = c("nihtbx_totalcomp_fc", "nihtbx_cardsort_fc", "nihtbx_fluidcomp_fc", 
                                   "nihtbx_cryst_fc", "nihtbx_flanker_fc", "nihtbx_list_fc", "nihtbx_pattern_fc", 
                                   "nihtbx_picture_fc",  "nihtbx_picvocab_fc",  "nihtbx_reading_fc",
                                   "cbcl_scr_syn_totprob_t",
                                   "BMI"),
                        labels = c("Cgntn Ttl Cmpst Scr", "Dmnsnl Chng Crd Srt", "Cgntn Fld Cmpst",
                                   "Crystllzd Cmpst", "Flnkr Inhbtry Ctrl", "Lst Srtng Wrkng Mmry", "Pttrn Cmprsn Prcssng Spd",
                                   "Pctr Sqnc Mmry", "Pctr Vcblry", "Orl Rdng Rcgntn",
                                   "CBCL",
                                   "BMI")
)


# reformat plot data
# Full data
m_all = data_GMV %>% dplyr::select(X, Y, gee_resi_full, gee_resi_full_ll, gee_resi_full_ul)
m_all$m = "all"
m_all %<>% rename(resi = gee_resi_full,
               resi_ll = gee_resi_full_ll,
               resi_ul = gee_resi_full_ul)

# baseline (1st)
m1 = data_GMV %>% dplyr::select(X, Y, resi_bl, resi_bl_ll, resi_bl_ul)
m1$m = "1st"
m1 %<>% rename(resi = resi_bl,
               resi_ll = resi_bl_ll,
               resi_ul = resi_bl_ul)


data_GMV = rbind(m1, m_all)
data_GMV$m %<>% factor()
data_GMV$resi %<>% as.numeric()
data_GMV$resi_ll %<>% as.numeric()
data_GMV$resi_ul %<>% as.numeric()

p_resi_GMV = ggplot(data_GMV, aes(x = interaction(m, X), y = resi, ymin = resi_ll, ymax = resi_ul)) +
  geom_errorbar(width = .35) + 
  geom_point(size = 1.5) + 
  guides(x = "axis_nested") + 
  geom_line(aes(x = as.numeric(m), y = resi), alpha = 0.2) +
  facet_grid(. ~ X, space = "free_x", scales = "free_x") +
  theme_classic() +
  theme(ggh4x.axis.nesttext.x = element_text(angle = 45, hjust = 1), 
        legend.position = "none", panel.border = element_blank(), axis.line = element_line(),
        axis.line.x = element_blank(),
        # remove the facet labels
        strip.text.x = element_blank()) + 
  labs(x = " ", y = "", title = "Effect Size")

# ----- 2. outcome regional GMV -------

data_ROI_vol = subset(plot_data, outcome_type == "Regional Vol")

# reformat plot data
m_all = data_ROI_vol %>% dplyr::select(X, Y, gee_resi_full)
m_all$m = "all"
m_all %<>% rename(resi = gee_resi_full)

m1 = data_ROI_vol %>% dplyr::select(X, Y, resi_bl)
m1$m = "1st"
m1 %<>% rename(resi = resi_bl)


data_ROI_vol = rbind(m1, m_all)
data_ROI_vol$m %<>% factor()
data_ROI_vol$resi %<>% as.numeric()


# RESI
df_med = data_ROI_vol %>% group_by(X, m) %>% summarise(med = median(resi)) %>% ungroup()

p_resi_ROI_vol = ggplot(data_ROI_vol, aes(x = interaction(m, X), y = resi)) +
  geom_boxplot(width = 0.4, outlier.shape = NA)  + 
  guides(x = "axis_nested") + 
  geom_line(data = df_med, aes(x = as.numeric(m), y = med), alpha = 0.4) +
  facet_grid(. ~ X, space = "free_x", scales = "free_x") +
  theme_classic() +
  theme(ggh4x.axis.nesttext.x = element_text(angle = 45, hjust = 1), 
        legend.position = "none", panel.border = element_blank(), axis.line = element_line(),
        axis.line.x = element_blank(),
        # remove the facet labels
        strip.text.x = element_blank()) + 
  labs(x = " ", y = "", title = "Effect Size")


# ----- 3. outcome regional CT -------

data_ROI_CT = subset(plot_data, outcome_type == "Regional CT")

# reformat plot data
m_all = data_ROI_CT %>% dplyr::select(X, Y, gee_resi_full)
m_all$m = "all"
m_all %<>% rename(resi = gee_resi_full)

m1 = data_ROI_CT %>% dplyr::select(X, Y, resi_bl)
m1$m = "1st"
m1 %<>% rename(resi = resi_bl)

data_ROI_CT = rbind(m1, m_all)
data_ROI_CT$m %<>% factor()
data_ROI_CT$resi %<>% as.numeric()

# RESI
df_med = data_ROI_CT %>% group_by(X, m) %>% summarise(med = median(resi)) %>% ungroup()

p_resi_ROI_CT = ggplot(data_ROI_CT, aes(x = interaction(m, X), y = resi)) +
  geom_boxplot(width = 0.4, outlier.shape = NA)  + 
  guides(x = "axis_nested") + 
  geom_line(data = df_med, aes(x = as.numeric(m), y = med), alpha = 0.4) +
  facet_grid(. ~ X, space = "free_x", scales = "free_x") +
  theme_classic() +
  theme(ggh4x.axis.nesttext.x = element_text(angle = 45, hjust = 1), 
        legend.position = "none", panel.border = element_blank(), axis.line = element_line(),
        axis.line.x = element_blank(),
        # remove the facet labels
        strip.text.x = element_blank()) + 
  labs(x = " ", y = "", title = "Effect Size")

# ------ 4. outcome: RSFC ---------
data_FC = subset(plot_data, outcome_type == "FC")

# reformat plot data
m_all = data_FC %>% dplyr::select(X, Y, gee_resi_full)
m_all$m = "all"
m_all %<>% rename(resi = gee_resi_full)

m1 = data_FC %>% dplyr::select(X, Y, resi_bl)
m1$m = "1st"
m1 %<>% rename(resi = resi_bl)

data_FC = rbind(m1, m_all)
data_FC$m %<>% factor()
data_FC$resi %<>% as.numeric()

# RESI
df_med = data_FC %>% group_by(X, m) %>% summarise(med = median(resi)) %>% ungroup()

p_resi_FC = ggplot(data_FC, aes(x = interaction(m, X), y = resi)) +
  geom_boxplot(width = 0.4, outlier.shape = NA)  + 
  guides(x = "axis_nested") + 
  geom_line(data = df_med, aes(x = as.numeric(m), y = med), alpha = 0.4) +
  facet_grid(. ~ X, space = "free_x", scales = "free_x") +
  theme_classic() +
  theme(ggh4x.axis.nesttext.x = element_text(angle = 45, hjust = 1), 
        legend.position = "none", panel.border = element_blank(), axis.line = element_line(),
        axis.line.x = element_blank(),
        # remove the facet labels
        strip.text.x = element_blank()) + 
  labs(x = " ", y = "", title = "Effect Size")


```



```{r, fig.height = 7, fig.width=12}
library(ggpubr)

P1 = plot_grid(p_resi_GMV + labs(title = "Total GMV", y = "RESI") + theme(axis.text.x = element_text(color="black"), axis.ticks = element_line(color = "black")),
              p_resi_ROI_vol + labs(title = "Regional GMV", y = "RESI") + theme(axis.text.x = element_text(color="black"), axis.ticks = element_line(color = "black")),
              p_resi_ROI_CT + labs(title = "Regional CT", y = "RESI") + theme(axis.text.x = element_text(color="black"), axis.ticks = element_line(color = "black")),
              p_resi_FC + labs(title = "Functional connectivity", y = "RESI") + theme(axis.text.x = element_text(color="black"), axis.ticks = element_line(color = "black")),
              labels = "auto", ncol = 2
              )

ggsave("figures_pdf/ED_Figure_6.pdf", plot = P1, width = 12, height = 7, units = "in")

```


## ED Fig. 7 & 8
Created in powerpoints.


# Extended Data (ED) Tables

## ED Tab. 1. Descriptive summary of the 63 studies used in the meta-analyses for global GMV, sGMV and WMV
```{r}
library(kableExtra)

study_info_clean <- readr::read_csv("data/analysis_data/whole_brain_measure/new/study_info_whole_brain.csv")

var_list = c("study", "N", "tot_obs", "Design", "mean_age", "m2_age", "m3_age", "mean_sex")
temp = study_info_clean[, var_list]
temp[, c("mean_age", "m2_age", "m3_age", "mean_sex")] %<>% round(2)
temp = temp[order(study_info_clean$N, decreasing = TRUE), ]
temp %>% kbl(caption = "Sample size and total number of observations in each study") %>% kable_classic(full_width = FALSE, html_font = "Cambria")
```

## ED Tab. 2. Non-brain measures in ABCD (release 5) for structural brain measures
```{r}
dat = readRDS("data/analysis_data/ABCD_release5_resamp_ROI_whole_brain.rds")


my.render.cont <- function(x) {
    with(stats.default(x), 
         c("",
           
          "Mean (SD)" = sprintf("%s (%s)",
                                round_pad(MEAN, 1),
                                round_pad(SD, 1)),
         
          "Median (Min, Max)" = sprintf("%s (%s, %s)",
                                       round_pad(MEDIAN, 1), 
                                       round_pad(MIN, 1), 
                                       round_pad(MAX, 1)),
          "N" = sprintf("%s",
                        N))
    )
}



table1(~ nihtbx_picvocab_fc + nihtbx_flanker_fc + nihtbx_list_fc + nihtbx_list_fc + nihtbx_cardsort_fc + nihtbx_pattern_fc + nihtbx_picture_fc + nihtbx_reading_fc + nihtbx_fluidcomp_fc + nihtbx_cryst_fc + nihtbx_totalcomp_fc + cbcl_scr_syn_totprob_t + bw + BMI + handedness | eventname, data = dat, reder = my.render.cont)
```

# Tables in Supplementary Information (SI)

## SI Tab. S1. Descriptive summary of the 43 studies used in the meta-analyses for mean CT and regional outcomes.
```{r}
study_info_clean_ROI <- readr::read_csv("data/analysis_data/ROI/study_info_clean_ROI.csv")

var_list = c("study", "N", "tot_obs", "Design", "mean_age", "m2_age", "m3_age", "mean_sex")
temp = study_info_clean_ROI[, var_list]
temp[, c("mean_age", "m2_age", "m3_age", "mean_sex")] %<>% round(2)
temp = temp[order(study_info_clean_ROI$N, decreasing = TRUE), ]
temp %>% kbl(caption = "Sample size and total number of observations in each study") %>% kable_classic(full_width = FALSE, html_font = "Cambria")

# total number of observations
temp = readr::read_csv("data/analysis_data/ROI/analysis_data_ROI_complete_case_combat.csv")
cat("Total number of observations:", nrow(temp))
# total number of individuals
cat("Total number of individuals:", paste0(temp$study, temp$participant) %>% unique %>% length)
```


## SI Tab. S2. Meta-analysis for RESI of age on total GMV (and SI Tab)

```{r, results='asis'}
study_info = readr::read_csv("data/analysis_data/whole_brain_measure/new/study_info_whole_brain.csv") %>% suppressMessages()
analysis_data_global <- read_csv("data/analysis_data/whole_brain_measure/new/analysis_data_whole_brain_combat.csv") %>% suppressMessages()
# GMV
ES_GMV = forest_plot(study_info = study_info, analysis_data = analysis_data_global, outcome = "GMV", x_ul = 2)
set.seed(2023)
meta_resi(ES = ES_GMV$ES, variable = "age", wls = TRUE)
```

```{r}
# The expected RESI increase for each unit increase of SD age
study_info = readr::read_csv("data/analysis_data/whole_brain_measure/new/study_info_whole_brain.csv") %>% suppressMessages()
analysis_data_global <- read_csv("data/analysis_data/whole_brain_measure/new/analysis_data_whole_brain_combat.csv") %>% suppressMessages()
ES_GMV = forest_plot(study_info = study_info, analysis_data = analysis_data_global, outcome = "GMV", x_ul = 2)
dat = ES_GMV$ES
dat$w = 1/dat$L_RESI_se_age
fit = glm(L_RESI_age ~ Design + splines::ns(mean_age, 3) + m2_age + splines::ns(m3_age, 3), data = dat, weights = w)
summary(fit)

# the expected (L-)RESI for age on total GMV in longituidnal and CS studies:
fit = glm(L_RESI_age ~ Design + splines::ns(mean_age, 3) + splines::ns(m2_age, 3) + splines::ns(m3_age, 3), data = dat, weights = w)
new_dat = data.frame(Design = c("Longitudinal", "Cross-sectional"), mean_age = 45, m2_age = 7, m3_age = 0 )
pred = predict(fit, newdata = new_dat)
cat("The expected RESI for age among the longitudinal studies is", round(pred[1], 2), "and",  round(pred[2], 2), "in cross-sectional studies (after fixing mean age = 45, SD of age = 7 and skewness = 0) \n")
cat("The difference is", pred[1] - pred[2])
```



## SI Tab. S3. Meta-analysis for RESI of age on total sGMV
```{r, results='asis'}
study_info = readr::read_csv("data/analysis_data/whole_brain_measure/new/study_info_whole_brain.csv") %>% suppressMessages()
analysis_data_global <- read_csv("data/analysis_data/whole_brain_measure/new/analysis_data_whole_brain_combat.csv") %>% suppressMessages()
# sGMV
ES_sGMV = forest_plot(study_info = study_info, analysis_data = analysis_data_global, outcome = "sGMV", x_ul = 2)
set.seed(2023)
meta_resi(ES = ES_sGMV$ES, variable = "age", wls = TRUE)
```

## SI Tab. S4. Meta-analysis for RESI of age on total WMV
```{r, results='asis'}
study_info = readr::read_csv("data/analysis_data/whole_brain_measure/new/study_info_whole_brain.csv") %>% suppressMessages()
analysis_data_global <- read_csv("data/analysis_data/whole_brain_measure/new/analysis_data_whole_brain_combat.csv") %>% suppressMessages()
# WMV
ES_WMV = forest_plot(study_info = study_info, analysis_data = analysis_data_global, outcome = "WMV", x_ul = 2)
set.seed(2023)
meta_resi(ES = ES_WMV$ES, variable = "age", wls = TRUE)
```

## SI Tab. S5. Meta-analysis for RESI of age on mean CT
```{r, results='asis'}
study_info_CT = read_csv("data/analysis_data/whole_brain_measure/new/CT/study_info_clean_global_CT.csv")
study_info_CT %<>% arrange(Design, m2_age)
study_info_CT$index_sd_age = 1:nrow(study_info_CT)

analysis_data_CT <- read_csv("data/analysis_data/whole_brain_measure/new/CT/analysis_data_global_CT_combat.csv")
analysis_data_CT %<>% as.data.frame 
analysis_data_CT$study %<>% factor(levels = study_info_CT$study)

ES_CT = forest_plot(study_info = study_info_CT, analysis_data = analysis_data_CT, outcome = "CT", x_ul = 2)

set.seed(2023)
meta_resi(ES = ES_CT$ES, variable = "age", wls = TRUE)

```


## SI Tab. S6. Meta-analysis for RESI of sex on total GMV
```{r, results='asis'}
study_info = readr::read_csv("data/analysis_data/whole_brain_measure/new/study_info_whole_brain.csv") %>% suppressMessages()
analysis_data_global <- read_csv("data/analysis_data/whole_brain_measure/new/analysis_data_whole_brain_combat.csv") %>% suppressMessages()
# GMV
ES_GMV = forest_plot(study_info = study_info, analysis_data = analysis_data_global, outcome = "GMV", x_ul = 2)
set.seed(2023)
meta_resi(ES = ES_GMV$ES, variable = "sex", wls = TRUE)
```

## SI Tab. S7. Meta-analysis for RESI of sex on total sGMV
```{r, results='asis'}
study_info = readr::read_csv("data/analysis_data/whole_brain_measure/new/study_info_whole_brain.csv") %>% suppressMessages()
analysis_data_global <- read_csv("data/analysis_data/whole_brain_measure/new/analysis_data_whole_brain_combat.csv") %>% suppressMessages()
# sGMV
ES_sGMV = forest_plot(study_info = study_info, analysis_data = analysis_data_global, outcome = "sGMV", x_ul = 2)
set.seed(2023)
meta_resi(ES = ES_sGMV$ES, variable = "sex", wls = TRUE)
```

## SI Tab. S8. Meta-analysis for RESI of sex on total WMV
```{r, results='asis'}
study_info = readr::read_csv("data/analysis_data/whole_brain_measure/new/study_info_whole_brain.csv") %>% suppressMessages()
analysis_data_global <- read_csv("data/analysis_data/whole_brain_measure/new/analysis_data_whole_brain_combat.csv") %>% suppressMessages()
# WMV
ES_WMV = forest_plot(study_info = study_info, analysis_data = analysis_data_global, outcome = "WMV", x_ul = 2)
set.seed(2023)
meta_resi(ES = ES_WMV$ES, variable = "sex", wls = TRUE)
```

## SI Tab. S9. Meta-analysis for RESI of sex on mean CT
```{r, results='asis'}
study_info_CT = read_csv("data/analysis_data/whole_brain_measure/new/CT/study_info_clean_global_CT.csv")
study_info_CT %<>% arrange(Design, m2_age)
study_info_CT$index_sd_age = 1:nrow(study_info_CT)

analysis_data_CT <- read_csv("data/analysis_data/whole_brain_measure/new/CT/analysis_data_global_CT_combat.csv")
analysis_data_CT %<>% as.data.frame 
analysis_data_CT$study %<>% factor(levels = study_info_CT$study)

ES_CT = forest_plot(study_info = study_info_CT, analysis_data = analysis_data_CT, outcome = "CT", x_ul = 2)

set.seed(2023)
meta_resi(ES = ES_CT$ES, variable = "sex", wls = TRUE)

```


## SI Tab. S10. Summary table of non-brain measures in the subset of ABCD used for FC outcome analysis.
```{r}
data <- read_csv("data/analysis_data/ABCD_FC.csv")

data$eventname %<>% factor(levels = c("baseline_year_1_arm_1", "2_year_follow_up_y_arm_1"), labels = c("Baseline", "2-year follow-up"))
data$handedness_impute %<>% factor(levels = 1:3, labels = c("Right-handed", "Not right-handed", "Not right-handed"))

my.render.cont <- function(x) {
    with(stats.default(x), 
         c("",
           
          "Mean (SD)" = sprintf("%s (%s)",
                                round_pad(MEAN, 1),
                                round_pad(SD, 1)),
         
          "Median (Min, Max)" = sprintf("%s (%s, %s)",
                                       round_pad(MEDIAN, 1), 
                                       round_pad(MIN, 1), 
                                       round_pad(MAX, 1)),
          "N" = sprintf("%s",
                        N))
    )
}

label(data$nihtbx_picvocab_fc) = "Picture Vocabulary Test"
label(data$nihtbx_flanker_fc) = "Flanker Inhibitory Control and Attention Test"
label(data$nihtbx_list_fc) = "List Sorting Working Memory Test"
label(data$nihtbx_cardsort_fc) = "Dimensional Change Card Sort Test"
label(data$nihtbx_pattern_fc) = "Pattern Comparison Processing Speed Test"
label(data$nihtbx_picture_fc) = "Picture Sequence Memory Test"
label(data$nihtbx_reading_fc) = "Oral Reading Recognition Test"
label(data$nihtbx_fluidcomp_fc) = "Cognition Fluid Composite"
label(data$nihtbx_cryst_fc) = "Crystallized Composite"
label(data$nihtbx_totalcomp_fc) = "Cognition Total Composite Score"

label(data$cbcl_scr_syn_totprob_t) = "Total Problem CBCL Syndrome Scale"
label(data$bw) = "Birth Weight"
label(data$BMI) = "BMI"
label(data$handedness_impute) = "Handedness"


data %<>% group_by(id) %>% mutate(num_obs = length(id)) %>% filter(num_obs == 2) %>% ungroup

table1(~ nihtbx_picvocab_fc + nihtbx_flanker_fc + nihtbx_list_fc + nihtbx_list_fc + nihtbx_cardsort_fc + nihtbx_pattern_fc + nihtbx_picture_fc + nihtbx_reading_fc + nihtbx_fluidcomp_fc + nihtbx_cryst_fc + nihtbx_totalcomp_fc + cbcl_scr_syn_totprob_t + bw + BMI + handedness_impute | eventname, data = data, reder = my.render.cont)

```


## SI Tab. S11. The estimated CS and L effects of non-brain covariates on total GMV in ABCD
```{r}
data <- readRDS("Results/CS_and_L_effects/GMV_nonbrain_covaraites_CS_L_effect_estimates.rds")
# 95% CI
data$beta_CS_ll = data$beta_CS - 1.96*data$beta_CS_se
data$beta_CS_ul = data$beta_CS + 1.96*data$beta_CS_se
data$beta_L_ll = data$beta_L - 1.96*data$beta_L_se
data$beta_L_ul = data$beta_L + 1.96*data$beta_L_se
# round
data[3:14] %<>% round(4)

data$beta_CS = with(data, paste0(beta_CS, " (", beta_CS_ll, ", ", beta_CS_ul, ")"))
data$beta_L = with(data, paste0(beta_L, " (", beta_L_ll, ", ", beta_L_ul, ")"))

data %>% dplyr::select(Y, X, beta_CS, beta_L, rho)
```

# Figures in the Supplement Information (SI)

## SI Fig. S1. Scatter plots

```{r, fig.height=6, fig.width=8}
study_info = readr::read_csv("data/analysis_data/whole_brain_measure/new/study_info_whole_brain.csv")
study_info %<>% arrange(Design, m2_age)

analysis_data <- read_csv("data/analysis_data/whole_brain_measure/new/analysis_data_whole_brain_combat.csv") 
analysis_data %<>% as.data.frame 
analysis_data$sex = ifelse(analysis_data$sex_01 == 0, "Female", "Male")

study_list = study_info[order(study_info$N, decreasing = TRUE),]
study_names = study_list$study[1:12] %>% as.character() 
plot_data = subset(analysis_data, study %in% study_names)
plot_data$study %<>% factor(levels = study_names)
# P1: scatter plots
P1 = ggplot(data = plot_data, aes(y = GMV_10000_combat, x = age_years)) + 
      geom_point(alpha = 0.2, aes(col = sex)) + 
      geom_smooth(formula = y ~ x, method = loess) + 
      facet_wrap(~ study) + labs(title = "", y = 'Harmonized total GMV / 10000', x = 'Age (in years)') + theme_bw() + theme(legend.position="bottom") 

P1
# P1 = plot_grid(P1, labels = c("(A)"), ncol = 1) %>% suppressWarnings()

ggsave("figures_pdf/SI_Figure_1_scatter_plot.pdf", width = 8, height = 6, units = "in")
```

## SI Fig. S2. Meta-analysis results of sex effects (partial regression plots)
```{r, fig.height=10, fig.width=12}
library(splines)
study_info = readr::read_csv("data/analysis_data/whole_brain_measure/new/study_info_whole_brain.csv")
analysis_data_global <- read_csv("data/analysis_data/whole_brain_measure/new/analysis_data_whole_brain_combat.csv")
# GMV
ES_GMV = forest_plot(study_info = study_info, analysis_data = analysis_data_global, outcome = "GMV", x_ul = 2)
# sGMV
ES_sGMV = forest_plot(study_info = study_info, analysis_data = analysis_data_global, outcome = "sGMV", x_ul = 2)
# WMV
ES_WMV = forest_plot(study_info = study_info, analysis_data = analysis_data_global, outcome = "WMV", x_ul = 2)

# mean CT
study_info_CT = study_info_CT = read_csv("data/analysis_data/whole_brain_measure/new/CT/study_info_clean_global_CT.csv")
study_info_CT %<>% arrange(Design, m2_age)
study_info_CT$index_sd_age = 1:nrow(study_info_CT)

analysis_data_CT <- read_csv("data/analysis_data/whole_brain_measure/new/CT/analysis_data_global_CT_combat.csv")
analysis_data_CT %<>% as.data.frame 
analysis_data_CT$study %<>% factor(levels = study_info_CT$study)

ES_CT = forest_plot(study_info = study_info_CT, analysis_data = analysis_data_CT, outcome = "CT", x_ul = 2)


# ---- GMV ------
# added variable plots
# with Long RESI
plot_data = ES_GMV$ES
plot_data$w = 1/plot_data$L_RESI_se_sex
fit = lm(L_RESI_sex ~ Design + ns(mean_age, 3) + ns(m2_age, 3) + ns(mean_sex, 3),
         data = plot_data, weights = w)
# residuals
plot_data$res = residuals(fit)
# the mean of sd(age) and skewness(age)
# mean_mean_age = plot_data$mean_age %>% weighted.mean(w = plot_data$N) # = 45
# mean_sd_age = plot_data$m2_age %>% weighted.mean(w = plot_data$N) # = 7
# mean_skew_age = plot_data$m3_age %>% weighted.mean(w = plot_data$N) # = 0


# vs mean age
## the expected value of L-RESI over mean age when mean and SD of sex are fixed at typiecal levels
## for the points
new_data = plot_data
new_data$Design = "Cross-sectional"
new_data$m2_age = 7
new_data$mean_sex = 0.5
plot_data$pred_L_RESI_sex = predict(fit, newdata = new_data)
## for the lines
data_line = data.frame(mean_age = seq(0, 80, by = 0.1), m2_age = 7, mean_sex = 0.5, Design = "Cross-sectional")
pred = predict(fit, newdata = data_line, interval = "confidence")
data_line = cbind(data_line, pred)
p1 = ggplot() + 
  geom_point(data = plot_data, aes(y = pred_L_RESI_sex + res, x =  mean_age)) + 
  geom_ribbon(data = data_line, aes(ymin = lwr, ymax = upr, x = mean_age), fill = "grey", alpha = 0.6) +
  geom_line(data = data_line, aes(y = fit, x = mean_age), col = "dodgerblue2", size = 1) + 
  ylim(-0.5, 1.9) +
  theme_classic() + labs(title = " ", y = 'RESI', x = 'Mean age | other')

# vs SD(age)
new_data = plot_data
new_data$Design = "Cross-sectional"
new_data$mean_age = 45
new_data$mean_sex = 0.5
plot_data$pred_L_RESI_sex = predict(fit, newdata = new_data)
## for the lines
data_line = data.frame(mean_age = 45, m2_age = seq(0, 20, by = 0.1), mean_sex = 0.5, Design = "Cross-sectional")
pred = predict(fit, newdata = data_line, interval = "confidence")
data_line = cbind(data_line, pred)
p2 = ggplot() + geom_point(data = plot_data, aes(y = pred_L_RESI_sex + res, x =  m2_age)) + 
    geom_ribbon(data = data_line, aes(ymin = lwr, ymax = upr, x = m2_age), fill = "grey", alpha = 0.6) +
    geom_line(data = data_line, aes(y = fit, x = m2_age), col = "dodgerblue2", size = 1) + 
    ylim(-1, 1.5) +
    theme_classic() + labs(title = "", y = 'RESI', x = 'SD of age | other')


# P3: estimated RESI vs mean(sex)
new_data = plot_data
new_data$Design = "Cross-sectional"
new_data$mean_age = 45
new_data$m2_age = 7
plot_data$pred_L_RESI_sex = predict(fit, newdata = new_data)
## for the lines
data_line = data.frame(mean_age = 45, m2_age = 7, mean_sex = seq(0, 1, by = 0.01), Design = "Cross-sectional")
pred = predict(fit, newdata = data_line, interval = "confidence")
data_line = cbind(data_line, pred)
p3 = ggplot() + geom_point(data = plot_data, aes(y = pred_L_RESI_sex + res, x =  mean_sex)) +
      geom_ribbon(data = data_line, aes(ymin = lwr, ymax = upr, x = mean_sex), fill = "grey", alpha = 0.5) +
      geom_line(data = data_line, aes(y = fit, x = mean_sex), col = "dodgerblue2", size = 1) +
      ylim(-1, 2) +
      theme_classic() + labs(title = "", y = 'RESI', x = 'Proportion of male | other')


# p4: estimated RESI vs design
new_data = plot_data
new_data$mean_age = 45
new_data$m2_age = 7
new_data$mean_sex = 0.5
plot_data$pred_L_RESI_sex = predict(fit, newdata = new_data)
## for the lines
data_line = data.frame(mean_age = 45, m2_age = 0.5, mean_sex = 0.5, Design = c("Cross-sectional", "Longitudinal"))
pred = predict(fit, newdata = data_line, interval = "confidence")
data_line = cbind(data_line, pred)
p4 = ggplot(data = plot_data, aes(y = pred_L_RESI_sex + res, x =  Design)) + 
      geom_boxplot( fill='#A4A4A4', color="black") + 
      ylim(0, 1.2) +
      theme_classic() + labs(title = "", y = 'RESI', x = 'Design | other')

P1 = cowplot::plot_grid(p1, p2, p3, p4, labels = c("a  Total GMV"), nrow = 1, hjust = 0) # %>% suppressWarnings()



# ---- sGMV ------
# added variable plots
# with modified RESI
plot_data = ES_sGMV$ES
plot_data$w = 1/plot_data$L_RESI_se_sex
fit = lm(L_RESI_sex ~ Design + ns(mean_age, 3) + ns(m2_age, 3) + ns(mean_sex, 3),
         data = plot_data, weights = w)
# residuals
plot_data$res = residuals(fit)
# the mean of sd(age) and skewness(age)
# mean_mean_age = plot_data$mean_age %>% weighted.mean(w = plot_data$N) # = 45
# mean_sd_age = plot_data$m2_age %>% weighted.mean(w = plot_data$N) # = 7
# mean_skew_age = plot_data$m3_age %>% weighted.mean(w = plot_data$N) # = 0


# vs mean age
## the expected value of L-RESI over mean age when mean and SD of sex are fixed at typiecal levels
## for the points
new_data = plot_data
new_data$Design = "Cross-sectional"
new_data$m2_age = 7
new_data$mean_sex = 0.5
plot_data$pred_L_RESI_sex = predict(fit, newdata = new_data)
## for the lines
data_line = data.frame(mean_age = seq(0, 80, by = 0.1), m2_age = 7, mean_sex = 0.5, Design = "Cross-sectional")
pred = predict(fit, newdata = data_line, interval = "confidence")
data_line = cbind(data_line, pred)
p1 = ggplot() + 
  geom_point(data = plot_data, aes(y = pred_L_RESI_sex + res, x =  mean_age)) + 
  geom_ribbon(data = data_line, aes(ymin = lwr, ymax = upr, x = mean_age), fill = "grey", alpha = 0.6) +
  geom_line(data = data_line, aes(y = fit, x = mean_age), col = "dodgerblue2", size = 1) + 
  ylim(-0.5, 1.9) +
  theme_classic() + labs(title = " ", y = 'RESI', x = 'Mean age | other')

# vs SD(age)
new_data = plot_data
new_data$Design = "Cross-sectional"
new_data$mean_age = 45
new_data$mean_sex = 0.5
plot_data$pred_L_RESI_sex = predict(fit, newdata = new_data)
## for the lines
data_line = data.frame(mean_age = 45, m2_age = seq(0, 20, by = 0.1), mean_sex = 0.5, Design = "Cross-sectional")
pred = predict(fit, newdata = data_line, interval = "confidence")
data_line = cbind(data_line, pred)
p2 = ggplot() + geom_point(data = plot_data, aes(y = pred_L_RESI_sex + res, x =  m2_age)) + 
    geom_ribbon(data = data_line, aes(ymin = lwr, ymax = upr, x = m2_age), fill = "grey", alpha = 0.6) +
    geom_line(data = data_line, aes(y = fit, x = m2_age), col = "dodgerblue2", size = 1) + 
    ylim(-1, 1.5) +
    theme_classic() + labs(title = "", y = 'RESI', x = 'SD of age | other')


# P3: estimated RESI vs mean(sex)
new_data = plot_data
new_data$Design = "Cross-sectional"
new_data$mean_age = 45
new_data$m2_age = 7
plot_data$pred_L_RESI_sex = predict(fit, newdata = new_data)
## for the lines
data_line = data.frame(mean_age = 45, m2_age = 7, mean_sex = seq(0, 1, by = 0.01), Design = "Cross-sectional")
pred = predict(fit, newdata = data_line, interval = "confidence")
data_line = cbind(data_line, pred)
p3 = ggplot() + geom_point(data = plot_data, aes(y = pred_L_RESI_sex + res, x =  mean_sex)) +
      geom_ribbon(data = data_line, aes(ymin = lwr, ymax = upr, x = mean_sex), fill = "grey", alpha = 0.5) +
      geom_line(data = data_line, aes(y = fit, x = mean_sex), col = "dodgerblue2", size = 1) +
      ylim(-1, 2) +
      theme_classic() + labs(title = "", y = 'RESI', x = 'Proportion of male | other')


# p4: estimated RESI vs design
new_data = plot_data
new_data$mean_age = 45
new_data$m2_age = 7
new_data$mean_sex = 0.5
plot_data$pred_L_RESI_sex = predict(fit, newdata = new_data)
## for the lines
data_line = data.frame(mean_age = 45, m2_age = 0.5, mean_sex = 0.5, Design = c("Cross-sectional", "Longitudinal"))
pred = predict(fit, newdata = data_line, interval = "confidence")
data_line = cbind(data_line, pred)
p4 = ggplot(data = plot_data, aes(y = pred_L_RESI_sex + res, x =  Design)) + 
      geom_boxplot( fill='#A4A4A4', color="black") + 
      ylim(0, 1.2) +
      theme_classic() + labs(title = "", y = 'RESI', x = 'Design | other')

P2 = cowplot::plot_grid(p1, p2, p3, p4, labels = c("b  Total sGMV"), nrow = 1, hjust = 0) # %>% suppressWarnings()




# ---- WMV ------
# added variable plots
# with modified RESI
plot_data = ES_WMV$ES
plot_data$w = 1/plot_data$L_RESI_se_sex
fit = lm(L_RESI_sex ~ Design + ns(mean_age, 3) + ns(m2_age, 3) + ns(mean_sex, 3),
         data = plot_data, weights = w)
# residuals
plot_data$res = residuals(fit)
# the mean of sd(age) and skewness(age)
# mean_mean_age = plot_data$mean_age %>% weighted.mean(w = plot_data$N) # = 45
# mean_sd_age = plot_data$m2_age %>% weighted.mean(w = plot_data$N) # = 7
# mean_skew_age = plot_data$m3_age %>% weighted.mean(w = plot_data$N) # = 0


# vs mean age
## the expected value of L-RESI over mean age when mean and SD of sex are fixed at typiecal levels
## for the points
new_data = plot_data
new_data$Design = "Cross-sectional"
new_data$m2_age = 7
new_data$mean_sex = 0.5
plot_data$pred_L_RESI_sex = predict(fit, newdata = new_data)
## for the lines
data_line = data.frame(mean_age = seq(0, 80, by = 0.1), m2_age = 7, mean_sex = 0.5, Design = "Cross-sectional")
pred = predict(fit, newdata = data_line, interval = "confidence")
data_line = cbind(data_line, pred)
p1 = ggplot() + 
  geom_point(data = plot_data, aes(y = pred_L_RESI_sex + res, x =  mean_age)) + 
  geom_ribbon(data = data_line, aes(ymin = lwr, ymax = upr, x = mean_age), fill = "grey", alpha = 0.6) +
  geom_line(data = data_line, aes(y = fit, x = mean_age), col = "dodgerblue2", size = 1) + 
  ylim(-0.5, 1.9) +
  theme_classic() + labs(title = " ", y = 'RESI', x = 'Mean age | other')

# vs SD(age)
new_data = plot_data
new_data$Design = "Cross-sectional"
new_data$mean_age = 45
new_data$mean_sex = 0.5
plot_data$pred_L_RESI_sex = predict(fit, newdata = new_data)
## for the lines
data_line = data.frame(mean_age = 45, m2_age = seq(0, 20, by = 0.1), mean_sex = 0.5, Design = "Cross-sectional")
pred = predict(fit, newdata = data_line, interval = "confidence")
data_line = cbind(data_line, pred)
p2 = ggplot() + geom_point(data = plot_data, aes(y = pred_L_RESI_sex + res, x =  m2_age)) + 
    geom_ribbon(data = data_line, aes(ymin = lwr, ymax = upr, x = m2_age), fill = "grey", alpha = 0.6) +
    geom_line(data = data_line, aes(y = fit, x = m2_age), col = "dodgerblue2", size = 1) + 
    ylim(-1, 1.5) +
    theme_classic() + labs(title = "", y = 'RESI', x = 'SD of age | other')


# P3: estimated RESI vs mean(sex)
new_data = plot_data
new_data$Design = "Cross-sectional"
new_data$mean_age = 45
new_data$m2_age = 7
plot_data$pred_L_RESI_sex = predict(fit, newdata = new_data)
## for the lines
data_line = data.frame(mean_age = 45, m2_age = 7, mean_sex = seq(0, 1, by = 0.01), Design = "Cross-sectional")
pred = predict(fit, newdata = data_line, interval = "confidence")
data_line = cbind(data_line, pred)
p3 = ggplot() + geom_point(data = plot_data, aes(y = pred_L_RESI_sex + res, x =  mean_sex)) +
      geom_ribbon(data = data_line, aes(ymin = lwr, ymax = upr, x = mean_sex), fill = "grey", alpha = 0.5) +
      geom_line(data = data_line, aes(y = fit, x = mean_sex), col = "dodgerblue2", size = 1) +
      ylim(-1, 2) +
      theme_classic() + labs(title = "", y = 'RESI', x = 'Proportion of male | other')


# p4: estimated RESI vs design
new_data = plot_data
new_data$mean_age = 45
new_data$m2_age = 7
new_data$mean_sex = 0.5
plot_data$pred_L_RESI_sex = predict(fit, newdata = new_data)
## for the lines
data_line = data.frame(mean_age = 45, m2_age = 0.5, mean_sex = 0.5, Design = c("Cross-sectional", "Longitudinal"))
pred = predict(fit, newdata = data_line, interval = "confidence")
data_line = cbind(data_line, pred)
p4 = ggplot(data = plot_data, aes(y = pred_L_RESI_sex + res, x =  Design)) + 
      geom_boxplot( fill='#A4A4A4', color="black") + 
      ylim(0, 1.2) +
      theme_classic() + labs(title = "", y = 'RESI', x = 'Design | other')

P3 = cowplot::plot_grid(p1, p2, p3, p4, labels = c("c  Total WMV"), nrow = 1, hjust = 0) # %>% suppressWarnings()

# ---- mean CT ------
# with Long RESI
plot_data = ES_CT$ES
plot_data$w = 1/plot_data$L_RESI_se_sex
fit = lm(L_RESI_sex ~ Design + ns(mean_age, 3) + ns(m2_age, 3) + ns(mean_sex, 3),
         data = plot_data, weights = w)
# residuals
plot_data$res = residuals(fit)
# the mean of sd(age) and skewness(age)
# mean_mean_age = plot_data$mean_age %>% weighted.mean(w = plot_data$N) # = 45
# mean_sd_age = plot_data$m2_age %>% weighted.mean(w = plot_data$N) # = 7
# mean_skew_age = plot_data$m3_age %>% weighted.mean(w = plot_data$N) # = 0


# vs mean age
## the expected value of L-RESI over mean age when mean and SD of sex are fixed at typiecal levels
## for the points
new_data = plot_data
new_data$Design = "Cross-sectional"
new_data$m2_age = 7
new_data$mean_sex = 0.5
plot_data$pred_L_RESI_sex = predict(fit, newdata = new_data)
## for the lines
data_line = data.frame(mean_age = seq(0, 80, by = 0.1), m2_age = 7, mean_sex = 0.5, Design = "Cross-sectional")
pred = predict(fit, newdata = data_line, interval = "confidence")
data_line = cbind(data_line, pred)
p1 = ggplot() + 
  geom_point(data = plot_data, aes(y = pred_L_RESI_sex + res, x =  mean_age)) + 
  geom_ribbon(data = data_line, aes(ymin = lwr, ymax = upr, x = mean_age), fill = "grey", alpha = 0.6) +
  geom_line(data = data_line, aes(y = fit, x = mean_age), col = "dodgerblue2", size = 1) + 
  ylim(-0.5, 1.9) +
  theme_classic() + labs(title = " ", y = 'RESI', x = 'Mean age | other')

# vs SD(age)
new_data = plot_data
new_data$Design = "Cross-sectional"
new_data$mean_age = 45
new_data$mean_sex = 0.5
plot_data$pred_L_RESI_sex = predict(fit, newdata = new_data)
## for the lines
data_line = data.frame(mean_age = 45, m2_age = seq(0, 20, by = 0.1), mean_sex = 0.5, Design = "Cross-sectional")
pred = predict(fit, newdata = data_line, interval = "confidence")
data_line = cbind(data_line, pred)
p2 = ggplot() + geom_point(data = plot_data, aes(y = pred_L_RESI_sex + res, x =  m2_age)) + 
    geom_ribbon(data = data_line, aes(ymin = lwr, ymax = upr, x = m2_age), fill = "grey", alpha = 0.6) +
    geom_line(data = data_line, aes(y = fit, x = m2_age), col = "dodgerblue2", size = 1) + 
    ylim(-1, 1.5) +
    theme_classic() + labs(title = "", y = 'RESI', x = 'SD of age | other')


# P3: estimated RESI vs mean(sex)
new_data = plot_data
new_data$Design = "Cross-sectional"
new_data$mean_age = 45
new_data$m2_age = 7
plot_data$pred_L_RESI_sex = predict(fit, newdata = new_data)
## for the lines
data_line = data.frame(mean_age = 45, m2_age = 7, mean_sex = seq(0, 1, by = 0.01), Design = "Cross-sectional")
pred = predict(fit, newdata = data_line, interval = "confidence")
data_line = cbind(data_line, pred)
p3 = ggplot() + geom_point(data = plot_data, aes(y = pred_L_RESI_sex + res, x =  mean_sex)) +
      geom_ribbon(data = data_line, aes(ymin = lwr, ymax = upr, x = mean_sex), fill = "grey", alpha = 0.5) +
      geom_line(data = data_line, aes(y = fit, x = mean_sex), col = "dodgerblue2", size = 1) +
      ylim(-1, 2) +
      theme_classic() + labs(title = "", y = 'RESI', x = 'Proportion of male | other')


# p4: estimated RESI vs design
new_data = plot_data
new_data$mean_age = 45
new_data$m2_age = 7
new_data$mean_sex = 0.5
plot_data$pred_L_RESI_sex = predict(fit, newdata = new_data)
## for the lines
data_line = data.frame(mean_age = 45, m2_age = 0.5, mean_sex = 0.5, Design = c("Cross-sectional", "Longitudinal"))
pred = predict(fit, newdata = data_line, interval = "confidence")
data_line = cbind(data_line, pred)
p4 = ggplot(data = plot_data, aes(y = pred_L_RESI_sex + res, x =  Design)) + 
      geom_boxplot( fill='#A4A4A4', color="black") + 
      ylim(0, 1.2) +
      theme_classic() + labs(title = "", y = 'RESI', x = 'Design | other') 

P4 = cowplot::plot_grid(p1, p2, p3, p4, labels = c("d  Mean CT"), nrow = 1, hjust = 0) # %>% suppressWarnings()



#-------------
# P = grid.arrange(
#   P1, P2, P3, P4,
#   layout_matrix = rbind(c(1),
#                         c(2),
#                         c(3),
#                         4)
# ) #%>% suppressWarnings()
P = cowplot::plot_grid(P1, P2, P3, P4, ncol = 1)

ggsave("figures_pdf/SI_Figure_2_meta_analysis_sex.pdf", width = 12, height = 10, units = "in")

```



## SI Fig. S3. Repeat Fig. S8 with LMMs

```{r}
library(Hmisc)
library(ggh4x)

#  effect of using longitudinal designs -------------

# results for regional outcomes (Reginal GMV and CT)
filenames <- list.files("Results/ABCD_CS_L_analysis", pattern = "bl_and_full_data_analysis_ROI",  full.names=TRUE)

plot_data_ROI = NULL
for (i in 1:length(filenames)){
  temp = readRDS(filenames[i])
  plot_data_ROI = rbind(plot_data_ROI, temp)
}

# labels for ROI outcomes
outcome = lapply(plot_data_ROI$Y %>% as.character, FUN = function(x){
  z = strsplit(x, split = "_") %>% unlist
  return(z[2])
}) %>% unlist

plot_data_ROI$outcome_type = NA
plot_data_ROI$outcome_type[outcome == "Vol"] = "Regional Vol"
plot_data_ROI$outcome_type[outcome == "CT"] = "Regional CT"

# results for FC outcomes
plot_data_FC <- readRDS("Results/ABCD_CS_L_analysis/FC_results_bl_and_full_data_analyses.rds")
plot_data_FC$outcome_type = "FC"
plot_data_FC$X[plot_data_FC$X == "handedness_impute"] = "handedness"

# results for total GMV
plot_data_GMV <- readRDS("Results/ABCD_CS_L_analysis/bl_and_full_data_analysis_GMV.rds")
plot_data_GMV$outcome_type = "Total GMV"

# plot data
plot_data = rbind(plot_data_ROI, plot_data_FC)

plot_data = subset(plot_data, X %in% c("nihtbx_totalcomp_fc", "nihtbx_cardsort_fc", "nihtbx_fluidcomp_fc",
                                       "nihtbx_cryst_fc", "nihtbx_flanker_fc", "nihtbx_list_fc", "nihtbx_pattern_fc",
                                       "nihtbx_picture_fc",  "nihtbx_picvocab_fc",  "nihtbx_reading_fc",
                                       "BMI", "cbcl_scr_syn_totprob_t", "bw", "handedness") )


# adding labels for the covariates
plot_data$X %<>% factor(levels = c("nihtbx_totalcomp_fc", "nihtbx_cardsort_fc", "nihtbx_fluidcomp_fc", 
                                   "nihtbx_cryst_fc", "nihtbx_flanker_fc", "nihtbx_list_fc", "nihtbx_pattern_fc", 
                                   "nihtbx_picture_fc",  "nihtbx_picvocab_fc",  "nihtbx_reading_fc",
                                   "cbcl_scr_syn_totprob_t",
                                   "BMI", "bw", "handedness"),
                        labels = c("Cgntn Ttl Cmpst Scr", "Dmnsnl Chng Crd Srt", "Cgntn Fld Cmpst",
                                   "Crystllzd Cmpst", "Flnkr Inhbtry Ctrl", "Lst Srtng Wrkng Mmry", "Pttrn Cmprsn Prcssng Spd",
                                   "Pctr Sqnc Mmry", "Pctr Vcblry", "Orl Rdng Rcgntn",
                                   "CBCL",
                                   "BMI", "Birth Weight", "Handedness")
)


# ----- 1. outcome GMV -------

data_GMV = plot_data_GMV
# adding labels for the covariates
data_GMV$X %<>% factor(levels = c("nihtbx_totalcomp_fc", "nihtbx_cardsort_fc", "nihtbx_fluidcomp_fc", 
                                   "nihtbx_cryst_fc", "nihtbx_flanker_fc", "nihtbx_list_fc", "nihtbx_pattern_fc", 
                                   "nihtbx_picture_fc",  "nihtbx_picvocab_fc",  "nihtbx_reading_fc",
                                   "cbcl_scr_syn_totprob_t",
                                   "BMI", "bw", "handedness"),
                        labels = c("Cgntn Ttl Cmpst Scr", "Dmnsnl Chng Crd Srt", "Cgntn Fld Cmpst",
                                   "Crystllzd Cmpst", "Flnkr Inhbtry Ctrl", "Lst Srtng Wrkng Mmry", "Pttrn Cmprsn Prcssng Spd",
                                   "Pctr Sqnc Mmry", "Pctr Vcblry", "Orl Rdng Rcgntn",
                                   "CBCL",
                                   "BMI", "Birth Weight", "Handedness")
)


# reformat plot data
# Full data
m_all = data_GMV %>% dplyr::select(X, Y, lmm_resi_full)
m_all$lmm_resi_full_ll = m_all$lmm_resi_full_ul = NA
m_all$m = "all"
m_all %<>% rename(resi = lmm_resi_full,
               resi_ll = lmm_resi_full_ll,
               resi_ul = lmm_resi_full_ul)

# baseline (1st)
m1 = data_GMV %>% dplyr::select(X, Y, resi_bl, resi_bl_ll, resi_bl_ul)
m1$m = "1st"
m1 %<>% rename(resi = resi_bl,
               resi_ll = resi_bl_ll,
               resi_ul = resi_bl_ul)

# 2nd measurement
m2 = data_GMV %>% dplyr::select(X, Y, resi_2nd, resi_2nd_ll, resi_2nd_ul)
m2$m = "2nd"
m2 %<>% rename(resi = resi_2nd,
               resi_ll = resi_2nd_ll,
               resi_ul = resi_2nd_ul)

data_GMV = rbind(m1, m2, m_all)
data_GMV$m %<>% factor()
data_GMV$resi %<>% as.numeric()
data_GMV$resi_ll %<>% as.numeric()
data_GMV$resi_ul %<>% as.numeric()

p_resi_GMV = ggplot(data_GMV, aes(x = interaction(m, X), y = resi, ymin = resi_ll, ymax = resi_ul)) +
  geom_errorbar(width = .35) + 
  geom_point(size = 1.5) + 
  guides(x = "axis_nested") + 
  geom_line(aes(x = as.numeric(m), y = resi), alpha = 0.2) +
  facet_grid(. ~ X, space = "free_x", scales = "free_x") +
  theme_classic() +
  theme(ggh4x.axis.nesttext.x = element_text(angle = 45, hjust = 1), 
        legend.position = "none", panel.border = element_blank(), axis.line = element_line(),
        axis.line.x = element_blank(),
        # remove the facet labels
        strip.text.x = element_blank()) + 
  labs(x = " ", y = "", title = "Effect Size")

# ----- 2. outcome regional GMV -------

data_ROI_vol = subset(plot_data, outcome_type == "Regional Vol")

# reformat plot data
m_all = data_ROI_vol %>% dplyr::select(X, Y, lmm_resi_full)
m_all$m = "all"
m_all %<>% rename(resi = lmm_resi_full)

m1 = data_ROI_vol %>% dplyr::select(X, Y, resi_bl)
m1$m = "1st"
m1 %<>% rename(resi = resi_bl)

m2 = data_ROI_vol %>% dplyr::select(X, Y, resi_2nd)
m2$m = "2nd"
m2 %<>% rename(resi = resi_2nd)

data_ROI_vol = rbind(m1, m2, m_all)
data_ROI_vol$m %<>% factor()
data_ROI_vol$resi %<>% as.numeric()


# RESI
df_med = data_ROI_vol %>% group_by(X, m) %>% summarise(med = median(resi)) %>% ungroup()

p_resi_ROI_vol = ggplot(data_ROI_vol, aes(x = interaction(m, X), y = resi)) +
  geom_boxplot(width = 0.4, outlier.shape = NA)  + 
  guides(x = "axis_nested") + 
  geom_line(data = df_med, aes(x = as.numeric(m), y = med), alpha = 0.4) +
  facet_grid(. ~ X, space = "free_x", scales = "free_x") +
  theme_classic() +
  theme(ggh4x.axis.nesttext.x = element_text(angle = 45, hjust = 1), 
        legend.position = "none", panel.border = element_blank(), axis.line = element_line(),
        axis.line.x = element_blank(),
        # remove the facet labels
        strip.text.x = element_blank()) + 
  labs(x = " ", y = "", title = "Effect Size")

# ----- 3. outcome regional CT -------

data_ROI_CT = subset(plot_data, outcome_type == "Regional CT")

# reformat plot data
m_all = data_ROI_CT %>% dplyr::select(X, Y, lmm_resi_full)
m_all$m = "all"
m_all %<>% rename(resi = lmm_resi_full)

m1 = data_ROI_CT %>% dplyr::select(X, Y, resi_bl)
m1$m = "1st"
m1 %<>% rename(resi = resi_bl)

m2 = data_ROI_CT %>% dplyr::select(X, Y, resi_2nd)
m2$m = "2nd"
m2 %<>% rename(resi = resi_2nd)

data_ROI_CT = rbind(m1, m2, m_all)
data_ROI_CT$m %<>% factor()
data_ROI_CT$resi %<>% as.numeric()

# RESI
df_med = data_ROI_CT %>% group_by(X, m) %>% summarise(med = median(resi)) %>% ungroup()

p_resi_ROI_CT = ggplot(data_ROI_CT, aes(x = interaction(m, X), y = resi)) +
  geom_boxplot(width = 0.4, outlier.shape = NA)  + 
  guides(x = "axis_nested") + 
  geom_line(data = df_med, aes(x = as.numeric(m), y = med), alpha = 0.4) +
  facet_grid(. ~ X, space = "free_x", scales = "free_x") +
  theme_classic() +
  theme(ggh4x.axis.nesttext.x = element_text(angle = 45, hjust = 1), 
        legend.position = "none", panel.border = element_blank(), axis.line = element_line(),
        axis.line.x = element_blank(),
        # remove the facet labels
        strip.text.x = element_blank()) + 
  labs(x = " ", y = "", title = "Effect Size")

# ------ 4. outcome: RSFC ---------
data_FC = subset(plot_data, outcome_type == "FC")

# reformat plot data
m_all = data_FC %>% dplyr::select(X, Y, lmm_resi_full)
m_all$m = "all"
m_all %<>% rename(resi = lmm_resi_full)

m1 = data_FC %>% dplyr::select(X, Y, resi_bl)
m1$m = "1st"
m1 %<>% rename(resi = resi_bl)

m2 = data_FC %>% dplyr::select(X, Y, resi_2nd)
m2$m = "2nd"
m2 %<>% rename(resi = resi_2nd)

data_FC = rbind(m1, m2, m_all)
data_FC$m %<>% factor()
data_FC$resi %<>% as.numeric()

# RESI
df_med = data_FC %>% group_by(X, m) %>% summarise(med = median(resi)) %>% ungroup()

p_resi_FC = ggplot(data_FC, aes(x = interaction(m, X), y = resi)) +
  geom_boxplot(width = 0.4, outlier.shape = NA)  + 
  guides(x = "axis_nested") + 
  geom_line(data = df_med, aes(x = as.numeric(m), y = med), alpha = 0.4) +
  facet_grid(. ~ X, space = "free_x", scales = "free_x") +
  theme_classic() +
  theme(ggh4x.axis.nesttext.x = element_text(angle = 45, hjust = 1), 
        legend.position = "none", panel.border = element_blank(), axis.line = element_line(),
        axis.line.x = element_blank(),
        # remove the facet labels
        strip.text.x = element_blank()) + 
  labs(x = " ", y = "", title = "Effect Size")


```



```{r, fig.height = 12, fig.width=9}
library(ggpubr)

P1 = plot_grid(p_resi_GMV + labs(title = "Total GMV", y = "RESI") + theme(axis.text.x = element_text(color="black"), axis.ticks = element_line(color = "black")),
              p_resi_ROI_vol + labs(title = "Regional GMV", y = "RESI") + theme(axis.text.x = element_text(color="black"), axis.ticks = element_line(color = "black")),
              p_resi_ROI_CT + labs(title = "Regional CT", y = "RESI") + theme(axis.text.x = element_text(color="black"), axis.ticks = element_line(color = "black")),
              p_resi_FC + labs(title = "Functional connectivity", y = "RESI") + theme(axis.text.x = element_text(color="black"), axis.ticks = element_line(color = "black")),
              labels = "auto", ncol = 1
              )

ggsave("figures_pdf/SI_Figure_3_effect_of_longitudinal_design_LMM.pdf", width = 9, height = 12, units = "in")

```

## SI Fig. S4. The between- and within-subject association of age and GMV in ADNI

```{r, fig.width=8, fig.height=4}
analysis_data = readr::read_csv("data/analysis_data/whole_brain_measure/new/analysis_data_whole_brain_combat.csv")

# ------- GMV vs age in ADNI ----------
ADNI = subset(analysis_data, study == "ADNI")

ADNI %<>% arrange(participant, age_years) %>% group_by(participant) %>% 
  mutate(visit = 1:n(),
         num_obs = length(participant),
         D_GMV = GMV_10000_combat - GMV_10000_combat[which.min(age_years)],
         D_age = age_years - min(age_years)) 
ADNI = subset(ADNI, num_obs != 1)
# baseline age vs baseline GMV in ADNI
temp = subset(ADNI, visit == 1)
p_bl = ggplot(data = temp, aes(x = age_years, y = GMV_10000_combat)) + geom_point(alpha = 0.4) + geom_smooth(method = "lm", formula = "y ~ x") + theme_classic() + labs(title = "", y = "Baseline GMV/10000", x = "Baseline age")

# chagne in age vs change in GMV in ADNI
temp = subset(ADNI, visit != 1)
p_D = ggplot(data = temp, aes(x = D_age, y = D_GMV)) + geom_point(alpha = 0.4) + geom_smooth(method = "lm", formula = "y ~ x") + theme_classic() + labs(title = "", y = "Change in GMV/10000", x = "Change in age")

P1 = plot_grid(p_bl, p_D, labels = "auto")
P1
ggsave("figures_pdf/SI_Figure_4_visualization_between_within_effects_ADNI.pdf", width = 8, height = 4, units = "in")

```





## SI Fig. S10. Consistency and forest plots

```{r, fig.width = 14, fig.height=5}
library(gridExtra)
library(grid)
# PART A: Long RESI
## GUSTO
rv = readRDS("Results/consistency_CS_RESI/GMV_resamp_GUSTO.rds")
# long resi for age
p1 = ggplot(data = rv$diff_long_RESI_age, aes(x = N, y = mean)) +
        geom_ribbon(aes(ymin = CI_95_low, ymax = CI_95_high), fill="grey", alpha=0.7) + 
        geom_line(size = 1, color = "blue") + 
        geom_hline(yintercept = 0, linetype = 2) +
        labs(title = "L-RESI for age", x = "N", y = "Difference") + theme_classic()
range_1 = ggplot_build(p1)$layout$panel_params[[1]]$y.range
# Long RESI for sex
p2 = ggplot(data = rv$diff_long_RESI_sex, aes(x = N, y = mean)) +
        geom_ribbon(aes(ymin = CI_95_low, ymax = CI_95_high), fill="grey", alpha=0.7) + 
        geom_line(size = 1, color = "blue") + 
        geom_hline(yintercept = 0, linetype = 2) +
        labs(title = "L-RESI for sex", x = "N", y = "Difference") + theme_classic()
range_2 = ggplot_build(p2)$layout$panel_params[[1]]$y.range
# Long Cohen's d for sex
p3 = ggplot(data = rv$diff_d_sex, aes(x = N, y = mean)) +
          geom_ribbon(aes(ymin = CI_95_low, ymax = CI_95_high), fill="grey", alpha=0.7) + 
          geom_line(size = 1, color = "blue") + 
          geom_hline(yintercept = 0, linetype = 2) +
          labs(title = "Cohen's d for sex", x = "N", y = "Difference") + theme_classic() 
range_3 = ggplot_build(p3)$layout$panel_params[[1]]$y.range

ranges = c(range_1, range_2, range_3)

# long resi for age
p1 = ggplot(data = rv$diff_long_RESI_age, aes(x = N, y = mean)) +
        geom_ribbon(aes(ymin = CI_95_low, ymax = CI_95_high), fill="grey", alpha=0.7) + 
        geom_line(size = 1, color = "blue") + 
        geom_hline(yintercept = 0, linetype = 2) +
        labs(title = "L-RESI for age", x = "N", y = "Difference") + theme_classic() + ylim(min(ranges), max(ranges))
# Long RESI for sex
p2 = ggplot(data = rv$diff_long_RESI_sex, aes(x = N, y = mean)) +
        geom_ribbon(aes(ymin = CI_95_low, ymax = CI_95_high), fill="grey", alpha=0.7) + 
        geom_line(size = 1, color = "blue") + 
        geom_hline(yintercept = 0, linetype = 2) +
        labs(title = "L-RESI for sex", x = "N", y = "Difference") + theme_classic() + ylim(min(ranges), max(c(range_2, range_3)))
# Long Cohen's d for sex
p3 = ggplot(data = rv$diff_d_sex, aes(x = N, y = mean)) +
          geom_ribbon(aes(ymin = CI_95_low, ymax = CI_95_high), fill="grey", alpha=0.7) + 
          geom_line(size = 1, color = "blue") + 
          geom_hline(yintercept = 0, linetype = 2) +
          labs(title = "Cohen's d for sex", x = "N", y = "Difference") + theme_classic() + ylim(min(ranges), max(c(range_2, range_3)))


## ADNI
rv = readRDS("Results/consistency_CS_RESI/GMV_resamp_ADNI.rds")
# long resi for age
p4 = ggplot(data = rv$diff_long_RESI_age, aes(x = N, y = mean)) +
        geom_ribbon(aes(ymin = CI_95_low, ymax = CI_95_high), fill="grey", alpha=0.7) + 
        geom_line(size = 1, color = "blue") + 
        geom_hline(yintercept = 0, linetype = 2) +
        labs(title = "L-RESI for age", x = "N", y = "Difference") + theme_classic()
range_1 = ggplot_build(p4)$layout$panel_params[[1]]$y.range
# Long RESI for sex
p5 = ggplot(data = rv$diff_long_RESI_sex, aes(x = N, y = mean)) +
        geom_ribbon(aes(ymin = CI_95_low, ymax = CI_95_high), fill="grey", alpha=0.7) + 
        geom_line(size = 1, color = "blue") + 
        geom_hline(yintercept = 0, linetype = 2) +
        labs(title = "L-RESI for sex", x = "N", y = "Difference") + theme_classic()
range_2 = ggplot_build(p5)$layout$panel_params[[1]]$y.range
# Long Cohen's d for sex
p6 = ggplot(data = rv$diff_d_sex, aes(x = N, y = mean)) +
          geom_ribbon(aes(ymin = CI_95_low, ymax = CI_95_high), fill="grey", alpha=0.7) + 
          geom_line(size = 1, color = "blue") + 
          geom_hline(yintercept = 0, linetype = 2) +
          labs(title = "Cohen's d for sex", x = "N", y = "Difference") + theme_classic() 
range_3 = ggplot_build(p6)$layout$panel_params[[1]]$y.range

ranges = c(range_1, range_2, range_3)

# long resi for age
p4 = ggplot(data = rv$diff_long_RESI_age, aes(x = N, y = mean)) +
        geom_ribbon(aes(ymin = CI_95_low, ymax = CI_95_high), fill="grey", alpha=0.7) + 
        geom_line(size = 1, color = "blue") + 
        geom_hline(yintercept = 0, linetype = 2) +
        labs(title = "L-RESI for age", x = "N", y = "Difference") + theme_classic() + ylim(min(ranges), max(ranges))
# Long RESI for sex
p5 = ggplot(data = rv$diff_long_RESI_sex, aes(x = N, y = mean)) +
        geom_ribbon(aes(ymin = CI_95_low, ymax = CI_95_high), fill="grey", alpha=0.7) + 
        geom_line(size = 1, color = "blue") + 
        geom_hline(yintercept = 0, linetype = 2) +
        labs(title = "L-RESI for sex", x = "N", y = "Difference") + theme_classic() + ylim(min(ranges), max(c(range_2, range_3)))
# Long Cohen's d for sex
p6 = ggplot(data = rv$diff_d_sex, aes(x = N, y = mean)) +
          geom_ribbon(aes(ymin = CI_95_low, ymax = CI_95_high), fill="grey", alpha=0.7) + 
          geom_line(size = 1, color = "blue") + 
          geom_hline(yintercept = 0, linetype = 2) +
          labs(title = "Cohen's d for sex", x = "N", y = "Difference") + theme_classic() + ylim(min(ranges), max(c(range_2, range_3)))

R1 = plot_grid(p1, p2, p3, nrow = 1)
R2 = plot_grid(p4, p5, p6, nrow = 1)
R1 = annotate_figure(R1, left = grid::textGrob("Study: GUSTO", rot = 90, vjust = 0.3, gp = gpar(cex = 1))) 
R2 = annotate_figure(R2, left = grid::textGrob("Study: ADNI", rot = 90, vjust = 0.3, gp = gpar(cex = 1))) 

PART_A =plot_grid(R1, R2,
               labels = "a",
               nrow = 2) 



# PART B
# PART A: Long RESI
## GUSTO
rv = readRDS("Results/consistency_CS_RESI/GMV_resamp_GUSTO.rds")
# CS resi for age
p1 = ggplot(data = rv$diff_CS_RESI_age, aes(x = N, y = mean)) +
        geom_ribbon(aes(ymin = CI_95_low, ymax = CI_95_high), fill="grey", alpha=0.7) + 
        geom_line(size = 1, color = "blue") + 
        geom_hline(yintercept = 0, linetype = 2) +
        labs(title = "CS-RESI for age", x = "N", y = "Difference") + theme_classic()
# CS RESI for sex
p2 = ggplot(data = rv$diff_CS_RESI_sex, aes(x = N, y = mean)) +
        geom_ribbon(aes(ymin = CI_95_low, ymax = CI_95_high), fill="grey", alpha=0.7) + 
        geom_line(size = 1, color = "blue") + 
        geom_hline(yintercept = 0, linetype = 2) +
        labs(title = "CS-RESI for sex", x = "N", y = "Difference") + theme_classic()

## ADNI
rv = readRDS("Results/consistency_CS_RESI/GMV_resamp_ADNI.rds")
# CS resi for age
p3 = ggplot(data = rv$diff_CS_RESI_age, aes(x = N, y = mean)) +
        geom_ribbon(aes(ymin = CI_95_low, ymax = CI_95_high), fill="grey", alpha=0.7) + 
        geom_line(size = 1, color = "blue") + 
        geom_hline(yintercept = 0, linetype = 2) +
        labs(title = "CS-RESI for age", x = "N", y = "Difference") + theme_classic()

# CS RESI for sex
p4 = ggplot(data = rv$diff_CS_RESI_sex, aes(x = N, y = mean)) +
        geom_ribbon(aes(ymin = CI_95_low, ymax = CI_95_high), fill="grey", alpha=0.7) + 
        geom_line(size = 1, color = "blue") + 
        geom_hline(yintercept = 0, linetype = 2) +
        labs(title = "CS-RESI for sex", x = "N", y = "Difference") + theme_classic()


R1 = plot_grid(p1, p2, nrow = 1)
R2 = plot_grid(p3, p4, nrow = 1)
R1 = annotate_figure(R1, left = grid::textGrob(" ", rot = 90, vjust = 0.3, gp = gpar(cex = 1))) 
R2 = annotate_figure(R2, left = grid::textGrob(" ", rot = 90, vjust = 0.3, gp = gpar(cex = 1))) 


PART_B =plot_grid(R1, R2,
               labels = "b",
               nrow = 2) 

grid.arrange(
  PART_A, PART_B, 
  layout_matrix = rbind(c(1, 2),
                        c(1, 2)
                        ),
  heights = c(1.1, 1.1),
  widths = c(3, 2)
) %>% suppressWarnings()

```



```{r, fig.height=12, fig.width=10}
library(effectsize)
study_info = readr::read_csv("data/analysis_data/whole_brain_measure/new/study_info_whole_brain.csv")
study_info %<>% arrange(Design, m2_age)
study_info$index_sd_age = 1:nrow(study_info)

analysis_data = readr::read_csv("data/analysis_data/whole_brain_measure/new/analysis_data_whole_brain_combat.csv")
analysis_data$study %<>% factor(levels = study_info$study)

# P1: forest plot of age effect on GMV
RESI_GMV <- forest_plot(study_info = study_info, analysis_data = analysis_data, outcome = "GMV", x_ul = 2)
p1 = RESI_GMV$plot_age + labs(title = "Age effects on total GMV") 

# RESI_sGMV <- forest_plot(study_info = study_info, analysis_data = analysis_data,outcome = "sGMV", x_ul = 2)
# p2 = RESI_sGMV$plot_age + labs(title = "", y = "") 
# 
# RESI_WMV <- forest_plot(study_info = study_info, analysis_data = analysis_data, outcome = "WMV", x_ul = 2)
# p3 = RESI_WMV$plot_age + labs(title = "", y = "") 

# P4: age distribution
p4 = RESI_GMV$age_dist + labs(title = "Age distribution", y = "") # + theme_classic() 

legend <- get_legend(p4)

p4 = p4 + theme(legend.position = c(0.71, 0.05)) # + theme(legend.position="none")

P1 = plot_grid(p1, p4, labels = c("c", "d"), nrow = 1, hjust = -0.3) %>% suppressWarnings()

# P1
#---------------------------------------------------
P_consist = plot_grid(PART_A, PART_B, nrow = 1, rel_widths = c(3, 2))

P = plot_grid(P_consist, P1, rel_heights = c(1, 2), ncol = 1)

grid.arrange(
  PART_A, PART_B, P1,
  layout_matrix = rbind(c(1, 2),
                        c(1, 2),
                        c(3, 3)
                        ),
  heights = c(1.1, 1.1, 5),
  widths = c(3, 2)
) %>% suppressWarnings()

ggsave("figures_pdf/SI_Figure_10_consistentcy_and_forest_plot.pdf", width = 12, height = 13, units = "in")

```

## SI Fig. S11. Consistency of CS RESI
```{r}

plot_consist = function(study_name){
  
  rv = readRDS(paste0("Results/consistency_CS_RESI/GMV_resamp_", study_name, ".rds"))

  
  # for age effect
  p1 = ggplot(data = rv$diff_CS_RESI_age, aes(x = N, y = mean)) +
          geom_ribbon(aes(ymin = CI_95_low, ymax = CI_95_high), fill="grey", alpha=0.7) + 
          geom_line(color = "blue") + 
          # geom_ribbon(aes(ymin = range_low, ymax = range_high), fill="blue", alpha=0.1) +
          # geom_line(aes(y = CI_95_low), linetype = 3) + geom_line(aes(y = CI_95_high), linetype = 3) + 
          geom_hline(yintercept = 0, linetype = 2) +
          labs(title = "CS-RESI for age", x = "N", y = "Difference") + theme_classic()
  range_1 = ggplot_build(p1)$layout$panel_params[[1]]$y.range
  # Long RESI in long and RESI in cs
  p2 = ggplot(data = rv$diff_long_RESI_age, aes(x = N, y = mean)) +
          geom_ribbon(aes(ymin = CI_95_low, ymax = CI_95_high), fill="grey", alpha=0.7) + 
          geom_line(color = "blue") + 
          # geom_ribbon(aes(ymin = range_low, ymax = range_high), fill="blue", alpha=0.1) +
          # geom_line(aes(y = CI_95_low), linetype = 3) + geom_line(aes(y = CI_95_high), linetype = 3) + 
          geom_hline(yintercept = 0, linetype = 2) +
          labs(title = "L-RESI for age", x = "N", y = "Difference") + theme_classic()
  range_2 = ggplot_build(p2)$layout$panel_params[[1]]$y.range

  p1 = ggplot(data = rv$diff_CS_RESI_age, aes(x = N, y = mean)) +
        geom_ribbon(aes(ymin = CI_95_low, ymax = CI_95_high), fill="grey", alpha=0.7) + 
          geom_line(color = "blue") + 
          geom_hline(yintercept = 0, linetype = 2) +
          labs(title = "CS-RESI for age", x = "N", y = "Difference") + theme_classic() + ylim(min(c(range_1, range_2)), max(c(range_1, range_2)))
  p2 = ggplot(data = rv$diff_long_RESI_age, aes(x = N, y = mean)) +
          geom_ribbon(aes(ymin = CI_95_low, ymax = CI_95_high), fill="grey", alpha=0.7) + 
          geom_line(color = "blue") + 
          geom_hline(yintercept = 0, linetype = 2) +
          labs(title = "L-RESI for age", x = "N", y = "Difference") + theme_classic() + ylim(min(c(range_1, range_2)), max(c(range_1, range_2)))


  # for sex effect
  # difference between CS-RESI in long and RESI in CS
  p5 = ggplot(data = rv$diff_CS_RESI_sex, aes(x = N, y = mean)) +
          geom_ribbon(aes(ymin = CI_95_low, ymax = CI_95_high), fill="grey", alpha=0.7) + 
          geom_line(color = "blue") + 
          geom_hline(yintercept = 0, linetype = 2) +
          labs(title = "CS-RESI for sex", x = "N", y = "Difference") + theme_classic() 
  range_1 = ggplot_build(p5)$layout$panel_params[[1]]$y.range
  # diff between unadjusted RESi in long and CS for sex
  p6 = ggplot(data = rv$diff_long_RESI_sex, aes(x = N, y = mean)) +
          geom_ribbon(aes(ymin = CI_95_low, ymax = CI_95_high), fill="grey", alpha=0.7) + 
          geom_line(color = "blue") + 
          geom_hline(yintercept = 0, linetype = 2) +
          labs(title = "L-RESI for sex", x = "N", y = "Difference") + theme_classic() 
  range_2 = ggplot_build(p6)$layout$panel_params[[1]]$y.range
  # diff between Cohen's d in long and CS
  p7 = ggplot(data = rv$diff_d_sex, aes(x = N, y = mean)) +
    geom_ribbon(aes(ymin = CI_95_low, ymax = CI_95_high), fill="grey", alpha=0.7) + 
          geom_line(color = "blue") + 
          geom_hline(yintercept = 0, linetype = 2) +
          labs(title = "Cohen's d for sex", x = "N", y = "Difference") + theme_classic() 
  range_3 = ggplot_build(p7)$layout$panel_params[[1]]$y.range

  ranges = c(range_1, range_2, range_3)
  # difference between CS-RESI in long and RESI in CS
  p5 = ggplot(data = rv$diff_CS_RESI_sex, aes(x = N, y = mean)) +
          geom_ribbon(aes(ymin = CI_95_low, ymax = CI_95_high), fill="grey", alpha=0.7) + 
          geom_line(color = "blue") + 
          geom_hline(yintercept = 0, linetype = 2) +
          labs(title = "CS-RESI for sex", x = "N", y = "Difference") + theme_classic()  + ylim(min(ranges), max(ranges))
   # diff between unadjusted RESi in long and CS for sex
  p6 = ggplot(data = rv$diff_long_RESI_sex, aes(x = N, y = mean)) +
          geom_ribbon(aes(ymin = CI_95_low, ymax = CI_95_high), fill="grey", alpha=0.7) + 
          geom_line(color = "blue") + 
          geom_hline(yintercept = 0, linetype = 2) +
          labs(title = "L-RESI for sex", x = "N", y = "Difference") + theme_classic() + ylim(min(ranges), max(ranges))
  # diff between Cohen's d in long and CS
  p7 = ggplot(data = rv$diff_d_sex, aes(x = N, y = mean)) +
    geom_ribbon(aes(ymin = CI_95_low, ymax = CI_95_high), fill="grey", alpha=0.7) + 
          geom_line(color = "blue") + 
          geom_hline(yintercept = 0, linetype = 2) +
          labs(title = "Cohen's d for sex", x = "N", y = "Difference") + theme_classic() + ylim(min(ranges), max(ranges))

  plot = ggarrange(p1, p2, p5, p6, p7, nrow = 1)
  plot_out = annotate_figure(plot, left = grid::textGrob(paste("Study:", study_name), rot = 90, vjust = 0.3, gp = gpar(cex = 1))) 
  return(plot_out)
}
```


```{r, fig.width=25, fig.height=17}
p = list()
studies = subset(study_info, Design == "Longitudinal" )$study
# studies = studies[! studies %in% c("ADNI", "GUSTO")]
for (i in 1:length(studies)){
  study_name = studies[i]
  p[[i]] = plot_consist(study_name) %>% suppressWarnings()
}
margin = theme(plot.margin = unit(c(0,0,0,1), "cm"))
P = do.call(grid.arrange, c(lapply(p, "+", margin), ncol = 2)) 

ggsave("figures_pdf/SI_Figure_11_consistentcy_of_CS_RESI.pdf", plot = P, width = 24, height = 16, units = "in")

```




## SI Fig. S12. Forest plots of the age effects on sGMV, WMV and mean CT
```{r, fig.height=10, fig.width=10}
study_info = readr::read_csv("data/analysis_data/whole_brain_measure/new/study_info_whole_brain.csv")
study_info %<>% arrange(Design, m2_age)
study_info$index_sd_age = 1:nrow(study_info)

analysis_data = readr::read_csv("data/analysis_data/whole_brain_measure/new/analysis_data_whole_brain_combat.csv")
analysis_data$study %<>% factor(levels = study_info$study)

# P1: forest plot of age effect on sGMV

RESI_sGMV <- forest_plot(study_info = study_info, analysis_data = analysis_data, outcome = "sGMV", x_ul = 2)
p1 = RESI_sGMV$plot_age + labs(title = "Age effects on total sGMV")

# P2: forest plot - WMV
RESI_WMV <- forest_plot(study_info = study_info, analysis_data = analysis_data, outcome = "WMV", x_ul = 2)
p2 = RESI_WMV$plot_age + labs(title = "Age effects on total WMV", y = "")

# P3: mean CT
study_info_CT = study_info_CT = read_csv("data/analysis_data/whole_brain_measure/new/CT/study_info_clean_global_CT.csv")
study_info_CT %<>% arrange(Design, m2_age)
study_info_CT$index_sd_age = 1:nrow(study_info_CT)

analysis_data_CT <- read_csv("data/analysis_data/whole_brain_measure/new/CT/analysis_data_global_CT_combat.csv")
analysis_data_CT %<>% as.data.frame 
analysis_data_CT$study %<>% factor(levels = study_info_CT$study)

RESI_CT = forest_plot(study_info = study_info_CT, analysis_data = analysis_data_CT, outcome = "CT", x_ul = 2)
p3 = RESI_CT$plot_age + labs(title = "Age effects on mean CT", y = "")

Fig_S12 <- plot_grid(p1, p2, p3, labels = c("a", "b", "c"), nrow = 1) %>% suppressWarnings()
Fig_S12

ggsave("figures_pdf/SI_Figure_12_forest_plot_age_2.pdf", plot = Fig_S12, width = 11, height = 10, units = "in")

```



## SI Fig. S13. Forest plots of the sex effects on GMV, sGMV, WMV and mean CT
```{r, fig.height=10, fig.width=13}
study_info = readr::read_csv("data/analysis_data/whole_brain_measure/new/study_info_whole_brain.csv")
# Order the study by study design & SD of age
study_info %<>% arrange(Design, m2_age)
study_info$index_sd_age = 1:nrow(study_info)

analysis_data = readr::read_csv("data/analysis_data/whole_brain_measure/new/analysis_data_whole_brain_combat.csv")
analysis_data$study %<>% factor(levels = study_info$study)

RESI_GMV <- forest_plot(study_info = study_info, analysis_data = analysis_data, outcome = "GMV", x_ul = 1.5)
p1 = RESI_GMV$plot_sex + labs(title = "Sex effects on total GMV") 

RESI_sGMV <- forest_plot(study_info = study_info, analysis_data = analysis_data, outcome = "sGMV", x_ul = 1.5)
p2 = RESI_sGMV$plot_sex + labs(title = "Sex effects on total sGMV", y = "") 

RESI_WMV <- forest_plot(study_info = study_info, analysis_data = analysis_data, outcome = "WMV", x_ul = 1.5)
p3 = RESI_WMV$plot_sex + labs(title = "Sex effects on total WMV", y = "") 

study_info_CT = study_info_CT = read_csv("data/analysis_data/whole_brain_measure/new/CT/study_info_clean_global_CT.csv")
study_info_CT %<>% arrange(Design, m2_age)
study_info_CT$index_sd_age = 1:nrow(study_info_CT)

analysis_data_CT <- read_csv("data/analysis_data/whole_brain_measure/new/CT/analysis_data_global_CT_combat.csv")
analysis_data_CT %<>% as.data.frame 
analysis_data_CT$study %<>% factor(levels = study_info_CT$study)

RESI_CT = forest_plot(study_info = study_info_CT, analysis_data = analysis_data_CT, outcome = "CT", x_ul = 1.5)
p4 = RESI_CT$plot_sex + labs(title = "Sex effects on mean CT", y = "")

Fig_S13 = plot_grid(p1, p2, p3, p4,  labels = "auto", nrow = 1, hjust = -2) %>% suppressWarnings()
Fig_S13
ggsave("figures_pdf/SI_Figure_13_forest_plot_sex.pdf", plot = Fig_S13, width = 14, height = 10, units = "in")

```


## SI Fig. S14. The expected ESs suggested by statistical theory
```{r, fig.width=8, fig.height = 3}
# theoretical curves of effect sizes ----------

# The equation of expected effect size (RESI)
S_fun = function(m = 2, rho, beta_c, beta_l, sigma2_b, sigma2_w, sigma2_y){
  
  # inv_Var =  (m * (1 + (m-1)*rho ) * sigma2_w + (1-rho) * sigma2_b ) / (sigma2_y * (1 + (m-1)*rho)*(1-rho) ) 
  Var = sigma2_y * (1-rho) / m * (1 + (m-1)*rho) / (sigma2_w * (1 + (m-1)*rho ) + sigma2_b * (1-rho))
    
  E_beta_hat = beta_l + (beta_c - beta_l) * sigma2_b * (1-rho) / ( (1 + (m-1)*rho)*sigma2_w + (1-rho)*sigma2_b ) 
  
  # S = beta_l * sqrt(m) * sqrt( ((1 + (m-1) * rho) * sigma2_w + (1-rho) * sigma2_b) / (sigma2_y * (1 + (m - 1) * rho) * (1-rho) ) ) +
  #   (beta_c - beta_l) * sigma2_b / sqrt(sigma2_y * (1 + (m-1)*rho )) * sqrt( (m*(1-rho)) / ( (1+(m-1)*rho)*sigma2_w + (1-rho)*sigma2_b ) )
  S = E_beta_hat / sqrt(Var)
  
  return(S)
}

# --------------
beta_vals = c(-0.1, 0, 0.1, 0.3)
# a. over between-subject variance 
plot_data = expand.grid(sigma2_b = seq(1, 300, by = 10), sigma2_w = c(20, 50, 100), beta_c = beta_vals, beta_l = beta_vals )
plot_data$S = S_fun(m = 2, rho = 0.6, beta_c = plot_data$beta_c, beta_l = plot_data$beta_l, 
                    sigma2_b = plot_data$sigma2_b, sigma2_w = plot_data$sigma2_w, 
                    sigma2_y = 30) %>% abs()

plot_data$sigma2_w %<>% factor()
# plot_data$beta_c %<>% factor()
# plot_data$beta_l %<>% factor()
plot_data$beta_c_lab = paste0("beta[b] == ", plot_data$beta_c) %>% factor(levels = paste0("beta[b] == ", beta_vals))
plot_data$beta_l_lab = paste0("beta[w] == ", plot_data$beta_l) %>% factor(levels = paste0("beta[w] == ", beta_vals))

p1 = ggplot(plot_data, aes(x = sigma2_b, y = S)) +
  theme_bw() + geom_line(linewidth = 1, aes(col = sigma2_w, linetype = sigma2_w)) +
  facet_grid(beta_l_lab ~ beta_c_lab, label = "label_parsed") + 
  labs(title = "Benefit of increasing between-subject variability", y = "Absolute expected RESI", x = "Between-subject variance", linetype = expression(sigma[w]^2), col = expression(sigma[w]^2)) + 
  geom_rect(data = subset(plot_data, beta_l %in% c(0, 0.1, 0.3) & beta_c >= beta_l), 
            fill = NA, color = "#F0E442", xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf, linewidth = 1.5)


# b. over within-subject variance
plot_data = expand.grid(sigma2_w = seq(1, 300, by = 10), sigma2_b = c(20, 50, 100), beta_c = beta_vals, beta_l = beta_vals )
plot_data$S = S_fun(m = 2, rho = 0.6, beta_c = plot_data$beta_c, beta_l = plot_data$beta_l, 
                    sigma2_b = plot_data$sigma2_b, sigma2_w = plot_data$sigma2_w, 
                    sigma2_y = 30) %>% abs()

plot_data$sigma2_b %<>% factor()
# plot_data$beta_c %<>% factor()
# plot_data$beta_l %<>% factor()
plot_data$beta_c_lab = paste0("beta[b] == ", plot_data$beta_c) %>% factor(levels = paste0("beta[b] == ", beta_vals))
plot_data$beta_l_lab = paste0("beta[w] == ", plot_data$beta_l) %>% factor(levels = paste0("beta[w] == ", beta_vals))

p2 = ggplot(plot_data, aes(x = sigma2_w, y = S)) + 
  theme_bw() + geom_line(linewidth = 1, aes(col = sigma2_b, linetype = sigma2_b)) + 
  facet_grid(beta_l_lab ~ beta_c_lab, label = "label_parsed") + 
  labs(title = "Benefit of increasing within-subject variability", y = "Absolute expected RESI", x = "Within-subject variance", 
       linetype = expression(sigma[b]^2), col = expression(sigma[b]^2)) + 
  geom_rect(data = subset(plot_data, beta_c %in% c(0, 0.1, 0.3) & beta_c <= beta_l), 
            fill = NA, color = "#F0E442", xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf, linewidth = 1.5)

P1 = plot_grid(p1, p2, labels = c("a", "b"), nrow = 1)
P1

ggsave("figures_pdf/SI_Figure_S14_statistical_theoretical_curve.pdf", plot = P1, width = 13, height = 6, units = "in")

```

